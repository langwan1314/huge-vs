function videoStream(e,t,o,n,i,a,s,r,l){this.domVideo=null,this.domID=e,this.parent=t,this.planeVideo=null,this.videoMat=null,this.stream=null,this.size=1,this.distance=o,this.camera=n,this.useSceneBackground=s,this.facingMode="environment",this.idealWidth=r,this.idealHeight=l,this.streamW=0,this.streamH=0,this.videoTex=null,this.isReady=!1,this.callBackSuccess=i,this.callBackFail=a,this.timerStreamResized=null,this.parentCanvasBlit=null,this.ctxBlit=null,this.getStreamFromIframe=!1,this.getStream=function(e,t){var o=this;o.domVideo=document.getElementById(o.domID),o.domVideo||console.log("ERROR : no video id "+o.domID+" found");var n=o.domVideo;n.autoplay=!0,n.playsInline=!0,n.muted=!0,n.style.zIndex="-1",function(e,t,n){addToLog("get stream 2");var i={audio:!1,video:{facingMode:{exact:e}}};_browser.desktop||o.idealWidth&&o.idealHeight&&(i.video.width={min:640,ideal:o.idealWidth,max:1280},i.video.height={min:480,ideal:o.idealHeight,max:720});if(_browser.desktop){i={};var a=navigator.mediaDevices.getSupportedConstraints(),s=!0;a.facingMode&&(s={width:{ideal:o.idealWidth},height:{ideal:o.idealHeight},facingMode:{ideal:e}}),i.video=s,a.audio&&(i.audio=!1)}var r=function(e){addToLog("== video ok"),console.log("-> videostream: fail"),console.log(e),n.call(this,e)};_browser.insideIframe;addToLog("+ + get stream parent "+o.getStreamFromIframe),o.getStreamFromIframe?(window.addEventListener("message",(function(e){if("camera"==e.data.failed)return console.log("got a camera fail+"),void r({name:e.data.error});e.data.stream&&(null==o.stream?(addToLog("got feed from parent"),n=e.data.w,i=e.data.h,addToLog("-> got stream from parent "+n+"x"+i),o.stream=!0,o.domVideo={videoWidth:n,videoHeight:i},o.parentCanvasBlit=document.createElement("canvas"),o.parentCanvasBlit.width=512,o.parentCanvasBlit.height=512,o.ctxBlit=o.parentCanvasBlit.getContext("2d"),o.gotStream(t,!0)):(o.ctxBlit.drawImage(e.data.image[0],0,0,512,512),o.videoTex.needsUpdate=!0));var n,i;if(e.data.deviceOrientation){var a=_xr.controls,s=a.deviceOrientation;s&&(a.deviceOrientation=e.data.deviceOrientation,s.alpha=e.data.deviceOrientation.alpha,s.beta=e.data.deviceOrientation.beta,s.gamma=e.data.deviceOrientation.gamma),a.enabled=!0}}),!1),_xr.common.postMessage({request:"camera",version:_browser.version,browserName:_browser.name,constraints:i})):navigator.mediaDevices.getUserMedia(i).then((function(e){addToLog("== video fail"),_config.isDebug&&console.log("-> getUserMedia: ok");var i=o.domVideo;i.srcObject=e,o.stream=e,i.play().then((function(){i.paused&&(console.log("video stream is paused"),"samsungbrowser"==_browser.name)?n.call(this,err):o.gotStream(t,!1)})).catch((function(e){console.log("-> mediaControl play: fail"),console.log(e),n.call(this,e)}))})).catch(r)}(o.facingMode,e,t),window.addEventListener("beforeunload",(function(e){o.pause()}))},this.swapCamera=function(){var e=this;e.getStreamFromIframe||e.stream.getTracks()[0].stop();"environment"==e.facingMode?e.facingMode="user":e.facingMode="environment",e.getStream(e.callBackSuccess,e.callBackFail)},this.gotStream=function(e,t){var o=this;if(t)return o.streamW=o.domVideo.videoWidth,o.streamH=o.domVideo.videoHeight,o.videoTex=new THREE.CanvasTexture(o.parentCanvasBlit),o.videoTex.offset.set(0,0),o.videoTex.center.set(.5,.5),o.camera.parent.background=o.videoTex,o.isReady=!0,void e.call(this);if(o.streamW=o.domVideo.videoWidth,o.streamH=o.domVideo.videoHeight,o.videoTex=new THREE.VideoTexture(o.domVideo),o.useSceneBackground){o.videoTex.offset.set(0,0),o.videoTex.center.set(.5,.5),o.camera.parent.background=o.videoTex}else{o.videoMat=new THREE.MeshBasicMaterial({map:o.videoTex});var n=new THREE.PlaneGeometry(1,1);o.planeVideo=new THREE.Mesh(n,o.videoMat),o.planeVideo.name="planeVideo",o.parent.add(o.planeVideo),o.planeVideo.position.set(0,0,-1*o.distance),o.fitToScreen(),o.timerStreamResized=setInterval((function(){o.checkSizes(o)}),500)}o.isReady=!0,e.call(this)},this.pause=function(){var e=this;if(e.isReady&&e.stream.getTracks()[0].enabled){addToLog("pause stream"),e.timerStreamResized&&clearInterval(e.timerStreamResized);try{e.stream.getTracks()[0].enabled=!1}catch(e){addTolog("error : pause stream")}}},this.stop=function(){var e=this;console.log("video stream STOP + WILL send message +++ "+e.getStreamFromIframe),e.getStreamFromIframe&&_xr.common.postMessage({request:"stopCamera",version:_browser.version,browserName:_browser.name}),e.stream.getTracks().forEach((function(e){e.stop()}))},this.resume=function(e,t,o){var n=this;if(n.isReady&&!n.stream.getTracks()[0].enabled){if(addToLog("resume stream"),n.useSceneBackground)n.camera.parent.background=n.videoTex;else e&&addToLog("update parent"),t&&addToLog("update camera"),e&&(n.parent=e),t&&(n.camera=t),n.parent.add(n.planeVideo),o&&(addToLog("update distance "+o),n.distance=o,n.planeVideo.position.set(0,0,-1*n.distance));try{n.stream.getTracks()[0].enabled=!0}catch(e){addTolog("error : resume stream")}n.useSceneBackground||(n.timerStreamResized=setInterval((function(){n.checkSizes(n)}),500))}},this.fitToScreen=function(){var e=this;e.camera.aspect||console.log("videostream: something wrong with camera aspect..");var t=THREE.Math.degToRad(e.camera.fov),o=2*Math.tan(t/2)*e.distance,n=o*e.camera.aspect;o>n&&(n=o),n*=1.01;var i=e.domVideo.videoWidth/e.domVideo.videoHeight,a=n,s=n/i;i>=e.camera.aspect&&(s=n,a=n*i),e.planeVideo.scale.set(a,s,1)},this.checkSizes=function(e){e.streamW!=e.domVideo.videoWidth&&(e.streamW=e.domVideo.videoWidth,e.streamH=e.domVideo.videoHeight,e.domVideo.width=e.streamW,e.domVideo.height=e.streamH),e.fitToScreen()},this.getStream(i,a)}function setText(e,t){var o;for(o=0;o<document.querySelectorAll("[data-text='"+e+"']").length;o++)document.querySelectorAll("[data-text='"+e+"']")[o].textContent=t}THREE.DeviceOrientationControls=function(e){var t=this;this.object=e,this.object.rotation.reorder("YXZ"),this.enabled=!0,this.deviceOrientation={},this.screenOrientation=0,this.alphaOffset=0;var o,n,i,a,s=function(e){t.deviceOrientation=e},r=function(){t.screenOrientation=window.orientation||0},l=(o=new THREE.Vector3(0,0,1),n=new THREE.Euler,i=new THREE.Quaternion,a=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),function(e,t,s,r,l){n.set(s,t,-r,"YXZ"),e.setFromEuler(n),e.multiply(a),e.multiply(i.setFromAxisAngle(o,-l))});this.connect=function(){r(),window.addEventListener("orientationchange",r,!1),window.addEventListener("deviceorientation",s,!1),t.enabled=!0},this.disconnect=function(){window.removeEventListener("orientationchange",r,!1),window.removeEventListener("deviceorientation",s,!1),t.enabled=!1},this.update=function(){if(!1!==t.enabled){var e=t.deviceOrientation;if(e){var o=e.alpha?THREE.Math.degToRad(e.alpha)+t.alphaOffset:0,n=e.beta?THREE.Math.degToRad(e.beta):0,i=e.gamma?THREE.Math.degToRad(e.gamma):0,a=t.screenOrientation?THREE.Math.degToRad(t.screenOrientation):0;l(t.object.quaternion,o,n,i,a)}}},this.dispose=function(){t.disconnect()},this.connect()};var k,_texts={},la=_language.substring(0,2);for(k in"fr"==la&&(_texts={betterOnMobile:"Voici une experience en réalité augmentée pour mobiles",visitOnMobile:"Avec le navigateur internet de votre téléphone, visitez ",scanThisQrCode:"ou scannez ce code QR ",visitHomepage:"visiter la page d'accueil",continueAnyway:"Continuer sur cet écran",print:"Imprimer le marqueur R.A.",allowAccess:"Veuillez autoriser l'accès à la caméra",noAccess:"pas d'accès à la caméra",yesCamera:"L'accès à votre caméra est necéssaire",noCamera:"Il semble que votre appareil n'a pas de caméra connectée",tryAgain:"réessayer",displayThePattern:"afficher le marqueur R.A.",loadingTheMagic:"Chargement",direct:"Pointez la caméra vers ce motif",directMultiple:"Pointez la caméra vers ces motifs",onAnother:"Avec un autre téléphone ou un ordinateur, visitez "+_domainMin+"/p pour afficher le marqueur R.A.",visitThisLink:"Visitez ce lien avec le navigateur internet de votre téléphone \net dirigez la caméra ici.",flat:"à plat",vertical:"vertical",by:"par",start:"démarrer",discoverMoreOnTheHome:"Découvrez d'autres scènes sur la page d'accueil",discoverMore:"Découvrir d'autres scènes",joinTheCommunityTop:"Rejoignez la communauté webXR XR+",joinTheCommunity:"Rejoignez la communauté webXR XR+",joinNow:"Rejoindre la communauté",help:"aide",shareThePhotoByEmail:"Partager la photo via email",yourPhotoHasBeenSent:"La photo a été envoyée"}),"pl"==la&&(_texts={betterOnMobile:"Rozszerzona rzeczwistość jest lepsza na urządzeniach mobilnych",visitOnMobile:"Zeskanuj kod QR lub przejdź na poniższy adres używając telefonu",scanThisQrCode:"",visitHomepage:"Odwiedź stronę główną XR.+",continueAnyway:"kontynuuj mimo to",print:"Wydrukuj wzór AR",allowAccess:"Zezwól na dostęp do kamery",noAccess:"Brak dostępu do kamery",yesCamera:"Dostęp do kamery urządzenia jest niezbędny, jeśli chcesz doświadczyć rozszerzonej rzeczywistości",noCamera:"Przepraszamy, nie wykryto kamery. Podłącz kamerę i spróbuj ponownie.",tryAgain:"spróbuj ponownie",displayThePattern:"wyświetl wzór AR",loadingTheMagic:"Ładowanie",direct:"Skieruj kamerę na ten wzór",directMultiple:"Skieruj kamerę na ten wzór",onAnother:"Żeby wyświetlić wzór AR, odwiedź "+_domainMin+"/p na innym telefonie lub komputerze",visitThisLink:"Otwórz link w przeglądarce na telefonie \ni skieruj kamerę tutaj.",flat:"płaski",vertical:"pionowy",by:"by",start:"start",discoverMoreOnTheHome:"Odkryj więcej",discoverMore:"Odkryj więcej",joinTheCommunityTop:"Dołącz do społeczności i dodaj swoje modele 3D!",joinTheCommunity:"Dołącz do społeczności i dodaj swoje modele",joinNow:"Dołącz teraz",help:"pomoc"}),"es"==la&&(_texts={betterOnMobile:"La Realidad Aumentada es mejor en móviles",visitOnMobile:"En el navegador web de tu móvil, visita ",scanThisQrCode:"",continueAnyway:"continuar de todas maneras",print:"Imprimir el patrón RA",allowAccess:"Por favor, permite acceder a la cámara",noAccess:"No hay acceso a la cámara",yesCamera:"Acceso a la cámara de tu dispositivo es requerido para las experiencias de Realidad Aumentada",noCamera:"Lo sentimos, pero parece ser que no cuentas con una cámara. Instala una cámara e intenta de nuevo",tryAgain:"Intentar de nuevo",displayThePattern:"Desplegar el patrón RA",loadingTheMagic:"Cargando",direct:"Dirige la cámara hacia este patrón",directMultiple:"Dirige la cámara hacia estos patrones",onAnother:"En otro móvil o en una computadora, visita "+_domainMin+"/p para desplegar el patrón de RA",visitThisLink:"Visita esta liga con el navegador de tu móvil y apunta la cámara aquí.",flat:"Plano",vertical:"Vertical",by:"by",start:"start",discoverMoreOnTheHome:"Decubre más en la página de inicio",discoverMore:"Descubre más",joinTheCommunityTop:"Únete a la comunidad y sube tus modelos 3D",joinTheCommunity:"Únete a la comunidad y sube tus modelos 3D",joinNow:"Únete a la comunidad",help:"Ayuda",shareThePhotoByEmail:"Comparte la foto por correo electrónico",yourPhotoHasBeenSent:"La foto ha sido enviada"}),"ru"==la&&(_texts={betterOnMobile:"Дополненная реальность лучше выглядит на телефоне",visitOnMobile:"Открой на телефоне: ",scanThisQrCode:"",continueAnyway:"все равно продолжить",print:"Распечатай пример AR",allowAccess:"Разреши доступ к камере",noAccess:"Камера недоступна",yesCamera:"Чтобы испытать дополнительную реальность нужен доступ к камере",noCamera:"К сожалению камера не найдена. Подключи камеру и попробуй снова",tryAgain:"попробуй снова",displayThePattern:"отобразить шаблон AR",loadingTheMagic:"Загрузка",direct:"Наведи камеру на шаблон",directMultiple:"Направь камеру на шаблон",onAnother:"Чтобы отобразить шаблон AR, открой "+_domainMin+"/p на другом телефоне или компьютере",visitThisLink:"Открой ссылку в браузере телефона \nи наведи камеру сюда.",flat:"горизонт.",vertical:"вертикал.",by:"by",start:"start",discoverMoreOnTheHome:"Еще больше на главной странице",discoverMore:"Открой больше",joinTheCommunityTop:"Присоединайся к сообществу и добавь свои 3D модели!",joinTheCommunity:"Присоединайся к сообществу и добавь свои модели",joinNow:"Присоединяйся уже сейчас",help:"Помощь"}),"ua"==la&&(_texts={betterOnMobile:"Доповнена реальність виглядає краще на телефоні",visitOnMobile:"Відкрий на телефоні: ",scanThisQrCode:"",continueAnyway:"все одно продовжити",print:"Роздрукуй шаблон AR",allowAccess:"Дозволь доступ до камери",noAccess:"Камера недоступна",yesCamera:"Щоб випробувати доповнену реальність необхідний доступ до камери",noCamera:"Нажаль камера не знайдена. Підключи камеру і спробуй знову",tryAgain:"спробуй знову",displayThePattern:"показати шаблон AR",loadingTheMagic:"Завантаження",direct:"Спрямуй камеру на цей шаблон.",directMultiple:"Спрямуй камеру на цей шаблон",onAnother:"Щоб відобразити шаблон, відвідай "+_domainMin+"/p на іншому телефоні або комп'ютері",visitThisLink:"Відкрий лінк в браузері телефону \nі спрямуй камеру сюди.",flat:"горизонт.",vertical:"вертикал.",by:"by",start:"start",discoverMoreOnTheHome:"Ще більше на головній сторінці",discoverMore:"Відкрий більше",joinTheCommunityTop:"Присоединяйся к сообществу и добавь свои 3D модели!",joinTheCommunity:"Присоединяйся к сообществу и добавь свои модели",joinNow:"Приєднуйся вже зараз",help:"Допомога"}),"undefined"!=typeof _pTexts&&_pTexts&&_pTexts.desktopScreen&&(_texts.betterOnMobile=_pTexts.desktopScreen.intro,_texts.visitOnMobile=_pTexts.desktopScreen.scan,_texts.scanThisQrCode="",_texts.continueAnyway=_pTexts.desktopScreen.bContinue),_texts)setText(k,_texts[k]);function getText(e){var t;for(t in _texts)if(e==t)return _texts[t];return null}var _clickOrTouch="ontouchend"in window?"touchend":"click";function jsonToString(e){return JSON.stringify(e)}function validateEmail(e){if(!e)return!1;var t=e.indexOf("@"),o=e.lastIndexOf(".");return!(t<1||o<t+2||o+2>=e.length)}function excerpt(e,t){return e.length>t&&(e=e.substr(0,e.lastIndexOf(" ",t))+"..."),e}function isUndefined(e){return void 0===e}function getAndroidVersion(e){var t=(e=(e||navigator.userAgent).toLowerCase()).match(/android\s([0-9\.]*)/);return!!t&&t[1]}function getChromeVersion(){var e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return!!e&&parseInt(e[2],10)}function cleanString(e){var t=document.createElement("div");t.innerHTML=e;var o=t.innerText;return t=null,o}function validateURL(e){return e=cleanString(e),!!/^(f|ht)tps?:\/\//i.test(e)&&(-1!=e.indexOf(".")&&!(e.split(".").pop().length<2))}function addToLog(e){if(_config.isDebug){console.log(e);var t=document.getElementById("mainLog");t&&(t.textContent=e+"\n"+t.textContent)}}function openModal(e,t,o,n,i,a={}){var s=null;"object"==typeof t&&null!==t?(s=(a=t).callbackYes,o=a.callbackNo):null!=t&&(console.log("OBS modal cbck"),s=t),void 0===a.buttons&&(a.buttons=!0),void 0===a.closeButton&&(a.closeButton=!1);var r=document.createElement("div");r.id="bgModal";var l=document.createElement("div");l.id="alertModal";var d=document.createElement("div");d.className="text",l.appendChild(d);var c,u=null,m=null,p=null,h=null;("object"==typeof e&&null!==e?(u=e.h2,m=e.p,p=e.image,h=e.video):(console.log("OBS: modal"),m=e),u&&""!=u)&&(u=(u=u.replace(/script/gi,"")).replace(/fromCharCode/gi,""),(c=document.createElement("h2")).innerText=u,d.appendChild(c),l.classList.add("h2"));if(p){var g;g=(g=(g=p.url).replace(/script/gi,"")).replace(/fromCharCode/gi,"");var v=document.createElement("img");if(p.width&&p.height){var f='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 '+1*p.width+" "+1*p.height+'"%3E%3C/svg%3E';v.src=f}var b=new Image;b.onload=function(){v&&(v.src=this.src)},b.src=g,d.appendChild(v)}h&&(g=(g=(g=h.url).replace(/script/gi,"")).replace(/fromCharCode/gi,""),(c=document.createElement("video")).src=g,c.autoplay=!0,c.controls=!0,d.appendChild(c));m&&""!=m&&(m=(m=m.replace(/script/gi,"")).replace(/fromCharCode/gi,""),(c=document.createElement("p")).innerText=m,"left"==a.textalign&&(c.style.textAlign="left"),d.appendChild(c),l.classList.add("p"));a.buttons&&((c=document.createElement("div")).className="buttons",l.appendChild(c));r.appendChild(l),document.body.appendChild(r);var y=function(){setTimeout((function(){var e=document.getElementById("bgModal");e&&e.parentElement.removeChild(e)}),300)},x=null;if(a.closeButton&&((x=document.createElement("div")).className="b_close",l.appendChild(x),$("#alertModal .b_close").on("click",(function(){y()}))),a.buttons){var w="";n&&(n=(n=n.replace(/script/gi,"")).replace(/fromCharCode/gi,"")),i&&(i=(i=i.replace(/script/gi,"")).replace(/fromCharCode/gi,"")),void 0===a.OKButton&&void 0===a.yesButton&&void 0===a.noButton&&(null!=n&&null!=i?(a.OKButton=!1,a.yesButton=n,a.noButton=i):(a.OKButton=n||"ok",a.yesButton=!1,a.noButton=!1)),a.yesButton&&a.noButton?(w+='<span class="button yes">'+a.yesButton+"</span>",w+='<span class="button no">'+a.noButton+"</span>"):w+='<span class="button ok">'+a.OKButton+"</span>",l.querySelector(".buttons").innerHTML=w,$("#alertModal .button.ok").on("click",(function(){y(),null!=s&&null!=s&&s.call(this)})),$("#alertModal .button.yes").on("click",(function(){y(),null!=s&&null!=s&&s.call(this)})),$("#alertModal .button.no").on("click",(function(){y(),null!=o&&null!=o&&o.call(this)}))}if(a.titleColor&&l.querySelector("h2")&&(l.querySelector("h2").style.color=a.titleColor),a.textColor&&l.querySelector("p")&&(l.querySelector("p").style.color=a.textColor),a.bgColor){l.style.backgroundColor=a.bgColor;var T=a.bgColor.substring(1),E=parseInt(T,16);.21*(E>>16&255)+.71*(E>>8&255)+.07*(E>>0&255)<100&&(x.className+=" white")}}!function(e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):window.$=e()}((function(){var e=function(e){"string"==typeof e&&(this.value=Array.prototype.slice.call(document.querySelectorAll(e))),"object"==typeof e&&(this.value=[e])};return e.prototype={eq:function(e){return this.value=[this.value[e]],this},each:function(e){return[].forEach.call(this.value,e),this},css:function(e){return this.each((function(t){t.style.cssText=t.style.cssText+e}))},cssdom:function(e){return this.each((function(t){for(var o in e)t.style[o]=e[o]}))},attr:function(e,t){return this.each((function(o){o.setAttribute(e,t)}))},getAttr:function(e){return this.value[0].getAttribute(e)},removeAttr:function(e){return this.each((function(t){t.removeAttribute(e)}))},animate:function(e,t,o,n,i,a,s,r,l,d){return this.each((function(c){c.style.cssText=c.style.cssText+"transition: all "+e+"s ease-in-out; transform: scale("+t+") rotate("+o+"deg) rotateX("+n+"deg) rotateY("+i+"deg) translate("+a+"px, "+s+"px) skew("+r+"deg, "+l+"deg); opacity:"+d+";"}))},on:function(e,t){return this.each((function(o){o.addEventListener(e,t,!1)}))},addClass:function(e){var t=e.split(" ");return this.each((function(e){for(var o=0;o<t.length;o++)e.classList?e.classList.add(t[o]):e.className+=" "+t[o]}))},toggleClass:function(e){var t=e.split(" ");return this.each((function(e){for(var o=0;o<t.length;o++)e.classList?e.classList.toggle(t[o]):new RegExp("\\b"+t[o]+"\\b").test(e.className)?e.className=e.className.replace(new RegExp("\\b"+t[o]+"\\b","g"),""):e.className+=" "+t[o]}))},removeClass:function(e){var t=e.split(" ");return this.each((function(e){for(var o=0;o<t.length;o++)e.classList?e.classList.remove(t[o]):e.className=e.className.replace(new RegExp("\\b"+t[o]+"\\b","g"),"")}))},html:function(e){return void 0===e?this.value[0].innerHTML:this.each((function(t){t.innerHTML=e}))},text:function(e){return void 0===e?this.value[0].innerText||this.value[0].textContent:this.each((function(t){t.innerText=e,t.textContent=e}))},insertBefore:function(e){return this.each((function(t){t.insertAdjacentHTML("beforeBegin",e)}))},insertAfter:function(e){return this.each((function(t){t.insertAdjacentHTML("afterEnd",e)}))},insertFirst:function(e){return this.each((function(t){t.insertAdjacentHTML("afterBegin",e)}))},insertLast:function(e){return this.each((function(t){t.insertAdjacentHTML("beforeEnd",e)}))},empty:function(){return this.each((function(e){e.innerHTML=""}))},parent:function(){return $(this.value[0].parentNode)},siblings:function(){return this.value=Array.prototype.filter.call(this.value[0].parentNode.children,e=>e!==this.value[0]),this},offset:function(){return this.each((function(e){offset=e.getBoundingClientRect()}))},log:function(){console.log(this)}},function(t){return new e(t)}}));class library{constructor(e,t){var o=this;o.scene=e,o.sceneIndex=e.index,o.data=t,o.isLoaded=!1,o.version=1,t||(o.version=0,console.log("OLD: LIB v0")),o.assetsFolder=o.scene.sceneFolder,o.totalAssetsToLoad=0,o.totalSizeToLoad=0,o.totalSizeLoaded=0,o.modelsToLoad=[],o.texturesToLoad=[],o.textsToLoad=[],o.audiosToLoad=[],o.nbAssetsLoaded=0,o.nbAudiosLoaded=0,o.nbTextureFiles=0}loadMedias(){var e=new THREE.Group;e.name="medias root",this.onModelLoaded(e,null)}countsAssetsForV0(){var e=this;e.countTexturesV0(),e.totalAssetsToLoad=1,e.totalAssetsToLoad+=e.nbTextureFiles;var t=e.scene.settings;t.audio&&t.audio.sounds&&(e.totalAssetsToLoad+=t.audio.sounds.length),e.totalSizeToLoad=e.totalAssetsToLoad+1}countTexturesV0(){var e,t=this;t.nbTextureFiles=0,t.scene.materials.forEach((function(o){(e=o.colorMap)&&e.url&&t.nbTextureFiles++,(e=o.normalMap)&&e.url&&t.nbTextureFiles++,(e=o.metalnessMap)&&e.url&&t.nbTextureFiles++}))}buildLoadingQueue(){var e=this,t=e.countAssetsUsed();if(e.totalAssetsToLoad=t.nbAssetsUsed,e.totalSizeToLoad=t.totalSizeToLoad,_config.isDebug){var o=[];e.modelsToLoad.forEach((function(t){o.push({name:t.name,type:t.type,size:e.getAssetFileSize(t)})})),e.texturesToLoad.forEach((function(t){o.push({name:t.name,type:t.type,size:e.getAssetFileSize(t)})})),e.textsToLoad.forEach((function(t){o.push({name:t.name,type:t.type,size:e.getAssetFileSize(t)})})),e.audiosToLoad.forEach((function(t){o.push({name:t.name,type:t.type,size:e.getAssetFileSize(t)})})),console.table(o)}}countAssetsUsed(){var e=this,t=0,o=0,n=e.scene.data,i=e.scene.data.composition;return e.data.forEach((function(a){var s=a.uid,r=!1;if("model"==a.type&&(r=!0,e.modelsToLoad.push(a)),"audio"==a.type&&(r=!0,e.audiosToLoad.push(a)),"text"==a.type)for(l=0;l<i.length;l++){if((d=i[l]).items)for(u=0;u<d.items.length;u++)if(d.items[u].uid==s){r=!0,e.textsToLoad.push(a);break}if(r)break}if("image"==a.type||"video"==a.type){var l,d,c,u;for(l=0;l<i.length;l++){if((d=i[l]).items)for(u=0;u<d.items.length;u++)if(d.items[u].uid==s){e.texturesToLoad.push(a),r=!0;break}if(r)break}if(!r)for(l=0;l<n.materials.length;l++){if((c=n.materials[l]).colorMap&&c.colorMap.uid==s){e.texturesToLoad.push(a),r=!0;break}if(c.normalMap&&c.normalMap.uid==s){e.texturesToLoad.push(a),r=!0;break}if(c.metalnessMap&&c.metalnessMap.uid==s){e.texturesToLoad.push(a),r=!0;break}if(c.emissiveMap&&c.emissiveMap.uid==s){e.texturesToLoad.push(a),r=!0;break}}}r&&("video"==a.type&&a.audio&&"false"!==a.audio&&(addToLog("V1 video requires a START button"),e.needStartPanel()),t++,o+=e.getAssetFileSize(a))})),{nbAssetsUsed:t,totalSizeToLoad:o}}getAssetFileSize(e){if(!e)return console.log("getAssetFileSize item NULL"),0;var t=0;return"model"==e.type?(e.fileSizeZ?t=e.fileSizeZ:e.fileSize&&(t=e.fileSize),t):"audio"==e.type?(e.fileSize&&(t=e.fileSize),t):"text"==e.type?250:"image"==e.type||"video"==e.type?t=_browser.webp&&e.sizeWebp?e.sizeWebp:e.fileSize:void 0}startLoadingAssets(){console.log("LIB start loading all"),this.loadLibraryModels()}updateAssetLoader_incomplete(e,t){var o=this;if(o.totalSizeToLoad){var n=o.getAssetFileSize(e)*t/100,i=o.totalSizeLoaded+n,a=parseInt(i/o.totalSizeToLoad*100);o.updateLoader(a)}}updateLoader(e){_screens.loading.updateLoader(e)}assetLoaded(e=null){var t=this;if(t.nbAssetsLoaded++,t.totalSizeLoaded+=e?t.getAssetFileSize(e):1,t.totalSizeToLoad){var o=parseInt(t.totalSizeLoaded/t.totalSizeToLoad*100);t.updateLoader(o)}}loadLibraryModels(e=null){var t=this;if(addToLog("-> scene "+t.sceneIndex+" : load models"),0!=t.modelsToLoad.length){var o=t.modelsToLoad[0],n={folder:t.assetsFolder,type:o.format,url:o.url,z:o.z,uid:o.uid};loadAB(t,n)}else t.onLibraryModelsLoaded()}updateModelLoader(e){var t=this;if(0!=t.version){var o=null;t.data.forEach((function(e){"model"!=e.type||(o=e)})),t.updateAssetLoader_incomplete(o,e)}}onModelLoaded(e,t){var o=this;if(addToLog("-> scene "+o.sceneIndex+" : onModelLoaded"),o.version>0){var n=null;o.data.forEach((function(e){"model"!=e.type||(n=e)})),o.assetLoaded(n)}var i=null,a=null;t&&(t.animations&&(i=t.animations),t.textures&&(a=t.textures));var s=o.scene;s.object=e,s.animations=i,s.modelTextures=a,o.onLibraryModelsLoaded()}onLibraryModelsLoaded(){var e=this;addToLog("-> scene "+e.sceneIndex+" : all models Loaded"),0!=e.version?e.loadTexturesV1():e.loadTexturesV0()}loadTexturesV0(){var e,t,o,n=this,i=n.scene;for(addToLog("LIB load Textures v0"),n.nbTextureFiles=0,e=0;e<i.materials.length;e++)i.textures.push({}),(o=(t=i.materials[e]).colorMap)&&o.url&&n.nbTextureFiles++,(o=t.normalMap)&&o.url&&n.nbTextureFiles++,(o=t.metalnessMap)&&o.url&&n.nbTextureFiles++;0!=n.nbTextureFiles?n.loadTextureV0(0,"colorMap"):n.onTexturesLoaded()}loadTexturesV1(){var e,t,o=this;if(addToLog("-> scene "+o.sceneIndex+" : load lib textures"),o.scene.textures=[],o.texturesToLoad.length)for(o.nbTextureFiles=o.texturesToLoad.length,e=0;e<o.texturesToLoad.length;e++)t=o.texturesToLoad[e],o.loadOneTexture(t);else o.onTexturesLoaded()}loadOneTexture(e){var t,o,n,i,a=this,s=a.scene.data.composition,r=a.scene.data.materials,l=e.uid,d=!1;for(t=0;t<s.length;t++)if((o=s[t]).items)for(i=0;i<o.items.length;i++)if(o.items[i].uid==l){d=!0;break}if(!d)for(t=0;t<r.length;t++){if((n=r[t]).colorMap&&n.colorMap.uid==l){d=!0;break}if(n.normalMap&&n.normalMap.uid==l){d=!0;break}if(n.metalnessMap&&n.metalnessMap.uid==l){d=!0;break}if(n.emissiveMap&&n.emissiveMap.uid==l){d=!0;break}}if(!d)return console.log("skip loading texture"),void a.textureLoaded(!0);if(_config.isDebug&&e.webp&&_browser.webp)e.fileSize,e.sizeWebp;var c=function(){a.textureLoaded(!1,e)};"image"==e.type&&a.loadImageTexture(e,null,c),"video"==e.type&&a.loadVideoTexture(e,null,c)}loadImageTexture(e,t=null,o){var n=this,i=n.scene.textures;if(null!=e.url){var a=e.url;_browser.webp&&e.webp&&(a=e.webp);var s=n.assetsFolder+a,r=e.r,l=(new THREE.TextureLoader).load(s+"?"+r,(function(e){o.call(n),e.wrapS=e.wrapT=THREE.RepeatWrapping}),(function(e){}),(function(e){addToLog("ERROR : loading texture: "+t),console.log("ERROR : loading texture: "+t),console.log(e),o.call(n)}));l.uid=e.uid,null!==t?i[t]=l:i[i.length]=l}else addToLog("map url undef "+t+" "+typeMap)}loadVideoTexture(e,t=null,o){var n=this,i=n.scene.textures,a=n.assetsFolder+e.url;a=a+"?r="+Math.random();var s=e.uid;if(null===t&&(t=i.length),$('.videoTexture[data-uid="'+s+'"]').eq(0).length)return console.log("video already loaded"),void o.call(this);var r=document.createElement("video");i[t]=new THREE.VideoTexture(r),i[t].uid=e.uid,r.setAttribute("class","videoTexture"),r.setAttribute("data-uid",s),r.setAttribute("data-scene",n.sceneIndex),r.setAttribute("preload","auto");var l=!0;"false"===e.audio&&(e.audio=!1),e.audio?(l=!1,r.autoplay=!1,_needVolumeButton=!0):(addToLog("video -> auto play"),r.autoplay=!0),_isVolumeOn||(l=!0),l||_app.common.showVolumeButton(),l=!0;var d=!1;e.loop&&"false"!==e.loop&&(d=!0),void 0===e.loop&&(d=!0),r.muted=l,r.loop=d,r.playsInline=!0;var c=e.fileSize,u=null;if("chrome"==_browser.name){var m=navigator.connection;m&&(u=m.effectiveType),addToLog("n speed "+u)}r.setAttribute("loaded","false"),r.addEventListener("progress",(function(e){}),!1),r.addEventListener("loadedmetadata",(function(t){if("true"!=r.getAttribute("loaded")){r.setAttribute("loaded","true"),r.play().catch(e=>{console.log("auto play prevented"),addToLog("failed promise preload"),console.log(e)}).then(()=>{});var i=1e3+parseInt(1*c/2);"2g"!=u&&"3g"!=u||(i=2e3+1*c),addToLog("video TTW "+i),n.updateAssetLoader_incomplete(e,25),setTimeout((function(){n.updateAssetLoader_incomplete(e,50)}),parseInt(2*i/4)),setTimeout((function(){o.call(n)}),parseInt(4*i/4))}}),!1),r.addEventListener("error",e=>{console.log("ERROR loading video"),addToLog("error video A"),o.call(n)}),r.src=a,document.body.appendChild(r)}loadTextItemFonts(e,t){var o=this,n=e.fonts.length;e.fonts.forEach((function(i){!function(i){var a=new THREE.FontLoader,s=null;if("inter"==i&&(s="Inter_Regular.json"),"cardo"==i&&(s="Cardo_Regular.json"),"oswald"==i&&(s="Oswald_Regular.json"),!s)return console.log("ERROR: no font file to load"),void(0==--n&&t&&t.call(this));a.load("/assets/3dfonts/"+s,(function(e){e.name=i,o.scene.fonts.push(e),0==--n&&t&&t.call(this)}),(function(t){var n=0;t.lengthComputable&&(n=t.loaded/t.total*100),o.updateAssetLoader_incomplete(e,n)}),(function(e){console.log("An error happened loading the font"),0==--n&&t&&t.call(this)}))}(i)}))}textureLoaded(e=!1,t=null){var o=this;e||o.assetLoaded(t),o.nbTextureFiles--,o.nbTextureFiles<=0&&(addToLog("-> scene "+o.sceneIndex+" : all textures loaded"),o.onTexturesLoaded())}loadTextureV0(e,t){var o=this;addToLog("V0 load Texture "+e+" "+t);var n=o.scene.textures,i=o.scene.data.materials[e];if(!i)return console.log("vr bundle error: mat is undef"),void o.loadNextTextureV0(e,t);var a=i[t];if(a)if(o.assetLoaded(null),a.url)if("metalnessMap"!=t||"MeshStandardMaterial"==i.type){var s=o.assetsFolder+a.url;if(_browser.webp&&a.webp&&(s=o.assetsFolder+a.webp),"mp4"!=s.substr(s.lastIndexOf(".")+1)){var r=new THREE.TextureLoader;n[e][t]=r.load(s,(function(n){n.wrapS=n.wrapT=THREE.RepeatWrapping,o.loadNextTextureV0(e,t)}),(function(e){}),(function(){addToLog("error loading texture: "+e+" "+t),o.loadNextTextureV0(e,t)}))}else{addToLog("v0 load Video Texture");var l=document.createElement("video");l.setAttribute("loaded","false"),l.oncanplaythrough=function(){"true"!=l.getAttribute("loaded")&&(l.setAttribute("loaded","true"),o.loadNextTextureV0(e,t))},l.onprogress=function(n){"true"!=l.getAttribute("loaded")&&this.duration&&this.buffered&&(l.setAttribute("loaded","true"),o.loadNextTextureV0(e,t))};var d=!0;i.audio&&1==i.audio&&(addToLog("V0 video requires a START button"),d=!1,o.needStartPanel()),l.className="videoTexture",l.setAttribute("height",128),l.setAttribute("width",128),l.setAttribute("data-scene",o.sceneIndex),l.setAttribute("data-mat",e),document.body.appendChild(l);var c=!0;!1===i.loop&&(c=!1),l.loop=c,l.playsInline=!0,d&&(l.muted=!0);var u=document.createElement("source");u.src=s,u.setAttribute("type","video/mp4"),l.appendChild(u),u.onerror=function(n){console.log("videoSourceDom: error - codec issue?"),l.setAttribute("loaded","true"),o.loadNextTextureV0(e,t)},o.isMediaScene&&!c&&(l.onended=function(t){console.log("The video has ended "+e)}),l.load(),n[e][t]=new THREE.VideoTexture(l);var m=a.width,p=a.height;if(m&&0==(m&m-1)&&(p&&0==(p&p-1))){var h=!0;_browser.android&&"firefox"==_browser.name&&(h=!1),h&&(n[e][t].wrapS=n[e][t].wrapT=THREE.RepeatWrapping)}}}else o.loadNextTextureV0(e,t);else o.loadNextTextureV0(e,t);else o.loadNextTextureV0(e,t)}loadNextTextureV0(e,t){var o=this,n=o.scene.textures;if("colorMap"!=t){if("normalMap"!=t)return"metalnessMap"==t?++e==n.length?void o.onTexturesLoaded():void o.loadTextureV0(e,"colorMap"):void 0;o.loadTextureV0(e,"metalnessMap")}else o.loadTextureV0(e,"normalMap")}onTexturesLoaded(){this.loadAllFonts()}loadAllFonts(){var e,t,o=this;if(addToLog("-> scene "+o.sceneIndex+" : load fonts"),o.data)if(o.textsToLoad.length)for(e=0;e<o.data.length;e++)"text"==(t=o.data[e]).type&&o.loadTextItem(t);else o.onFontsLoaded();else o.onFontsLoaded()}loadTextItem(e){var t=this;t.loadTextItemFonts(e,(function(){t.onFontsLoaded()}))}onFontsLoaded(){addToLog("-> scene "+this.sceneIndex+" : all fonts loaded"),this.loadAudios()}loadAudios(){var e=this;if(addToLog("-> scene "+e.sceneIndex+" : load audios"),0==e.version){var t=e.scene.settings;if(!t.audio||!t.audio.sounds)return void e.onAudiosLoaded();e.audiosToLoad=t.audio.sounds}e.scene.sounds=[],e.audiosToLoad.length?(e.scene.audioListener=new THREE.AudioListener,e.loadOneAudio(0),_needVolumeButton=!0,_app.common.showVolumeButton()):e.onAudiosLoaded()}loadOneAudio(e){var t=this,o=t.audiosToLoad[e];t.scene.sounds[e]=new THREE.Audio(t.scene.audioListener);var n=t.scene.sounds[e];n.url=o.url,n.uid=o.uid;var i=t.assetsFolder+n.url;(new THREE.AudioLoader).load(i,(function(e){t.nbAudiosLoaded++,n.setBuffer(e),t.assetLoaded(o),t.loadNextAudio()}),(function(e){var n=e.loaded/e.total*100;t.updateAssetLoader_incomplete(o,n)}),(function(o){t.nbAudiosLoaded++,addToLog("audio error "+e),t.loadNextAudio()}))}loadNextAudio(){var e=this;e.nbAudiosLoaded>=e.audiosToLoad.length?e.onAudiosLoaded():e.loadOneAudio(e.nbAudiosLoaded)}onAudiosLoaded(){addToLog("-> scene "+this.sceneIndex+" : all audios loaded"),this.onAllLibraryLoaded()}onAllLibraryLoaded(){var e=this;addToLog("-> scene "+e.sceneIndex+" : onAllLibraryLoaded"),e.isLoaded=!0,e.updateLoader(100),e.scene.onAllLibraryLoaded()}needStartPanel(){this.scene.needStartPanel()}getItemByUid(e){var t,o=this.data;for(t=0;t<o.length;t++)if(o[t].uid==e)return o[t];return null}getUSDZItem(){var e,t=this.data;for(e=0;e<t.length;e++)if("usdz"==t[e].type)return t[e];return null}}class textItem{constructor(e,t,o){var n=this;n.item=e,n.fonts=t,n.index=o}getMesh(){var e,t=this,o=t.item,n=null;for(e=0;e<t.fonts.length;e++)if(t.fonts[e].name==o.font){n=t.fonts[e];break}if(!n){console.log("ERROR: no font found");n=t.fonts[0]}var i,a=cleanString(o.text),s=new THREE.TextGeometry(a,{font:n,size:.2,height:0,curveSegments:4,bevelEnabled:!1});if(s.center(),s.rotateX(THREE.Math.degToRad(-90)),o.background.enabled){s.computeBoundingBox();const e=new THREE.Box3;e.copy(s.boundingBox);var r=e.max.x-e.min.x,l=e.max.z-e.min.z,d=.025*o.background.padding;if((m=new THREE.PlaneGeometry(r+2*d,l+2*d)).rotateX(THREE.Math.degToRad(-90)),m.translate(0,-.005,0),THREE.REVISION<=123){m.faces.forEach((function(e){e.materialIndex=1})),s.groupsNeedUpdate=!0,m.groupsNeedUpdate=!0,(c=new THREE.Geometry).mergeMesh(new THREE.Mesh(s)),c.mergeMesh(new THREE.Mesh(m)),c.mergeVertices()}else{var c=new THREE.BufferGeometry,u=s.attributes.position.count;m=m.toNonIndexed(),(c=THREE.BufferGeometryUtils.mergeBufferGeometries([m,s])).addGroup(0,6,1),c.addGroup(6,u,0),c.groupsNeedUpdate=!0}i=new THREE.Mesh(c,null)}else{s.computeBoundingBox();const e=new THREE.Box3;e.copy(s.boundingBox);var m;r=e.max.x-e.min.x,l=e.max.z-e.min.z,d=0;if((m=new THREE.PlaneGeometry(r+2*d,l+2*d)).rotateX(THREE.Math.degToRad(-90)),m.translate(0,-.005,0),THREE.REVISION<=123){m.faces.forEach((function(e){e.materialIndex=1})),s.groupsNeedUpdate=!0,m.groupsNeedUpdate=!0,(c=new THREE.Geometry).mergeMesh(new THREE.Mesh(s)),c.mergeMesh(new THREE.Mesh(m)),c.mergeVertices()}else{c=new THREE.BufferGeometry,u=s.attributes.position.count;m=m.toNonIndexed(),(c=THREE.BufferGeometryUtils.mergeBufferGeometries([m,s])).addGroup(0,6,1),c.addGroup(6,u,0),c.groupsNeedUpdate=!0}i=new THREE.Mesh(c,null)}return i.name="item "+t.index,i.itemIndex=t.index,i.indexLib=o.indexLib,i.uid=o.uid,i.isMedia=!0,i}}function scene(e,t,o,n){this.data=JSON.parse(JSON.stringify(e)),this.p_xr=n,this.p_xr||(this.p_xr=_xr),this.index=t,this.mode=o,this.type=null,this.url=e.url,this.v=e.v,this.isReady=!1,this.projectFolder=null,this.sceneFolder=null,this.isCompScene=!1,this.isModelScene=!1,this.isMediaScene=!1,this.isBundleScene=!1,this.isInABundle=!1,this.trackingMode=null,this.isInline=!1,this.settings=null,this.materials=null,this.materialsLinks=null,this.modules=null,this.rootComposition=null,this.rootMedias=null,this.rootModels=null,this.rootSmoothing=null,this.rootNoMarker=null,this.markerRoot=null,this.rootOrientation=null,this.rootXR=null,this.rootModel=null,this.mainLighting=null,this.lightingARVR=null,this.rootLighting=null,this.ambientLight=null,this.light=[],this.envMap=null,this.library=null,this.object=null,this.animations=null,this.textures=[],this.modelTextures=[],this.fonts=[],this.tris=0,this.audioListener=null,this.sounds=null,this.mixer=null,this.modulesEngine=null,this.currentMediaPage=0,this.markerNeverFound=!0,this.needCookieContent=!1,this.hint=null,this.threejsCanvas=null,this.raycaster=null,this.flowRaycaster=null,this.tracking=null,this.skyBox=null,this.markerOrientationIsVertical=!1,this.nbModels=0,this.compositionTimeOuts=[],this.markerHelper=null,this.init=function(){var e=this;console.log("v = "+e.v),e.type=e.data.model.type,"comp"==e.data.type&&(e.isCompScene=!0,e.type="comp",e.data.composition[0]||alert("the composition is empty"),e.data.composition[0].models&&e.data.composition[0].models[0]&&(e.nbModels=1)),_config.isDebug&&console.log("-> scene "+e.index+" : init | "+e.type),"obj"==e.type&&(e.isModelScene=!0),"fbx"==e.type&&(e.isModelScene=!0),"gltf"==e.type&&(e.isModelScene=!0),"dae"==e.type&&(e.isModelScene=!0),"img"!=e.type&&"media"!=e.type||(e.isMediaScene=!0),"bundle"==e.type&&(e.isBundleScene=!0),_app.bundle&&(e.isInABundle=!0),e.addMissingData(),e.trackingMode=e.data.settings.trackingMode,addToLog("tracking: "+e.trackingMode),e.setup(),"image"==e.trackingMode&&(e.markerHelper=new markerHelper(e.data,e.projectFolder),e.markerHelper.setHint())},this.addMissingData=function(){var e=this,t=e.data,o=t.settings,n=t.branding;if(e.mainLighting=o.lighting,_config.isDebug&&console.log("-> scene "+e.index+" : parse data "+e.v),e.mainLighting&&0==e.v){var i,a,s=e.mainLighting;if(null==s.enableModelLights&&(s.enableModelLights=!1),!s.ar)for(s.ar={lights:JSON.parse(JSON.stringify(s.lights)),ambient:JSON.parse(JSON.stringify(s.ambient))},s.vr={lights:JSON.parse(JSON.stringify(s.lights)),ambient:JSON.parse(JSON.stringify(s.ambient))},r=0;r<3;r++){if(i=null,s.lights[r]&&(i=s.lights[r].position),!i)return console.log("ERROR: no lights positions"),void alert("Error lights: please update the scene in the XR+ editor");a=1,s.root&&(a=s.root.transform.ar.scale.xyz),s.ar.lights[r].position={x:i.x*a,y:i.y*a,z:i.z*a},s.ar.lights[r].distance=40,a=1,s.root&&(a=s.root.transform.vr.scale.xyz),s.vr.lights[r].position={x:i.x*a,y:i.y*a,z:i.z*a},s.ar.lights[r].distance=40}"ar"==e.mode&&(e.lightingARVR=s.ar),"vr"==e.mode&&(e.lightingARVR=s.vr)}if(e.mainLighting&&e.v>=1&&(e.lightingARVR=e.mainLighting),null==o.orientationSelector&&(o.orientationSelector=1),null==o.vertical&&(o.vertical=!1),null==o.smoothing&&(o.smoothing=1),null==o.keepVisibleScale&&(o.keepVisibleScale=1),!t.modules&&o.tools&&(t.modules=o.tools),t.pattern||(t.pattern={id:null}),e.isMediaScene){var r,l,d,c,u=t.materials.length;if(o.pagination||(o.pagination={enabled:1}),!t.composition.length){for(console.log("OBS: convert media to composition"),r=0;r<u;r++){var m;t.composition[r]={items:[],title:""+(r+1)},(c=t.materials[r]).transform?(m=JSON.parse(JSON.stringify(c.transform))).rotation.x=0:m={position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{xyz:10}},t.composition[r].items[0]={transform:m,shape:"plane",matIndex:r,itemIndex:0}}if(t.transform){var p=t.transform.vr;p?(console.log("comp: fix vr t"),p.position.y=0,p.rotation.x=0):console.log("comp: no vr t")}}var h,g,v=t.composition.length;for(r=0;r<u;r++)if(h=(c=t.materials[r]).actionType)for("www"==(g={type:h}).type&&(null!=c.actionUrl&&(g.wwwUrl=c.actionUrl),null!=c.wwwModal&&(g.wwwModal=c.wwwModal),null!=c.wwwSameTab&&(g.wwwSameTab=c.wwwSameTab),void 0===g.wwwModal&&(g.wwwModal=!0),void 0===g.wwwSameTab&&(g.wwwSameTab=!1)),l=0;l<v;l++)if(t.composition[l].items)for(d=0;d<t.composition[l].items.length;d++)t.composition[l].items[d].matIndex==r&&(t.composition[l].items[d].action=JSON.parse(JSON.stringify(g)))}o.slam||(o.slam={enabled:0,distance:100,position:{x:0,y:100,z:0},skybox:{enabled:0,top:"#a0a0a0",bottom:"#202020",opacity:1}}),o.trackingMode||(console.log("OBS: no tracking mode"),o.trackingMode="image",o.slam.enabled&&(o.trackingMode="slam")),n.helper||(console.log("OBS: create helper"),n.helper={enabled:1,hintImage:null},n.main&&n.main.hint&&(n.helper.hintImage=n.main.hint))},this.needStartPanel=function(){_screens.start.isRequired=!0},this.checkCookie=function(){document.cookie.includes("_ga=")?"undefined"==typeof startGA||_gaStarted||startGA():(addToLog("GA requires START BUTTON"),this.needCookieContent=!0,this.needStartPanel())},this.setup=function(){var e=this,t=e.data,o=t.settings;if(addToLog("-> scene "+e.index+" : setup"),addToLog("-> check for START button"),e.projectFolder=_rootDirectory+"s/"+t.folder+"/"+t.url+"/",_config.externalHost&&_config.projectFolder&&(e.projectFolder=_config.projectFolder),e.sceneFolder=e.projectFolder,e.rootOrientation=new THREE.Group,e.rootOrientation.name="R Ori "+e.index,e.rootXR=new THREE.Group,e.rootXR.name="rootXR",e.rootComposition=new THREE.Group,e.rootComposition.name="rootComposition",e.rootXR.add(e.rootComposition),e.rootModels=new THREE.Group,e.rootModels.name="rootModels",e.rootComposition.add(e.rootModels),e.rootMedias=new THREE.Group,e.rootMedias.name="rootMedias",e.rootComposition.add(e.rootMedias),e.rootModel=new THREE.Group,e.rootModel.name="rootModel",e.rootNoMarker=new THREE.Group,e.rootNoMarker.name="rootNoMarker "+e.index,e.rootSmoothing=new THREE.Group,e.rootSmoothing.name="rootSmoothing "+e.index,e.rootModels.add(e.rootModel),e.modules=e.data.modules,e.modules||(e.modules={}),!e.modules.states&&o.animations){var n=o.animations.activeIndex;null!=n&&-1!=n&&(console.log("OBS: convert settings.animations to states"),e.modules.states={defaultStateIndex:0,enabled:!0,open:!1,states:[{name:"state 1",order:0,enter:[{animationIndex:n,animationLoop:!0,type:"playAnimation"}]}]},o.animations=null)}o.audio&&o.audio.sounds&&(-1!=o.audio.activeIndex&&null!=o.audio.activeIndex&&(console.log("OBS: convert audio settings to states"),e.modules.states||(e.modules.states={defaultStateIndex:0,enabled:!0,open:!1,states:[{name:"state 1",order:0}]}),(s=e.modules.states.states[e.modules.states.defaultStateIndex]).enter||(s.enter=[]),s.enter.push({type:"playAudio",audioIndex:0}),delete o.audio.activeIndex));e.isInABundle&&_app.tracking&&(e.tracking=_app.tracking,"selector"==e.tracking.type&&(t.pattern=e.tracking.singleMarker),"multiple"==e.tracking.type&&(t.pattern=_app.bundle.scenes[e.index].marker,t.pattern||(t.pattern={id:null}))),e.settings=e.data.settings,e.library=new library(e,e.data.library),e.materials=e.data.materials,e.materialsLinks=e.data.materialsLinks;var i,a,s,r,l=e.modules.states;if(l&&l.states&&l.enabled)for(i=0;i<l.states.length;i++)if((s=l.states[i]).enter)for(a=0;a<s.enter.length;a++)if("playAudio"==(r=s.enter[a]).type)if(e.isCompScene){if(null!=r.uidAudio&&-1!=r.uidAudio){addToLog("mod requires play button A"),e.needStartPanel();break}}else if(null!=r.audioIndex&&-1!=r.audioIndex){addToLog("mod requires play button B"),e.needStartPanel();break}e.settings.advancedStats&&e.settings.advancedStats.enabled&&e.checkCookie()},this.load=function(){var e=this;if(removePreloader(),addToLog("-> scene "+e.index+" : load : "+e.data.type),e.data.composition){var t,o=e.data.composition.length;if(o>1){var n,i,a=document.getElementById("pages"),s=document.createElement("div");for(s.className="buttons",s.setAttribute("data-scene",e.index),a.appendChild(s),t=0;t<o;t++)(n=document.createElement("span")).className="button",o>=5&&n.classList.add("small"),0==t&&n.classList.add("active"),n.setAttribute("data-index",t),i=""+(t+1),e.data.composition[t].title&&(i=e.data.composition[t].title),n.textContent=i,s.appendChild(n),n.addEventListener(_clickOrTouch,(function(){var t=1*this.getAttribute("data-index");e.goToCompositionPage(t)}))}}if(e.isMediaScene)e.library.loadMedias();else if(e.isCompScene?e.library.buildLoadingQueue():e.library.countsAssetsForV0(),_config.isDebug&&(console.log("totalAssetsToLoad "+e.library.totalAssetsToLoad),console.log("totalSizeToLoad "+e.library.totalSizeToLoad+" kb")),e.isCompScene)e.library.startLoadingAssets();else{var r=e.data.model;r.folder=e.projectFolder,loadAB(e.library,r)}},this.closeStartPanel=function(){var e=this;(addToLog("-> scene "+e.index+" : close start panel"),e.stopAllSceneVideos(),_video)&&(_browser.android&&_video.paused&&(addToLog("force play"),_video.play()),_browser.ios&&_video.play().catch(e=>{}).then(()=>{}));var t=!0;if("slam"==e.trackingMode&&(_app.xr||_app.startLoop(),_app.xr&&(t=!1)),"fixed"==e.trackingMode&&(_app.start(),t=!1),"image"==e.trackingMode){_browser.ios&&e.fakeStartAllSceneVideos();var o=!1;"undefined"!=typeof _isNFT&&(o=_isNFT),o?(_config.isSimulator||e.isInline||_app.start(),_config.isSimulator&&_app.start(),e.isInline&&_app.start()):_app.start()}t&&_app.selectScene(0)},this.setActive=function(e=!1,t=!1){var o=this;addToLog("---\x3e set scene active "+o.index+" "+e),o.setupLighting();var n=!1;$("#pages, #pages .buttons").css("display:none;"),(o.isMediaScene||o.library.version>0)&&(o.settings.pagination&&o.settings.pagination.enabled&&o.data.composition.length>1&&$('#pages, #pages .buttons[data-scene="'+o.index+'"]').css("display:block;"),"image"==o.trackingMode&&(n=!0,o.markerRoot&&(n=!1,o.markerRoot.visible&&(n=!0),o.settings.keepVisible&&!o.markerNeverFound&&(n=!0)))),(e||t||n)&&o.playSceneVideos(),$(".module").removeClass("activeScene"),"ar"==o.mode&&e&&o.foundMarker();var i=!1;"vr"==o.mode&&(i=!0),"image"!=o.trackingMode&&(i=!0),i&&o.setupDelays(),o.modulesEngine||console.log("c.modulesEngine is null"),o.modulesEngine.setActiveModules()},this.setupMainScreen=function(){var e=this;if(addToLog("scene "+e.index+" -> setupMainScreen"),"ar"==e.mode){var t=$("#b_share"),o=e.data.branding,n=_mainData.player;e.markerHelper&&e.markerHelper.setup(e.isInABundle);var i=o.main;if(i){t&&(n.mainScreen&&n.mainScreen.shareButton&&n.mainScreen.shareButton.enabled&&_browser.share?t.css("display:block"):t.css("display:none"));var a=$("#orientation ul");"image"!=e.trackingMode?a.css("display:none"):i.orientationSelector?a.css("display:block"):a.css("display:none")}if(_config.isPlayer||_app.xr)if(document.getElementById("b_closeARMode"))$("#b_closeARMode").css("display:block;");else{var s=document.createElement("span");s.id="b_closeARMode",s.className="b_close";var r=document.getElementById("topRightButtons");r.insertBefore(s,r.firstChild),s.addEventListener("click",(function(t){"slam"==e.trackingMode&&_app.xr&&_xrSession?_app.closeSession():_app.common.switchTo3D(),$("#b_closeARMode").css("display:none;")}))}}},this.resumeAudioContext=function(){this.audioListener&&this.audioListener.context.resume().then((function(){console.log("audio Playback resumed ok")}))},this.foundMarker=function(e){var t=this;if(t.markerNeverFound)t.applyDefaultState(),t.setupDelays();else if(e){var o=t.modulesEngine.modulesData.states;o&&1==o.enabled&&o.revertTime&&o.revertTime<e&&(addToLog("revert to default state"),t.applyDefaultState(),t.setupDelays())}t.playSceneVideos(),"image"==t.trackingMode&&(t.markerNeverFound||e>2)&&(t.gaEvent({event:"scan marker",event_category:"scene",event_label:"scan marker"}),t.sendAPIMessage({scene:t.url,sceneEvent:"marker found"})),t.markerNeverFound=!1},this.lostMarker=function(){this.sendAPIMessage({scene:this.url,sceneEvent:"marker lost"})},this.sendAPIMessage=function(e){_browser.insideIframe&&window.parent.postMessage(e,"*")},this.buildComposition=function(e=!0,t=!1){var o,n=this;for(addToLog("==>> build Comp "+n.currentMediaPage+" play videos "+e);n.rootMedias.children.length>0;)n.rootMedias.remove(n.rootMedias.children[0]);var i=n.data.composition[n.currentMediaPage];if(i){if(e?n.playSceneVideos(t):n.pauseAllSceneVideos(),n.rootModel&&(0==n.currentMediaPage&&(n.rootModel.visible=!0),n.currentMediaPage>0&&(n.rootModel.visible=!1)),i.items){var a,s;for(o=0;o<i.items.length;o++){var r,l,d;if(a=i.items[o],n.library.version>0&&(s=n.getLibraryItemByUid(a.uid)),n.library.version>0?(l=s,d=a.shape):d=(l=n.materials[a.matIndex]).shape,"VideoMaterial"==l.type&&null==l.loop&&(console.log("OBS video loop"),l.loop=!0),d||(d="plane"),"text"!=d){"plane"==d&&(r=new THREE.PlaneGeometry(1,1)),"circle"==d&&(r=new THREE.CircleGeometry(.5,64)),r.rotateX(THREE.Math.degToRad(-90));var c=new THREE.Mesh(r,null);c.name="item "+o,c.itemIndex=o,c.matIndex=a.matIndex,c.uid=a.uid,c.isMedia=!0,a.compUid&&(c.compUid=a.compUid),n.rootMedias.add(c)}else{var u=new textItem(a,n.fonts,o).getMesh();n.rootMedias.add(u)}}n.refreshComposition()}else n.isCompScene&&n.refreshComposition();if(n.setupMaterials(),i.items&&n.startCompositionAnimations(),n.stopAudios(),i.sounds&&i.sounds.length){var m=i.sounds[0].index;n.playAudio(m,!1)}}},this.setupDelays=function(){var e=this;if(console.log("/ / / setupdelays"),e.rootMedias){e.compositionTimeOuts.forEach((function(e){clearTimeout(e),e=null})),e.compositionTimeOuts=[];var t=e.data.composition[e.currentMediaPage];t&&t.items&&e.rootMedias.traverse((function(o){var n=o.itemIndex;if(void 0!==n){var i=t.items[n];i&&i.delay&&e.setupItemDelay(o,i.delay)}}))}},this.setupItemDelay=function(e,t){e.visible=!1;var o=setTimeout((function(){e.visible=!0}),1*t);this.compositionTimeOuts.push(o)},this.startCompositionAnimations=function(){var e,t,o,n,i,a,s=this,r=s.data.composition[s.currentMediaPage].items;for(t=0;t<r.length;t++){if(e=r[t],s.library)var l=e;else l=s.materials[e.matIndex];var d,c,u,m,p,h,g=l.animationType,v=l.animationSpeed,f=null;if(s.rootMedias.traverse((function(e){e.itemIndex==t&&(f=e)})),!f)return void console.log("animated object is null");if(d=f.scale.x,c=f.scale.y,u=f.scale.z,f.originalScale||(f.originalScale={x:d,y:c,z:u}),"scale_up_down"==g){m=d*(a=1.1),p=c*a,h=u*a,o=800,n=600,"slow"==v&&(o=1500),"fast"==v&&(o=400);var b=new TWEEN.Tween(f.scale).to({x:m,y:p,z:h},o),y=new TWEEN.Tween(f.scale).to({x:d,y:c,z:u},n);b.chain(y),y.chain(b),b.start()}if("pulse"==g){m=d*(a=1.1),p=c*a,h=u*a;var x=1200;"slow"==v&&(x=2e3),"fast"==v&&(x=800),o=parseInt(30*x/100),n=parseInt(10*x/100),i=parseInt(60*x/100);b=new TWEEN.Tween(f.scale).to({x:m,y:p,z:h},o),y=new TWEEN.Tween(f.scale).to({x:d,y:c,z:u},n);var w=new TWEEN.Tween(null).to(null,i);b.chain(y),y.chain(w),w.chain(b),b.start(),b.animationType=g,y.animationType=g,w.animationType=g}if("rot_y_clockwise"==g)o=2e3,"slow"==v&&(o=5e3),"fast"==v&&(o=1e3),new TWEEN.Tween(f.rotation).to({y:"-"+Math.PI/2},o).onComplete((function(){Math.abs(f.rotation.y)>=2*Math.PI&&(f.rotation.y=f.rotation.y%(2*Math.PI))})).start().repeat(1/0);if("rot_y_anticlockwise"==g)o=2e3,"slow"==v&&(o=5e3),"fast"==v&&(o=1e3),new TWEEN.Tween(f.rotation).to({y:"+"+Math.PI/2},o).onComplete((function(){Math.abs(f.rotation.y)>=2*Math.PI&&(f.rotation.y=f.rotation.y%(2*Math.PI))})).start().repeat(1/0)}},this.refreshComposition=function(){var e,t,o,n,i,a,s=this,r=s.materials,l=s.data.composition[s.currentMediaPage];s.rootMedias.traverse((function(d){if(s.rootMedias!=d){if(n=l.items[d.itemIndex],i=n.transform,null==n.uid)(a=r[n.matIndex]).colorMap&&a.colorMap.width&&(e=a.colorMap.width,t=a.colorMap.height,o=i.scale.xyz/10,d.scale.set(1*o,1*o,t/e*o));else{var c=s.getLibraryItemByUid(n.uid);e=c.width,t=c.height,o=i.scale.xyz/10,d.scale.set(1*o,1*o,t/e*o)}0==s.v&&d.position.set(1*i.position.x,1*i.position.y,1*i.position.z),s.v>=1&&d.position.set(i.position.x/10,i.position.y/10,i.position.z/10),d.rotation.set(1*i.rotation.x,1*i.rotation.y,1*i.rotation.z)}}))},this.goToCompositionPage=function(e){var t=this;e>=t.data.composition.length||(t.currentMediaPage=e,t.buildComposition(!0,!0),t.setupDelays(),$('#pages .buttons[data-scene="'+t.index+'"] .button').removeClass("active"),$('#pages .buttons[data-scene="'+t.index+'"] .button').eq(e).value[0]&&$('#pages .buttons[data-scene="'+t.index+'"] .button').eq(e).addClass("active"))},this.updateModelLoader=function(e){this.library.updateModelLoader(e)},this.addObject=function(){var e,t,o=this;addToLog("-> scene "+o.index+" : add model");var n=o.data.composition;if(n.length&&n[0].models){if(e=n[0].models[0].transform,t=n[0].models[0].scaleToFit,o.isCompScene){var i=o.getLibraryItemByUid(n[0].models[0].uid);if(!i)return void console.log("model not found in library");t=i.scaleToFit}}else addToLog("OBS: using transform"),e=o.data.transform[o.mode],t=o.data.transform.scaleToFit;var a=o.rootModel,s=e.position,r=e.rotation,l=e.scale.xyz*t/10;if(a.position.set(s.x/10,s.y/10,s.z/10),a.rotation.set(THREE.Math.degToRad(r.x),THREE.Math.degToRad(r.y),THREE.Math.degToRad(r.z)),a.scale.set(l,l,l),a.add(o.object),"vr"==o.mode){var d=a,c=new THREE.Vector3(s.x/10,s.y/10,s.z/10);a.position.set(c.x,c.y,c.z),(d=o.rootComposition).position.set(0,0,-.25),c=new THREE.Vector3;new TWEEN.Tween(d.position).to(c,1e3).easing(TWEEN.Easing.Quadratic.Out).start()}"ar"==o.mode&&(o.rootXR.rotation.set(THREE.Math.degToRad(90),0,0),o.rootOrientation.add(o.rootXR)),o.isInline&&(o.rootXR.rotation.set(0,0,0),o.rootOrientation.add(o.rootXR)),_config.isSimulator&&(addToLog("simulator"),o.rootXR.rotation.set(0,0,0))},this.onAllLibraryLoaded=function(){var e=this;if("vr"==e.mode||_config.isSimulator)e.onReady();else if("ar"==e.mode){if(_isInline)return console.log("scene: inline -> onReady ======="),void e.onReady();if(e.isInABundle){if("slam"==e.tracking.type)return void e.onReady();if("multiple"==e.tracking.type)return void e.loadARLibraryOrMarker();if("selector"==e.tracking.type)return void e.loadARLibraryOrMarker();console.log("ERROR: bundle: BAD tracking handking")}if("slam"==e.trackingMode)return void e.onReady();if("fixed"==e.trackingMode)return void e.onReady();if("image"==e.trackingMode)return void e.loadARLibraryOrMarker();if("face"==e.trackingMode)return void e.onReady()}},this.loadARLibraryOrMarker=function(){0==this.index?_isNFT?_xr.loadPattern():window.ARController&&ARController.getUserMediaThreeScene?(console.log("--- LOAD AR FID LIB ---"),_xr.ARThreeOnLoad()):(addToLog("ERROR 345 arcon"),console.log("ERROR 345 arcon")):_isNFT?_xr.loadPattern():_xr.loadMarker(32)},this.onReady=function(){var e=this;if(e.isReady=!0,_$body.removeClass("loading"),addToLog("-> scene "+e.index+" : ready"),e.threejsCanvas=document.getElementById("threejs"),e.setupRayCast(),_keepComposition)return console.log("KEEP COMP"),e.modulesEngine||(console.log("new mod engine"),e.modulesEngine=new modules(_xr,e)),void _app.allSceneDataLoaded();e.isMediaScene&&(e.data.composition[e.currentMediaPage].items&&e.buildComposition(!1));if(e.isModelScene&&e.setupMaterials(),e.isCompScene){if(e.nbModels?e.addObject():(e.rootXR.rotation.set(THREE.Math.degToRad(90),0,0),_config.isSimulator&&e.rootXR.rotation.set(0,0,0)),e.settings.pagination&&e.settings.pagination.startPage){e.data.composition[e.settings.pagination.startPage]||(console.log("revert start page to zero"),e.settings.pagination.startPage=0),e.currentMediaPage=e.settings.pagination.startPage;var t=$('#pages .buttons[data-scene="'+e.index+'"] .button');t.value.length&&t.removeClass("active").eq(e.currentMediaPage).addClass("active"),console.log("start page is "+e.currentMediaPage)}e.buildComposition(!1),e.rootOrientation.add(e.rootXR)}if(e.setupAnimations(),e.setupEnvMap(),0==e.library.version&&e.addObject(),e.modulesEngine=new modules(_xr,e),null!=document.querySelectorAll("#sceneSelector li")){var o=document.querySelectorAll("#sceneSelector li")[e.index];o&&(o.style.visibility="visible")}_app.allSceneDataLoaded()},this.setupRayCast=function(){var e=this;function t(t){_browser.desktop||(t.clientX=t.touches[0].clientX,t.clientY=t.touches[0].clientY),$("#bgModal").length>0||e.rayCast(t)}e.raycaster=new THREE.Raycaster,_browser.desktop?e.threejsCanvas.addEventListener("click",t,!1):e.threejsCanvas.addEventListener("touchstart",t,!1)},this.applyDefaultState=function(){var e=this.modulesEngine,t=e.modulesData.states;t&&t.enabled&&e.statesModule.applyDefaultState()},this.fakeStartAllSceneVideos=function(){addToLog("FAKE start all videos");var e,t=document.querySelectorAll('.videoTexture[data-scene="'+this.index+'"]');if(t)for(e=0;e<t.length;e++)this.fakeStartOneVideo(t[e])},this.fakeStartOneVideo=function(e){e.play().then((function(){addToLog("promised then - stop "),e.pause(),e.currentTime=0})).catch((function(e){addToLog("error fake play promise")}))},this.pauseAllSceneVideos=function(){addToLog("PAUSE all scenes videos");var e=document.querySelectorAll('.videoTexture[data-scene="'+this.index+'"]');e&&e.forEach((function(e){e.pause()}))},this.stopAllSceneVideos=function(){addToLog("STOP all scenes videos");var e=document.querySelectorAll('.videoTexture[data-scene="'+this.index+'"]');e&&e.forEach((function(e){e.pause(),e.currentTime=0}))},this.playVideoByUid=function(e,t){console.log("play video "+e);var o=document.querySelector('.videoTexture[data-uid="'+e+'"]');if(o){var n=this.getLibraryItemByUid(e),i=!0;"false"===n.audio&&(n.audio=!1),n.audio&&(i=!1),_isVolumeOn||(i=!0),console.log("UNMUTE : "+!i),o.muted=i,o.play().then((function(){console.log("play ok"),o.setAttribute("data-stopped","false"),o.setAttribute("data-paused","false")})).catch((function(e){console.log("play prevented"),console.log(e)}))}},this.stopVideoByUid=function(e){var t=document.querySelector('.videoTexture[data-uid="'+e+'"]');t&&(t.pause(),t.currentTime=0,t.setAttribute("data-stopped","true"))},this.pauseVideoByUid=function(e){var t=document.querySelector('.videoTexture[data-uid="'+e+'"]');t&&(t.pause(),t.setAttribute("data-paused","true"))},this.playVideo=function(e,t){console.log("OBS play 1 video "+e+" "+t);var o,n=this,i=document.querySelectorAll('.videoTexture[data-scene="'+n.index+'"]');if(i)for(o=0;o<i.length;o++)if(i[o].getAttribute("data-mat")==e){var a=i[o];if(n.isCompScene){var s=a.getAttribute("data-uid"),r=n.getLibraryItemByUid(s),l=!0;"false"===r.audio&&(r.audio=!1),r.audio&&(l=!1),_isVolumeOn||(l=!0),console.log("UNMUTE : "+!l),a.muted=l}return a.play(),a.setAttribute("data-stopped","false"),void a.setAttribute("data-paused","false")}},this.stopVideo=function(e){var t,o=document.querySelectorAll('.videoTexture[data-scene="'+this.index+'"]');if(o)for(t=0;t<o.length;t++)if(o[t].getAttribute("data-mat")==e)return o[t].pause(),o[t].currentTime=0,void o[t].setAttribute("data-stopped","true")},this.playVideoTextures=function(){console.log("OBS : playVideoTextures"),this.playSceneVideos()},this.playSceneVideos=function(e=!1){var t=this;if(addToLog("-> scene "+t.index+" : play Videos | restart: "+e),t.isReady&&!_screens.start.visible){var o=null;(t.isMediaScene||t.isCompScene)&&(o=t.data.composition[t.currentMediaPage]);var n,i,a,s,r=document.querySelectorAll('.videoTexture[data-scene="'+t.index+'"]');if(r)for(n=0;n<r.length;n++)if(s=!1,"true"!=(a=r[n]).getAttribute("data-stopped")){if(t.isModelScene&&(s=!0),t.isMediaScene){if(!o.items)continue;var l=a.getAttribute("data-mat");for(i=0;i<o.items.length;i++)if(o.items[i].matIndex==l){s=!0;break}}if(t.isCompScene){var d=a.getAttribute("data-uid");if(o.items)for(i=0;i<o.items.length;i++)if(o.items[i].uid==d){s=!0;break}if(o.models)for(i=0;i<o.models.length;i++){var c,u;for(c=0;c<t.data.materials.length;c++)if(void 0===(u=t.data.materials[c].uidModel)&&(console.log("HOT fix uid model on mat"),u=999),u==o.models[i].uid&&t.data.materials[c].colorMap&&t.data.materials[c].colorMap.uid==d){s=!0;break}}}if(s&&(addToLog("--\x3e play one video scene paused= "+a.paused),e&&(addToLog("restart video"),a.currentTime=0),"chrome"!=_browser.name||a.paused)){if(t.isCompScene){var m=a.getAttribute("data-uid"),p=t.getLibraryItemByUid(m),h=!0;"false"===p.audio&&(p.audio=!1),p.audio&&(h=!1),_isVolumeOn||(h=!0),console.log("UNMUTE : "+!h),a.muted=h}var g=a.play();console.log("video promise B"),g.catch(e=>{console.log("auto play prevented"),addToLog("failed promise B"),console.log(e)}).then(()=>{console.log("video play ok")})}}else addToLog("abort auto play")}else addToLog("-> scene is not ready or not started")},this.playAudio=function(e,t){console.log("==== play audio "+e);var o=this;if(_isVolumeOn){if(1!=t&&(t=!1),!(null==e||e<0)&&(e*=1,o.sounds))if(o.isCompScene)o.sounds.forEach((function(o){if(o.uid==e){o.source&&o.stop();try{o.loop=t,o.play()}catch(e){console.log(e)}}}));else{var n=o.sounds[e];if(!n)return;n.source&&n.stop();try{n.loop=t,n.play()}catch(e){console.log(e)}}}else console.log("skipped play audio")},this.stopAudios=function(){var e=this.sounds;e&&e.forEach((function(e){e.isPlaying&&e.stop()}))},this.stopAudio=function(){console.log("OBS: stop audio"),this.stopAudios()},this.enableVolume=function(e){var t=this;console.log("enableVolume "+e);var o=document.querySelectorAll('.videoTexture[data-scene="'+t.index+'"]'),n=!e;e?t.modulesEngine.statesModule&&t.modulesEngine.statesModule.playCurrentStateAudios():t.stopAudios(),o&&o.forEach((function(e){console.log(n),e.muted=n}))},this.setAudioVolume=function(e){addToLog("set volume "+e);var t=this.sounds;t&&t.forEach((function(t){t.setVolume(e)}));var o=document.querySelectorAll('.videoTexture[data-scene="'+this.index+'"]');o&&o.forEach((function(t){t.volume=e}))},this.playSFX=function(e,t){if(console.log("OBS: play sfx "+e),!(null==e||e<0)&&this.sounds){var o=this.sounds[e];if(o){try{o.isPlaying&&t&&o.stop()}catch(e){console.log(e)}try{o.loop=!1,o.play()}catch(e){console.log(e)}}}},this.openTextBox=function(e){var t=this,o=e.content,n=e.colors,i=e.useButton,a={buttons:!1,closeButton:!0};n&&(a.titleColor=n.titleColor,a.textColor=n.textColor,a.bgColor=n.bgColor),i&&(a.buttons=!0,a.OKButton="ok",a.closeButton=!1),null!=e.stateIndex&&null!=e.stateIndex&&(a.callbackYes=function(){var o=t.modulesEngine.statesModule;o.buttonAction(o,null,{type:"switchState",stateIndex:e.stateIndex})}),openModal(o,a)},this.openLink=function(e,t,o){if(o=!0,!document.getElementById("bgModal")){var n=validateURL(t=cleanString(t)),i=!1,a=validateEmail(t),s=!1;if("tel:"==t.substring(0,4)&&(i=!0),n&&(s=!0),i&&(s=!0),a&&(s=!0),s)if(null===e&&(e={}),void 0===e.wwwModal&&(e.wwwModal=!0),void 0===e.wwwSameTab&&(e.wwwSameTab=!1),e.wwwModal){var r=null,l=null,d=t;n&&(r="Visit this page?",l=""+(d=(d=d.replace("https://","").replace("http://","")).replace(/\/$/,""))),i&&(o=!1,e.wwwSameTab=!1,d=d.replace("tel:",""),t=t.replace(/\s+/g,""),r="Call this number?",l=""+d),a&&(o=!1,e.wwwSameTab=!1,t="mailto:"+t,r="Write a message to this email?",l=""+d),e.wwwText&&""!=e.wwwText&&(r=null,l=e.wwwText),r&&(r=cleanString(r)),l&&(l=cleanString(l));var c={buttons:!0,yesButton:"yes",noButton:"cancel",closeButton:!1,callbackYes:function(){e.wwwSameTab?(window.location=t,_body.innerHTML="",_body.style.background="#a0a0a0"):_config.isDebug||_config.isSimulator||_config.noViews?(console.log("no referrer"),window.open(t,"_blank","noopener, noreferrer")):window.open(t,"_blank","noopener")}};if(openModal({h2:r,p:l},c),o){var u=new XMLHttpRequest;u.open("GET","/og/?url="+t),u.onload=function(){if(u.status>=200&&u.status<400){var e=JSON.parse(u.responseText);_config.isDebug&&console.log(e);var t=document.createElement("div");t.className="og";var o=e["og:title"],n=e["og:image"];if(!document.getElementById("alertModal"))return;var i,a=document.querySelector("#alertModal .text");if(!a)return;if(n)(i=document.createElement("img")).src=""+n,t.appendChild(i);if(o)(i=document.createElement("p")).innerText=""+o,t.appendChild(i);(o||n)&&a.appendChild(t)}else console.log("error a")},u.onerror=function(){console.log("error b")},u.send()}}else e.wwwSameTab?(window.location=t,_body.innerHTML="",_body.style.background="#a0a0a0"):_config.isDebug||_config.isSimulator||_config.noViews?(console.log("no referrer"),window.open(t,"_blank","noopener, noreferrer")):window.open(t,"_blank","noopener")}},this.setupMaterials=function(){var e=this,t=0,o=0;if(!e.library.version&&e.isMediaScene&&e.rootMedias.traverse((function(t){t.isMesh&&(t.frustumCulled=!1,e.setupCompositionItemMaterial(t))})),e.isCompScene||(e.object.geometry&&e.setupMaterial(e.object,t),t=1,e.object.traverse((function(n){n.isMesh&&(n.frustumCulled=!1,e.isMediaScene?e.setupCompositionItemMaterial(n):(e.setupModelMaterial(n,t),n.geometry.attributes&&n.geometry.attributes.normal&&(o+=n.geometry.attributes.normal.count))),t++}))),e.isCompScene){e.rootMedias.traverse((function(t){t.isMesh&&(t.frustumCulled=!1,e.setupCompositionItemMaterial(t))}));var n;t=-1;e.rootModels.traverse((function(i){i.isMesh&&((n=i.geometry).attributes&&n.attributes.normal&&(o+=n.attributes.normal.count),i.frustumCulled=!1,e.setupModelMaterial(i,t)),i.isLine&&(i.visible=!1),t++}))}e.tris=parseInt(o/3*10/10)},this.setupMediaMaterial=function(e,t){var o,n,i=this,a=t.mat;if("text"!=t.shape){var s=i.getLibraryItemByUid(t.uid),r=null;for(n=0;n<i.textures.length;n++)if(i.textures[n].uid==t.uid){r=i.textures[n];break}if(r||(console.log("- - - missing texture for media"),i.loadNewTexture(s)),a.chroma||((o=new THREE.MeshBasicMaterial({side:THREE.DoubleSide})).opacity=a.opacity,o.opacity<1&&(o.transparent=!0,o.alphaTest=.02)),a.chroma){var l=new THREE.Color(a.chromaColor),d=a.range,c=a.chromaSmoothness;null==d&&(d=.5),null==c&&(c=7);var u=""+a.opacity;"1"===u&&(u="1.0");const e="\n            #if __VERSION__ == 300\n            out mediump vec2 vUv;\n            #else\n            varying mediump vec2 vUv;\n            #endif\n\n            void main(void) {\n                vUv = uv;\n                mediump vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n                gl_Position = projectionMatrix * mvPosition;\n            }",t="\n            uniform mediump sampler2D in_texture;\n            uniform mediump vec3 color;\n\n            //tolerance of color difference, compared to keyColorObject value\n            uniform mediump float tolerance;\n\n            // smoothness of effect\n            uniform mediump float smoothness;\n\n            // main opacity\n            uniform mediump float opacity;\n            #if __VERSION__ == 300\n            in mediump vec2 vUv;\n            #else\n            varying mediump vec2 vUv;\n            #endif\n\n            void main(void)\n            {\n                mediump vec3 tColor = vec3(0);\n                #if __VERSION__ == 300\n                tColor = texture(in_texture, vUv ).rgb;\n                #else\n                tColor = texture2D(in_texture, vUv ).rgb;\n                #endif\n                mediump float a = min((length(tColor - color) - tolerance) * smoothness, 1.0);\n                a *= opacity;\n                if(a < 0.05) discard;\n                #if __VERSION__ == 300\n                pc_fragColor = vec4(tColor, a);\n                #else\n                gl_FragColor = vec4(tColor, a);\n                #endif\n            }";o=new THREE.ShaderMaterial({uniforms:{in_texture:{value:r},color:{value:l},tolerance:{value:d},smoothness:{value:c},opacity:{value:u}},vertexShader:e,fragmentShader:t,transparent:!0,side:THREE.DoubleSide})}if(r){r.wrapS=r.wrapT=THREE.ClampToEdgeWrapping;o.map=i.setupMaterialMap(e,o,r,s,!1),e.material=o}else console.log("texture is null - object not visible")}else{if((o=[])[0]=new THREE.MeshBasicMaterial({color:a.color}),1!=a.opacity&&(o[0].transparent=!0,o[0].opacity=1*a.opacity),t.background.enabled){var m=t.background.mat;o[1]=new THREE.MeshBasicMaterial({color:m.color,side:THREE.DoubleSide}),1!=m.opacity&&(o[1].transparent=!0,o[1].opacity=1*m.opacity)}else o[1]=new THREE.MeshBasicMaterial({side:THREE.DoubleSide}),o[1].transparent=!0,o[1].opacity=0,o[1].alphaTest=.02;e.material=o}},this.setupModelMaterial=function(e,t){var o,n,i=this,a=i.data.materialsLinks,s=[],r=!1;for(o=0;o<a.length;o++){if(a[o].name){if(a[o].name==e.name){r=!0,s[0]=a[o].mats[0].m;break}}else if(null==!Array.isArray(a[o].mats)){if(a[o].id==t){r=!0,s[0]=a[o].m;break}}else if(a[o].id==t){for(r=!0,n=0;n<a[o].mats.length;n++)s[n]=a[o].mats[n].m;break}}if(0==r){console.log("!! no matching ID for "+e.name+" "+t+" > fixing it");var l={id:t,mats:[{m:0}]};i.data.materialsLinks.push(l),s[0]=0}i.setupMaterial(e,s)},this.setupCompositionItemMaterial=function(e){var t=this,o=e.itemIndex,n=t.data.composition[t.currentMediaPage].items[o];if(t.library.version>0)t.setupMediaMaterial(e,n);else{var i=[1*n.matIndex];t.setupMaterial(e,i)}},this.setupMaterial=function(e,t){var o,n,i,a,s,r,l,d,c,u,m,p,h,g,v,f,b,y,x=this,w=[],T=!1,E=1,S=x.data.model.flipTextures;if("gltf"!=x.data.type&&(S=!1),x.isCompScene&&x.data.composition[x.currentMediaPage].models){var _=x.data.composition[x.currentMediaPage].models[0];S=x.getLibraryItemByUid(_.uid).flipTextures}e.geometry.groups&&(E=e.geometry.groups.length),"SkinnedMesh"==e.type&&(T=!0);var M=t.length;for(E>M&&(M=E),o=0;o<M;o++)if(void 0===(n=t[o])&&(n=0),n>=x.data.materials.length&&(addToLog("matIndex is too high B, using 0 :"+n+" : "+x.data.materials.length),n=0),i=x.data.materials[n]){if((a=i.type)||(a="MeshBasicMaterial"),null==(s=i.shininess)&&(s=0),d=i.color,c=i.specular,u=i.reflectivity,m=i.doubleSide,p=i.colorMap,h=i.normalMap,g=i.metalnessMap,v=i.emissiveMap,i.colorMap&&i.colorMap.uid&&(p=x.getLibraryItemByUid(i.colorMap.uid)),i.normalMap&&i.normalMap.uid&&(h=x.getLibraryItemByUid(i.normalMap.uid)),i.metalnessMap&&i.metalnessMap.uid&&(g=x.getLibraryItemByUid(i.metalnessMap.uid)),i.emissiveMap&&i.emissiveMap.uid&&(v=x.getLibraryItemByUid(i.emissiveMap.uid)),r=i.roughness,l=i.metalness,f=i.chroma,b=i.opacity,y=i.transparent,"LineBasicMaterial"==a&&(a="MeshPhongMaterial"),null==r&&(r=1,l=1),null==c&&(c="#111111"),null==u&&(u=.5),null==b&&(b=1),"MeshStandardMaterial"==a&&(w[o]=new THREE.MeshStandardMaterial({color:d,skinning:T,roughness:r,metalness:l})),"MeshPhongMaterial"==a&&(w[o]=new THREE.MeshPhongMaterial({color:d,specular:c,reflectivity:u,shininess:s,skinning:T})),"MeshLambertMaterial"==a&&(w[o]=new THREE.MeshLambertMaterial({color:d,skinning:T})),"MeshBasicMaterial"!=a||f||(w[o]=new THREE.MeshBasicMaterial({color:d,skinning:T})),"MeshToonMaterial"==a&&(w[o]=new THREE.MeshToonMaterial({color:d,specular:c,shininess:s,skinning:T})),"VideoMaterial"==a){if(!x.isCompScene){var C=$('.videoTexture[name="'+i.name+'"]').eq(0);null!=C[0]?C[0].muted=!i.audio:console.log("videoDom[0] is undefined - audio")}f||(w[o]=new THREE.MeshBasicMaterial({color:d,skinning:T}))}if(f&&("MeshBasicMaterial"==a||"VideoMaterial"==a)){var L=null;x.isCompScene?i.colorMap&&(L=x.getTextureByUid(i.colorMap.uid)):L=x.textures[n].colorMap;var R=new THREE.Color(i.chromaColor),k=i.range,A=i.chromaSmoothness;null==k&&(k=.5),null==A&&(A=7);var I=""+i.opacity;"1"===I&&(I="1.0"),y=!0;const e="\n\t            #if __VERSION__ == 300\n\t            out mediump vec2 vUv;\n\t            #else\n\t            varying mediump vec2 vUv;\n\t            #endif\n\n\t            void main(void) {\n\t                vUv = uv;\n\t                mediump vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\t                gl_Position = projectionMatrix * mvPosition;\n\t            }",t="\n\t            uniform mediump sampler2D in_texture;\n\t            uniform mediump vec3 color;\n\n\t            //tolerance of color difference, compared to keyColorObject value\n\t            uniform mediump float tolerance;\n\n\t            // smoothness of effect\n\t            uniform mediump float smoothness;\n\n\t            // main opacity\n\t            uniform mediump float opacity;\n\t            #if __VERSION__ == 300\n\t            in mediump vec2 vUv;\n\t            #else\n\t            varying mediump vec2 vUv;\n\t            #endif\n\n\t            void main(void)\n\t            {\n\t                mediump vec3 tColor = vec3(0);\n\t                #if __VERSION__ == 300\n\t                tColor = texture(in_texture, vUv ).rgb;\n\t                #else\n\t                tColor = texture2D(in_texture, vUv ).rgb;\n\t                #endif\n\t                mediump float a = min((length(tColor - color) - tolerance) * smoothness, 1.0);\n\t                a *= opacity;\n\t                if(a < 0.05) discard;\n\t                #if __VERSION__ == 300\n\t                pc_fragColor = vec4(tColor, a);\n\t                #else\n\t                gl_FragColor = vec4(tColor, a);\n\t                #endif\n\t            }";w[o]=new THREE.ShaderMaterial({uniforms:{in_texture:{value:L},color:{value:R},tolerance:{value:k},smoothness:{value:A},opacity:{value:I}},vertexShader:e,fragmentShader:t,transparent:!0})}if("MaskMaterial"==a){w[o]=new THREE.MeshBasicMaterial({color:d,skinning:T,colorWrite:!1});var D,B,H,O=i.maskedObject;if(O)for(e.renderOrder=100,D=0;D<O.length;D++)-1!=(B=O[D].idMesh)&&(H=x.findMeshByIndex(B))&&(H.renderOrder=101);b=1}w[o].alphaTest=.02,w[o].name=i.name,w[o].opacity=b,null!=i.originalIndex&&(w[o].originalIndex=i.originalIndex),w[o].side=1==m?THREE.DoubleSide:THREE.FrontSide,f||(w[o].transparent=!1),1!=y&&1==b||(w[o].transparent=!0);var P,N=null;p&&p.embed?(P=x.getModelTexture(n,"color"))&&(N=P.map):x.library.data?p&&(N=x.getTextureByUid(p.uid)):x.textures[n]&&(N=x.textures[n].colorMap),w[o].map=x.setupMaterialMap(e,w[o],N,p,S),w[o].map&&void 0===w[o].map.image&&(w[o].map=null),h&&h.embed?(P=x.getModelTexture(n,"normal"))&&(N=P.map):x.library.data?h&&(N=x.getTextureByUid(h.uid)):x.textures[n]&&(N=x.textures[n].normalMap),w[o].normalMap=x.setupMaterialMap(e,w[o],N,h,S),"MeshStandardMaterial"==a&&(g&&g.embed?(P=x.getModelTexture(n,"metalness"))&&(N=P.map):x.library.data?g&&(N=x.getTextureByUid(g.uid)):x.textures[n]&&(N=x.textures[n].metalnessMap),w[o].metalnessMap=x.setupMaterialMap(e,w[o],N,g,S),w[o].roughnessMap=x.setupMaterialMap(e,w[o],N,g,S),v&&v.embed?(console.log("embed emissive for "+n),(P=x.getModelTexture(n,"emissive"))&&(N=P.map)):x.library.data?v&&(N=x.getTextureByUid(v.uid)):x.textures[n]&&(N=x.textures[n].emissiveMap),w[o].emissiveMap=x.setupMaterialMap(e,w[o],N,v,S),w[o].emissiveMap&&(console.log("set emissive 1 1 1"),w[o].emissive={r:1,g:1,b:1}))}var V=!1;e.geometry.groups&&e.geometry.groups.length>0&&(V=!0),V&&t.length>1?e.material=w:null==w[0]?console.log("---\x3e material undef"):e.material=w[0]},this.getTextureByUid=function(e){var t,o=this;for(t=0;t<o.textures.length;t++)if(o.textures[t].uid==e)return o.textures[t];return null},this.getLibraryItemByUid=function(e){return this.library.getItemByUid(e)},this.getModelTexture=function(e,t){var o,n=this;if(!n.modelTextures)return null;for(o=0;o<n.modelTextures.length;o++)if(n.modelTextures[o].indexMat==e&&n.modelTextures[o].type==t)return n.modelTextures[o];return null},this.setupMaterialMap=function(e,t,o,n,i){if(!n)return null;if(!(n.embed||this.library||null!=n.url&&""!=n.url))return null;var a=null;if(n.embed){a=o,e.material.transparent&&(t.transparent=!0)}else{if(this.library)n.useAlpha&&"image"==n.type&&(t.transparent=!0);else{var s=n.url.substr(n.url.lastIndexOf(".")+1);1==n.useAlpha&&"mp4"!=s&&(t.transparent=!0)}a=o}return a&&(a.flipY=!i,a.needsUpdate=!0),a},this.updateMaterial=function(e){var t=this,o=0,n=[];t.object.geometry&&(n=t.getMaterialsIndexesByMesh(t.object,o),n.includes(e,0)&&t.setupMaterial(t.object,n)),o=1,t.object.traverse((function(i){i.geometry&&(n=t.getMaterialsIndexesByMesh(i,o),n.includes(e,0)&&t.setupMaterial(i,n)),o++}))},this.getMaterialsIndexesByMesh=function(t,o){var n,i,a,s=[],r=this.data.materialsLinks,l=[];for(n=0;n<r.length;n++)if(null==!Array.isArray(r[n].mats));else if(r[n].id==o&&r[n].mats){for(i=0;i<r[n].mats.length;i++)l[i]=r[n].mats[i].m;break}for(n=0;n<l.length;n++)a=0,n<l.length&&(a=l[n]),a>=e.materials.length&&(a=0),s.push(a);return s},this.findObjectByIndex=function(e){console.log("OBS: findObjectByIndex"),this.findMeshByIndex(e)},this.findMeshByIndex=function(e){var t=[];return this.object.traverse((function(e){e.geometry&&t.push(e)})),t[e]},this.setupLighting=function(){var e=this;if(addToLog("-> SETUP lights"),!e.isMediaScene)if(e.rootLighting)console.log("lights already setup");else{var t=e.mainLighting,o=e.lightingARVR;if(t){if(e.object){var n=t.enableModelLights;e.object.traverse((function(e){e.isLight&&(e.visible=n)}))}if(!t.unlit){e.rootLighting=new THREE.Group,e.rootLighting.name="rootLighting",e.isCompScene?e.rootComposition.add(e.rootLighting):e.rootXR.add(e.rootLighting),e.ambientLight=new THREE.AmbientLight(o.ambient.color,o.ambient.intensity),e.rootLighting.add(e.ambientLight);var i,a,s=e.rootXR.scale.x;_body.classList.contains("nft")&&(s=10),_config.isDebug&&console.log("dist scale "+s);for(i=0;i<3;i++)a=o.lights[i],e.light[i]=new THREE.PointLight(a.color,a.intensity,a.distance*s),e.light[i].position.set(a.position.x,a.position.y,a.position.z),e.rootLighting.add(e.light[i]),_config.isDebug&&(_app.scene3&&_app.scene3.add(new THREE.PointLightHelper(e.light[i],.2)),_app.scene&&_app.scene.add(new THREE.PointLightHelper(e.light[i],.2)))}}}},this.removeLights=function(){var e=this;if(e.rootLighting){for(console.log("clear lights");e.rootLighting.children.length>0;)e.rootLighting.remove(e.rootLighting.children[0]);e.rootXR.remove(e.rootLighting)}e.rootLighting=null},this.setupEnvMap=function(){var e=this;if(null!=e.settings.envMap){var t=e.object,o=e.settings.envMap.index;if(t)if(0!=o)if(_app.renderer){var n=_rootDirectory+"assets/textures/envmap"+o+".jpg";e.envMap=(new THREE.TextureLoader).load(n,(function(o){var n=null;THREE.REVISION>=123?e.envMap=new THREE.WebGLCubeRenderTarget(o.image.height).fromEquirectangularTexture(_app.renderer,o).texture:e.envMap.mapping=THREE.SphericalReflectionMapping,t.geometry&&(n=t.material,Array.isArray(n)?n.forEach((function(e){i(e)})):i(n)),t.traverse((function(e){e.geometry&&(n=e.material,Array.isArray(n)?n.forEach((function(e){i(e)})):i(n))}))}))}else console.log("setupEnvMap -> no renderer -> NFT scene?");else e.envMap=null}function i(t){var o=t.type;t.envMap="MeshBasicMaterial"==o||"VideoMaterial"==o||"MeshToonMaterial"==o?null:e.envMap,t.needsUpdate=!0}},this.setupAnimations=function(){var e=this;e.animations&&(e.mixer=new THREE.AnimationMixer(e.object),e.mixer.addEventListener("loop",onLoopAction),e.mixer.addEventListener("finished",onFinishedAction))},this.playAnimation=function(e,t,o=!0){if(-1!=e){var n=this,i=n.mixer;if(i){if(o&&i.stopAllAction(),n.animations&&!(e>=n.animations.length)){var a=i.clipAction(n.animations[e]);a.time=0,t||(a.loop=THREE.LoopOnce,a.clampWhenFinished=!0),a.paused=!1,a.play()}}else console.log("mixer is NULL")}},this.loop=function(e){var t=this;t.mixer&&t.mixer.update(e),t.modulesEngine.loop()},this.rayCast=function(e){var t=this,o=(_app.renderer,_app.camera),n=new THREE.Vector2,i=!1;_app.xr&&_app.isInARSession&&(i=!0),_config.isSimulator||"image"==t.trackingMode&&(_body.classList.contains("nft")&&_nft&&(_nft.renderer,o=_nft.camera),o||(o=_arScene.camera));var a=!1;_body.classList.contains("p")&&_body.classList.contains("fid")&&(a=!0);var s=t.threejsCanvas;s.getBoundingClientRect().width,s.offsetWidth;a&&(s.getBoundingClientRect().height,s.offsetWidth);var r=e.clientX,l=e.clientY,d={x:parseInt(100*(r/window.innerWidth*2-1))/100,y:-1*parseInt(100*(l/window.innerHeight*2-1))/100};if(i&&(d.x=r,d.y=l),i){n.x=d.x,n.y=d.y;var c=s.clientWidth/window.innerWidth,u=s.clientHeight/window.innerHeight;n.x*=c,n.y*=u}if(a){n.x=d.y,n.y=d.x,n.y=-1*n.y;c=s.clientHeight/window.innerWidth,u=s.clientWidth/window.innerHeight;n.x*=1.15,n.y/=c}if(!a&&!i){var m=s.getBoundingClientRect().width/s.offsetWidth,p=s.getBoundingClientRect().height/s.offsetHeight;c=s.clientWidth*m/window.innerWidth,u=s.clientHeight*p/window.innerHeight;n.x=d.x,n.y=d.y,n.x/=c,n.y/=u}if("image"==t.trackingMode){if(!t.rootOrientation.visible)return;if(!_body.classList.contains("m")&&!_body.classList.contains("keep"))return void addToLog("no M class")}var h=!0;"slam"==t.trackingMode&&t.isCompScene&&_app.rootOrientation&&(_app.rootOrientation.visible||(h=!1)),t.raycaster.setFromCamera(n,o);var g=function(e){var t=!0;return!!e.visible&&(e.traverseAncestors(e=>{e.visible||(t=!1)}),t)},v=[];h&&(t.rootModel.traverse((function(e){e.isMesh&&g(e)&&v.push(e)})),t.rootMedias.traverse((function(e){e.isMesh&&g(e)&&v.push(e)}))),_app.reticle&&v.push(_app.reticle);var f=t.raycaster.intersectObjects(v);if(f.length>0){var b=f[0].object;if(b&&b==_app.reticle&&_app.tapReticle(),t.isCompScene&&t.rayCastOnMesh(b),(t.isCompScene||t.isMediaScene)&&t.rayCastComposition(b.itemIndex,b),t.isModelScene){var y=t.modulesEngine.modulesData.states;y&&y.enabled&&t.modulesEngine.rayCastOnObject(b)}}},this.rayCastComposition=function(e,t){var o=this;if(null!=e){var n=o.data.composition[o.currentMediaPage].items[e].action;n&&n.type&&(o.doAction(n),n.visualFeedback&&"0"!==n.visualFeedback&&o.doVisualFeedBack(t))}},this.rayCastOnMesh=function(e){var t=this;if(t.data.model&&t.data.model[0]&&t.data.model[0].actions){var o,n,i=t.data.model[0].actions;for(o=0;o<i.length;o++)if(n=i[o],t.findMeshByIndex(n.objectIndex)==e&&n&&n.type)return t.doAction(n),void(n.visualFeedback&&"0"!==n.visualFeedback&&t.doVisualFeedBack(e))}},this.doVisualFeedBack=function(e){e.originalScale||(e.originalScale={x:e.scale.x,y:e.scale.y,z:e.scale.z});var t=e.originalScale.x,o=e.originalScale.y,n=e.originalScale.z;e.scale.set(.9*t,.9*o,.9*n),new TWEEN.Tween(e.scale).to({x:t,y:o,z:n},300).start()},this.doAction=function(e){var t=this,o=e.type,n=_app.common;if(o&&""!=o){if("switchState"!=o&&t.gaEvent({event:"button action",event_category:"scene",event_label:o}),"switchState"==o){var i=t.modulesEngine.statesModule;i.buttonAction(i,null,e)}if("textBox"==o){var a=null;if(e.media){var s,r,l=e.media.uid;if(t.isCompScene){for(r=0;r<t.library.length;r++)if((s=t.library[r]).uid==l){a={url:t.projectFolder+s.url,width:s.width,height:s.height};break}}else for(r=0;r<t.data.materials.length;r++){var d=t.data.materials[r];if(d&&d.uid==l&&d.colorMap){a={url:t.projectFolder+d.colorMap.url,width:d.colorMap.width,height:d.colorMap.height};break}}}var c={content:{h2:e.textBoxTitle,p:e.textBoxText,image:a},colors:{textColor:e.textColor,titleColor:e.titleColor,bgColor:e.bgColor},useButton:e.useButton,stateIndex:e.stateIndex};t.openTextBox(c)}var u;if("www"==o&&setTimeout((function(){var o=e.wwwUrl;!o&&e.www&&(o=e.www),t.openLink(e,o)}),100),"email"==o&&setTimeout((function(){t.openLink(e,e.email)}),100),"call"==o)w="tel:"+(w=(w=cleanString(e.callNumber)).replace(/[a-z]/gi,"")),setTimeout((function(){t.openLink(e,w)}),100);if("playVideo"==o)(u=e.uidVideo)&&t.playVideoByUid(u,!0);if("pauseVideo"==o)(u=e.uidVideo)&&t.pauseVideoByUid(u);if("stopVideo"==o)(u=e.uidVideo)&&t.stopVideoByUid(u);if("previousPage"==o){var m=t.data.composition.length;(p=t.currentMediaPage-1)<0&&(p=m-1),t.goToCompositionPage(p)}if("nextPage"==o){var p;m=t.data.composition.length;(p=t.currentMediaPage+1)==m&&(p=0),t.goToCompositionPage(p)}if("page_0"==o&&t.goToCompositionPage(0),"page_1"==o&&t.goToCompositionPage(1),"page_2"==o&&t.goToCompositionPage(2),"page_3"==o&&t.goToCompositionPage(3),"page_4"==o&&t.goToCompositionPage(4),"restartDelays"==o&&t.goToCompositionPage(t.currentMediaPage),"embedVideo"==o){n.pauseLoop(),t.setAudioVolume(0);var h=document.querySelector("#embedContent>div"),g=document.querySelector("#embedContent .b_close"),v=e.embedVideoRatio,f=window.innerWidth/window.innerHeight;(b=e.embedVideoID).length>11&&(b=b.substr(0,11));var b=cleanString(b);v>=f?(T=window.innerWidth-10-4,x=parseInt(T/v)):(x=window.innerHeight-10-4,T=parseInt(x*v)),$("#embedContent").css("display:block").addClass("video"),h.innerHTML='<iframe width="'+T+'" height="'+x+'" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope" allowfullscreen></iframe>';var y="https://www.youtube.com/embed/"+b;e.embedVideoStartTime&&(y+="?start="+1*e.embedVideoStartTime),(E=h.querySelector("iframe")).src=y,g.addEventListener("click",(function e(){n.resumeLoop(),t.setAudioVolume(1),$("#embedContent").css("display:none").removeClass("video"),h.innerHTML="",g.removeEventListener("click",e)}))}if("embedWebsite"==o){h=document.querySelector("#embedContent>div"),g=document.querySelector("#embedContent .b_close");if(!validateURL(w=cleanString(e.embedWebsiteURL)))return;n.pauseLoop(),(T=window.innerWidth-20)<360&&(T=360),T>1500&&(T=1500);var x=window.innerHeight-100;if($("#embedContent").css("display:block").addClass("website"),h.innerHTML='<iframe width="'+T+'" height="'+x+'" frameborder="0" allow="" allowfullscreen></iframe>',"https://www.jotform.text"==w)return addToLog("--\x3e jot form test"),h.innerHTML=t.modulesEngine.jotForm(),void g.addEventListener("click",(function(){n.resumeLoop(),$("#embedContent").css("display:none").removeClass("website"),h.innerHTML=""}));(E=h.querySelector("iframe")).onload=e=>{addToLog("iframe on load")},E.src=w,g.addEventListener("click",(function(){n.resumeLoop(),$("#embedContent").css("display:none").removeClass("website"),h.innerHTML=""}))}if("iframe"==o){var w,T;h=document.querySelector("#embedContent>div"),g=document.querySelector("#embedContent .b_close");if(!validateURL(w=cleanString(e.iframeSrc)))return;n.pauseLoop(),(T=window.innerWidth-20)<360&&(T=360),T>1500&&(T=1500);var E;x=window.innerHeight-100;$("#embedContent").css("display:block").addClass("website"),h.innerHTML='<iframe width="'+T+'" height="'+x+'" frameborder="0" allow="" allowfullscreen></iframe>',(E=h.querySelector("iframe")).src=w,g.addEventListener("click",(function(){n.resumeLoop(),$("#embedContent").css("display:none").removeClass("website"),h.innerHTML=""}))}if("share"==o&&shareScene(),"eShop"==o&&(console.log(e),t.modulesEngine.openEShopModule(e.eShopCode)),"vcf"==o){e.firstName||e.lastName||console.log("vcf: missing first and last name");var S="";S+="BEGIN:VCARD\n",S+="VERSION:3.0\n",e.lastName&&(S+="N:"+e.lastName+";"+e.firstName+"\n"),e.firstName&&(S+="FN:"+e.firstName+" "+e.lastName+"\n"),e.phone&&(S+="TEL;TYPE=WORK;VOICE:"+e.phone+"\n"),e.phoneHome&&(S+="TEL;TYPE=HOME;VOICE:"+e.phoneHome+"\n"),e.companyAddress&&(S+="ADR;TYPE=WORK:;;"+e.companyAddress+"\n");var _=e.companyName;if(_&&(S+="ORG:"+_+"\n"),e.email&&(S+="EMAIL;TYPE=PREF,INTERNET:"+e.email+"\n"),e.www&&(S+="URL:"+e.www+"\n"),e.note&&(S+="NOTE:"+e.note+"\n"),e.role&&(S+="ROLE:"+e.role+"\n"),e.media&&e.media.uid){var M=t.getLibraryItemByUid(e.media.uid);if(M){y=t.projectFolder+M.url;var C=document.createElement("img");C.addEventListener("load",(function(e){var t=function(e){const t=document.createElement("canvas"),o=t.getContext("2d");var n=300*e.height/e.width;return t.width=300,t.height=n,o.drawImage(e,0,0,300,n),t.toDataURL("image/jpeg")}(e.currentTarget);t=t.replace("data:image/jpeg;base64,",""),C=null,S+="PHOTO;TYPE=JPEG;ENCODING=b:"+t+"\n",L()})),C.onerror=function(){console.log("ERROR load vcf image"),L()},C.src=""+y}else L()}else L();function L(){S+="END:VCARD";const t=encodeURIComponent(S);var o="";e.firstName&&(o+=e.firstName+" "),e.lastName&&(o+=e.lastName+"\n"),o+="\n",e.role&&(o+=e.role+"\n"),e.companyName&&(o+=e.companyName+"\n"),o+="\n",e.phone&&(o+=e.phone+"\n"),e.email&&(o+=e.email+"\n"),e.www&&(o+=e.www+"\n"),openModal({h2:"Save new contact?",p:o},{buttons:!0,yesButton:"yes",noButton:"cancel",closeButton:!1,callbackYes:function(){window.open("data:text/vcard;charset=utf-8;urlencoded,"+t)}})}}if(null!=e.sfx){var R=1*e.sfx;R>=0&&t.playSFX(R,!0)}if(null!=e.uidAudio){var k=1*e.uidAudio;k>0&&t.playAudio(k,e.audioLoop)}}},this.gaEvent=function(e){_app.common.gaEvent(e)},this.init()}function onLoopAction(e){var t=_app.activeScene;if(t.modulesEngine){var o=e.action;t.modulesEngine.animationEndEvent(o)}}function onFinishedAction(e){var t=_app.activeScene;if(t.mixer&&t.modulesEngine){var o=e.action;t.modulesEngine.animationEndEvent(o)}}function updateAllMats(){_xr.activeScene.object.traverse((function(e){e.geometry&&e.material&&(e.material.needsUpdate=!0)}))}var _streamW=0,_streamH=0,_xrSession=null,xrRefSpace=null,xrHitTestSource=null,xrViewerSpace=null,_counter=0;function slam(e){var t=this;this.common=new common(this),this.scenesJson=e.scenesData,this.nbScenes=e.scenesData.length,this.currentMode="ar",this.needDeviceOrientationPermission=!1,this.scenes=[],this.indexSceneActive=0,this.indexSceneLoading=0,this.loadingScene=null,this.activeScene=null,this.loopIsPaused=!1,this.clock=null,this.camera=null,this.controls=null,this.fakeGyroCamera=null,this.fakeGyroCameraRotation=[],this.scene3=null,this.renderer=null,this.hookXR=null,this.rootOrientation=null,this.floorRadius=100,this.floorY=-100,this.windowSize=null,this.fingers=[],this.lastTouch={x:0,y:0},this.videoStream=null,this.objectHasBeenAdded=!1,this.positionToLookAt=null,this.xr=!1,this.useReticle=!1,this.reticle=null,this.isInARSession=!1,this.allowFloors=!1,this.allowWalls=!1,this.inOnFloor=!0,this.xrViewerPose=null,this.reticleCube=null,this.gridHelper=null,this.diamonds=[],this.dropDiamonds=!1,this.maxDiamonds=500,this.didDropOnce=!1,this.okToDrop=!1,this.usdzFile=null,this.tracking=null,this.bundle=null,this.isBundle=!1,"bundle"==e.type&&(this.isBundle=1),this.isBundle&&(this.bundle=e.settings.bundle,this.tracking=e.settings.tracking),this.getDistanceXZ=function(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.z-t.z,2))},this.setNewData=function(e){var t=this;0==e&&t.checkDeviceOrientationPermission();var o=t.scenesJson[e];t.indexSceneLoading=e,t.scenes[e]=new scene(o,e,t.currentMode),0==e&&(t.activeScene=t.scenes[0]),t.loadingScene=t.scenes[e]},this.keepInlineScene=function(e){var t=this;console.log("/////////////////////"),console.log("NO NEW SCENE INSTANCE");t.checkDeviceOrientationPermission(),t.indexSceneLoading=0,t.scenes[0]=e[0],t.scenes[0].p_xr=_xr,t.activeScene=t.scenes[0],t.loadingScene=t.scenes[0],t.loadingScene.removeLights(),t.loadingScene.rootXR.rotation.set(THREE.Math.degToRad(90),0,0)},this.checkDeviceOrientationPermission=function(){var e=this;_browser.ios&&("safari"==_browser.name?(12==_browser.version&&_browser.insideIframe&&(e.needDeviceOrientationPermission=!0),_browser.version>=13&&(e.needDeviceOrientationPermission=!0)):e.needDeviceOrientationPermission=!0)},this.askDeviceOrientationPermission=function(){var e=this;addToLog("--\x3e askDeviceOrientationPermission");var t=null;if(_browser.insideIframe)return addToLog("add motion IOS request"),12==_browser.version&&(e.common.closeStartPanel(),e.placeObjectInFront(),t=setTimeout((function(){openModal({h2:"Turn on your motion sensors",p:"Enable device orientation in \nSettings > Safari \n> Motion & Orientation Access"}),$("#alertModal .button").css("display:none")}),1e3)),_browser.version>=13&&e.common.postMessage({request:"motion",version:_browser.version,browserName:_browser.name}),void window.addEventListener("message",(function(o){if(o.data.permission){var n=o.data.permission;e.gotPermissionState(n)}else{if(t){clearTimeout(t);var i=document.getElementById("bgModal");i&&i.parentElement.removeChild(i)}var a=e.controls,s=a.deviceOrientation;a.deviceOrientation=o.data.deviceOrientation,s.alpha=o.data.deviceOrientation.alpha,s.beta=o.data.deviceOrientation.beta,s.gamma=o.data.deviceOrientation.gamma,a.enabled=!0}}),!1);"undefined"!=typeof DeviceOrientationEvent&&("function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((function(t){e.gotPermissionState(t)})).catch(console.error):(console.log("no deviceorientation"),_screens.start.closeStartPanel(!1,!0)))},this.gotPermissionState=function(e){addToLog("got motion perm "+e),_screens.start.closeStartPanel(!1,!0);var t=document.getElementById("bgModal");if(t&&t.parentElement.removeChild(t),"denied"==e)return openModal({p:"The device orientation permission is required,\n please restart your web browser and try again"}),void $("#alertModal .button").css("display:none");this.placeObjectInFront()},this.selectScene=function(e){var t=this;addToLog("- - selectScene "+e),t.indexSceneActive=e,t.activeScene=t.scenes[t.indexSceneActive];var o=t.activeScene;for(t.common.showSkyBox(t.indexSceneActive);t.hookXR.children.length>0;)t.hookXR.remove(t.hookXR.children[0]);t.hookXR.add(o.rootXR);o.rootXR.scale.set(50,50,50),t.placeObjectInFront(),t.positionToLookAt&&(addToLog("rootXR LOOK AT"),o.rootXR.lookAt(t.positionToLookAt.x,t.positionToLookAt.y,t.positionToLookAt.z)),o.setupMainScreen();var n=!0;if(t.xr&&t.useReticle&&(addToLog("DONT"),n=!1),n){o.setActive(!1,!0),o.applyDefaultState()}},this.initScene3=function(){var e=this;if(console.log("%c INIT SCENE3 SLAM --------- ","color: #ff33cc"),_browser.ios&&"safari"==_browser.name){var t=e.loadingScene.library.getUSDZItem();if(t)return e.usdzFile=t.url,void _screens.start.showScreen(!1,!0)}var o=!1,n=e.loadingScene.settings.slam;n.webXR&&n.webXR.enabled&&(o=!0),o?e.checkARSessionSupport().then((function(t){t&&e.initXRAPI(),e.initScene3B()})):e.initScene3B()},this.initScene3B=function(){var e=this;addToLog("-> init Scene3B");var t=e.loadingScene,o=window.innerWidth,n=window.innerHeight;if(null==e.camera){e.common.addWindowEvents(),e.xr?(e.floorRadius=t.settings.slam.distance/100,e.floorY=0):(e.floorRadius=2*t.settings.slam.distance+1,e.floorY=-2*t.settings.slam.position.y),e.scene3=new THREE.Scene;40;if(e.camera=new THREE.PerspectiveCamera(40,o/n,.1,1800),e.scene3.add(e.camera),e.fakeGyroCamera=new THREE.Group,e.scene3.add(e.fakeGyroCamera),addToLog("HISTORY x 4"),e.fakeGyroCameraRotation=[],e.fakeGyroCameraRotation.push({x:0,y:0,z:0}),e.fakeGyroCameraRotation.push({x:0,y:0,z:0}),e.fakeGyroCameraRotation.push({x:0,y:0,z:0}),e.fakeGyroCameraRotation.push({x:0,y:0,z:0}),!e.xr){var i=new THREE.CircleGeometry(e.floorRadius,16);i.rotateX(-Math.PI/2);var a=new THREE.MeshBasicMaterial({color:16773120,opacity:.5,transparent:!0}),s=new THREE.Mesh(i,a);s.name="floor",e.scene3.add(s),_config.isDebug||(s.visible=!1),s.position.set(1,e.floorY,1)}e.rootOrientation=new THREE.Group,e.rootOrientation.name="rootOrientation";if(e.rootOrientation.position.set(0,0,-60),e.hookXR=new THREE.Group,e.hookXR.name="hookXR",e.rootOrientation.add(e.hookXR),e.xr?e.scene3.add(e.rootOrientation):e.camera.add(e.rootOrientation),!e.renderer){!1;var r=!1;"webxrviewer"==_browser.name&&(r=!0);var l=!1;_config.ios||(l=!0);var d={antialias:!0,preserveDrawingBuffer:!0,canvas:_canvas,alpha:r,logarithmicDepthBuffer:false};!l||THREE.REVISION>=123?e.renderer=new THREE.WebGL1Renderer(d):e.renderer=new THREE.WebGLRenderer(d),e.renderer.capabilities.isWebGL2?console.log("WebGL 2"):console.log("WebGL 1"),e.renderer.gammaInput=!1,e.renderer.gammaOutput=!1,e.renderer.toneMapping=THREE.NoToneMapping,e.renderer.toneMappingExposure=1,e.xr&&(e.renderer.xr.enabled=!0);var c=2;if(_browser.desktop&&(c=1),_browser.android)try{parseInt(getAndroidVersion(),10)<8&&(c=1)}catch(e){addToLog("getAndroidVersion error")}e.renderer.setPixelRatio(c),e.renderer.setSize(o,n),e.xr&&(_canvas.style.width=2*o+"px",_canvas.style.height=2*n+"px"),window.addEventListener("resize",(function(){e.resizeCanvas()}))}e.xr||_browser.desktop?(e.hookXR.position.y=-10-e.floorY,e.hookXR.position.z=-20-e.floorRadius):(addToLog("create motion controls"),e.controls=new THREE.DeviceOrientationControls(e.fakeGyroCamera),e.camera.rotation.reorder("YXZ"))}else for(addToLog("-> coming back to XR scene"),e.scene3.remove(e.rootOrientation),e.rootOrientation.position.set(0,0,-60),e.camera.add(e.rootOrientation);e.hookXR.children.length>0;)e.hookXR.remove(e.hookXR.children[0]);_keepComposition?e.allSceneDataLoaded():t.load()},this.openUSDZ=function(){var e=this;addToLog("open usdz");var t=e.activeScene.sceneFolder,o=t+e.usdzFile,n=0,i=e.activeScene.data.modules.gestures;i&&i.enabled&&i.zoom.enabled&&(n=1),o+="#allowsContentScaling="+n+"&canonicalWebPageURL="+_visitUrl;var a=document.createElement("a");a.href=o,a.setAttribute("rel","ar"),a.style.visibility="hidden",document.body.appendChild(a);var s=document.createElement("img");s.src=t+"p256.jpg",a.appendChild(s),a.click()},this.allSceneDataLoaded=function(){var e=this;if(0==e.loadingScene.index)if(_screens.start.isRequired||e.needDeviceOrientationPermission){var t=!1;e.xr&&(t=!0),_screens.start.showScreen(t)}else e.xr||e.start();e.getVideoStream()},this.start=function(){_screens.intro.visible||(this.selectScene(0),this.startLoop())},this.getVideoStream=function(){var e=this;if(e.xr)return addToLog("-> no need for stream"),void e.placeObjectInFront();if(null!=e.videoStream)return addToLog("-> already has stream"),e.placeObjectInFront(),void e.common.loadNextScene();addToLog("-> getVideoStream");e.videoStream=new videoStream("bgVideo",e.camera,0,e.camera,(function(){addToLog("---\x3e getStreamSuccess | ori perm "+e.needDeviceOrientationPermission),_video=e.videoStream.domVideo,e.common.streamResized(),e.needDeviceOrientationPermission||e.common.loadNextScene()}),(function(e){addToLog("getStreamFail"),console.log(e),_checks.showFail("Failed to access the camera",{errorName:e.name,showTryAgain:!0})}),!0)},this.placeObjectInFront=function(){var e=this;addToLog("-> placeObjectInFront "+e.indexSceneLoading+" "+e.objectHasBeenAdded),0==e.indexSceneLoading&&_screens.loading.hideScreen();var t=e.loadingScene,o=e.rootOrientation;if(o.rotation.set(0,0,0),e.xr)t.rootXR.rotation.set(0,0,0);else{if(t.isMediaScene)t.rootModel.rotation.set(0,0,0),t.settings.slam.vertical&&t.rootModel.children[0].rotateX(Math.PI/2);else if(t.isCompScene)t.settings.slam.vertical&&(t.rootComposition.rotation.set(0,0,0),t.rootComposition.rotateX(Math.PI/2));else{var n=t.data.transform[e.currentMode].rotation;t.rootModel.rotation.set(THREE.Math.degToRad(n.x),THREE.Math.degToRad(n.y),THREE.Math.degToRad(n.z))}e.objectHasBeenAdded||(e.objectHasBeenAdded=!0,o.visible=!1,setTimeout((function(){o.visible=!0,THREE.SceneUtils.detach(o,e.camera,e.scene3),e.camera.updateMatrixWorld(),o.position.y=e.floorY+.01;var t=e.getDistanceXZ(e.camera.position,o.position);0==t&&(alert("distance is zero -> has not been rendered yet?"),console.log(e.camera.position),console.log(o.position));var n=t/e.floorRadius;o.position.x/=n,o.position.z/=n,e.positionToLookAt={x:0,y:e.floorY,z:0},null==e.hookXR.children[0]&&console.log("c.hookXR.children[0] is undef"),e.hookXR.children[0].lookAt(e.positionToLookAt.x,e.positionToLookAt.y,e.positionToLookAt.z)}),500))}},this.resizeCanvas=function(){var e=this;if(!e.loopIsPaused)if(e.xr)console.log("xr session -> no resize");else{_browser.ios&&null!=_video&&_video.play();var t=window.innerWidth,o=window.innerHeight,n=t/o,i=640/480,a="landscape";_streamW<_streamH&&(a="portrait"),"portrait"===a?(_body.classList.add("p"),i=.75):_body.classList.remove("p");var s=t,r=s/i;n<i&&(s=(r=o)*i),s=parseInt(s),r=parseInt(r),e.renderer.setSize(parseInt(s/1),parseInt(r/1),!1),_canvas.style.width=s+"px",_canvas.style.height=r+"px",e.camera.aspect=s/r,e.camera.updateProjectionMatrix()}},this.startLoop=function(){var e=this;if(e.xr||e.activeScene.applyDefaultState(),null==e.clock){e.clock=new THREE.Clock;setInterval((function(){e.common.streamResized()}),1e3);e.controls&&e.controls.update();e.renderer.setAnimationLoop((function(){if(stats&&stats.begin(),!e.loopIsPaused){var t=e.clock.getDelta();if(e.controls){e.controls.update(),e.fakeGyroCameraRotation.unshift({x:e.fakeGyroCamera.rotation.x,y:e.fakeGyroCamera.rotation.y,z:e.fakeGyroCamera.rotation.z}),e.fakeGyroCameraRotation.pop();var o=e.fakeGyroCameraRotation[0],n=new THREE.Vector3(o.x,o.y,o.z),i=e.fakeGyroCameraRotation[1],a=new THREE.Vector3(i.x,i.y,i.z),s=e.fakeGyroCameraRotation[2],r=new THREE.Vector3(s.x,s.y,s.z),l=e.fakeGyroCameraRotation[3],d=new THREE.Vector3(l.x,l.y,l.z),c=new THREE.Vector3;c=n.lerp(a,.5);var u=new THREE.Vector3;u=r.lerp(d,.5);var m=new THREE.Vector3;m=c.lerp(u,.5),e.camera.rotation.set(m.x,m.y,m.z)}e.activeScene.loop(t),TWEEN.update(),e.renderer.render(e.scene3,e.camera)}stats&&stats.end()}))}},this.checkARSessionSupport=async function(){if(_browser.desktop)return!1;if(!_browser.xr)return!1;return!!await navigator.xr.isSessionSupported("immersive-ar")},this.initXRAPI=function(){var e=this;addToLog("-> initXRAPI and set .xr flag");var t=e.loadingScene.settings.slam.webXR;if(void 0!==t.useReticle&&(e.useReticle=t.useReticle),void 0!==t.allowFloors&&(e.allowFloors=t.allowFloors),void 0!==t.allowWalls&&(e.allowWalls=t.allowWalls),e.xr=!0,e.loadingScene.needStartPanel(),e.useReticle){var o=document.createElement("span");o.id="b_reticle",document.querySelector("footer").prepend(o),o.addEventListener("click",(function(){e.reticle&&(e.reticle.visible=!e.reticle.visible)}))}},this.immersiveAR=async function(){var e=this,t=document.querySelector("#sessionLoader");t||((t=document.createElement("div")).id="sessionLoader",_body.appendChild(t)),$("#sessionLoader").css("display:block;");if(_xrSession)return addToLog("session not null -> will close it"),void e.closeSession();if(_config.isDebug&&!e.gridHelper){e.gridHelper=new THREE.GridHelper(8,16,16777215),e.gridHelper.name="gridHelper",e.gridHelper.rotateY(-Math.PI/2),e.scene3.add(e.gridHelper)}if(e.useReticle){var o=1/12,n=new THREE.RingGeometry(.8*o,o,64);n.rotateX(-Math.PI/2);var i=new THREE.CircleGeometry(.2*o,32);i.rotateX(-Math.PI/2);var a,s=new THREE.CircleGeometry(.125,6);s.rotateX(-Math.PI/2),s.translate(0,-.01,0);var r=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide,transparent:!0}),l=new THREE.MeshBasicMaterial({opacity:0,transparent:!0,alphaTest:0,depthWrite:!1,depthTest:!1});if(THREE.REVISION<=123)n.faces.forEach((function(e){e.materialIndex=0})),i.faces.forEach((function(e){e.materialIndex=0})),s.faces.forEach((function(e){e.materialIndex=1})),(a=new THREE.Geometry).mergeMesh(new THREE.Mesh(n)),a.mergeMesh(new THREE.Mesh(i)),a.mergeMesh(new THREE.Mesh(s)),a.mergeVertices(),e.reticle=new THREE.Mesh(a,[r,l]);else{const t=[n.toNonIndexed(),i.toNonIndexed(),s.toNonIndexed()];(a=THREE.BufferGeometryUtils.mergeBufferGeometries(t,!0)).groupsNeedUpdate=!0;const o=[r,r,l];e.reticle=new THREE.Mesh(a,o)}e.reticle.renderOrder=-1,e.reticle.name="reticle",e.scene3.add(e.reticle);var d=new THREE.BoxGeometry(.02,.02,.02),c=new THREE.MeshNormalMaterial;e.reticleCube=new THREE.Mesh(d,c),e.reticleCube.visible=!1,e.reticle.add(e.reticleCube),e.reticleCube.position.set(0,.2,0);var u,m=e.loadingScene.settings.slam.webXR,p="Scan around you",h="Tap the ring";void 0!==m.textScan&&(p=m.textScan),void 0!==m.textTap&&(h=m.textTap),(u=document.createElement("p")).id="scanAround",u.textContent=p,_body.appendChild(u),(u=document.createElement("p")).id="tapReticle",u.textContent=h,_body.appendChild(u)}var g={requiredFeatures:["local-floor","hit-test"],optionalFeatures:["bounded-floor"]},v=!1;if("chrome"==_browser.name&&_browser.version>=83&&!_browser.insideIframe&&(v=!0),"chrome"==_browser.name&&_browser.version>=86&&(v=!0),v){addToLog("add dom overlay");var f=document.body;f.style.background="none",_canvas.style.visibility="hidden",g={requiredFeatures:["local-floor","hit-test"],optionalFeatures:["bounded-floor","dom-overlay"],domOverlay:{root:f}}}navigator.xr.requestSession("immersive-ar",g).then(t=>{_xrSession=t,t.addEventListener("end",e.onSessionEnded),t.addEventListener("select",e.onSelect),t.addEventListener("selectend",e.onSelectEnd),e.onSessionStarted(_xrSession)},(function(e){addToLog("error request session"),console.log("-> error request session ++"),console.log(e),console.log("e.name"),console.log(e.name);_screens.error.showScreen({h:"Permission error",text:"To continue, allow 'augmented reality' in the website settings.\n\nTap the &#128274; icon to edit those settings.\n\nThen refresh the page."})}))},this.onSelect=function(e){var o=t,n={clientX:e.inputSource.gamepad.axes[0],clientY:-1*e.inputSource.gamepad.axes[1]};o.activeScene.rayCast(n)},this.onSelectEnd=function(e){},this.tapReticle=function(){var e=this;if(addToLog("tap reticle Floor "+e.inOnFloor),e.xrViewerPose){var t=e.activeScene,o=e.reticle,n=e.rootOrientation,i=t.rootComposition;if(n.position.copy(o.position),n.visible=!0,e.inOnFloor){var a=new THREE.Vector3;n.getWorldPosition(a);var s=e.xrViewerPose.transform.position,r=new THREE.Vector3(s.x,a.y,s.z);i.lookAt(r.x,r.y,r.z),t.settings.slam.vertical&&i.rotateX(Math.PI/2)}else{a=new THREE.Vector3;e.reticleCube.getWorldPosition(a),i.rotation.set(0,0,0),i.lookAt(a.x,a.y,a.z),i.rotateX(Math.PI/2)}t.setActive(!1,!0),t.applyDefaultState();o.scale.set(1.2,1.2,1.2),new TWEEN.Tween(o.scale).to({x:1/4,y:1/4,z:1/4},400).start(),setTimeout((function(){o.visible=!1}),400),e.didDropOnce=!0,$(".module.statesModule.activeScene").css("display:block;"),$("#scanAround").css("display:none;")}},this.clearDiamonds=function(){var e=this;for(console.log("clear diamonds");e.diamonds.length;){var t=e.diamonds[e.diamonds.length-1];e.scene3.remove(t),e.diamonds.pop()}},this.onSessionStarted=function(e){var t=this;t.renderer.xr.setSession(e),t.clearDiamonds(),addToLog("xr session started"),t.didDropOnce=!1,t.selectScene(t.activeScene.index),t.startLoop(),$("body").addClass("webXRSession"),t.isInARSession=!0,setTimeout((function(){$("#sessionLoader").css("display:none;")}),1e3);var o=t.floorRadius;t.useReticle&&(e.requestReferenceSpace("viewer").then(t=>{xrViewerSpace=t,e.requestHitTestSource({space:xrViewerSpace}).then(e=>{xrHitTestSource=e})}),e.requestReferenceSpace("local-floor").then(o=>{xrRefSpace=o,e.requestAnimationFrame(t.onXRFrame)})),t.rootOrientation.position.set(0,0,-1*o),t.hookXR.position.set(0,0,0);var n=.0046;t.hookXR.scale.set(n,n,n),t.useReticle&&(t.rootOrientation.visible=!1,$(".module.statesModule.activeScene").css("display:none;"),$("#scanAround").css("display:block;"),$("#tapReticle").css("display:none;"))},this.onSessionEnded=function(){var e=t;addToLog("- - - - - xr session ended - - - - -"),$("body").removeClass("webXRSession"),$("#scanAround, #tapReticle").css("display:none;"),$("#sessionLoader").css("display:none;"),e.isInARSession=!1,e.scene3.remove(e.reticle),e.reticle=null,e.activeScene.stopAudio(),e.common.pauseAllVideoTextures(!0),_xrSession=null,_config.isPlayer?e.switchTo3D():_screens.start.showScreen(!0,!1)},this.closeSession=async function(e){console.log("* * * * close session * * * *"),_xrSession&&await _xrSession.end()},this.onXRFrame=function(e,o){var n=t;o.session.requestAnimationFrame(n.onXRFrame),n.xrViewerPose=o.getViewerPose(xrRefSpace);var i=n.reticle;if(n.okToDrop=!1,xrHitTestSource&&n.xrViewerPose){let e=o.getHitTestResults(xrHitTestSource);if(0==e.length&&$("#tapReticle").css("display:none;"),e.length>0){let t=e[0].getPose(xrRefSpace);var a=t.transform.position,s=t.transform.orientation;i.position.copy(a),i.quaternion.set(s.x,s.y,s.z,s.w);var r={x:THREE.Math.radToDeg(i.rotation.x),y:THREE.Math.radToDeg(i.rotation.y),z:THREE.Math.radToDeg(i.rotation.z)},l=!1;if((Math.abs(r.x)>1||Math.abs(r.z)>1)&&(l=!0),-180==parseInt(r.x)&&-180==parseInt(r.z)&&(l=!1),!l&&n.allowFloors&&(n.okToDrop=!0),l&&n.allowWalls&&(n.okToDrop=!0),l||n.gridHelper&&n.gridHelper.position.set(n.gridHelper.position.x,a.y,n.gridHelper.position.z),n.inOnFloor=!l,n.rootOrientation.visible?$("#tapReticle").css("display:none;"):($("#scanAround").css("display:none;"),$("#tapReticle").css("display:block;")),_config.isDebug&&$("#tapReticle").text(parseInt(r.x)+" "+parseInt(r.y)+" "+parseInt(r.z)),n.dropDiamonds&&_counter++,_counter>=10&&n.dropDiamonds){_counter=0;var d=new THREE.PlaneGeometry(.05,.05);d.rotateX(-Math.PI/2);var c=new THREE.MeshBasicMaterial({color:13402240});l||(c.color=8440960);var u=new THREE.Mesh(d,c);u.name="diamond",n.diamonds.push(u),n.scene3.add(u),u.position.copy(a),u.quaternion.set(s.x,s.y,s.z,s.w),n.diamonds.length>n.maxDiamonds&&(n.scene3.remove(n.diamonds[0]),n.diamonds.shift())}}}n.okToDrop?(i.scale.set(1,1,1),n.didDropOnce&&$("#b_reticle").css("visibility:visible")):(i.scale.set(.01,.01,.01),$("#b_reticle").css("visibility:hidden"))},this.switchTo3D=function(){addToLog("SLAM back to 3D"),_screens.start.closeStartPanel(!1,!1),this.loopIsPaused=!0,_canvas.style.visibility="visible",_keepComposition=!0,_isInline=!0,startAR(0,_mainData)}}class common{constructor(e){this.xr=e}pauseLoop(){this.xr.loopIsPaused=!0,this.pauseAllVideoTextures(!0)}resumeLoop(){var e=this.xr;e.loopIsPaused=!1,e.activeScene.playSceneVideos()}pauseAllVideoTextures(e){var t=this.xr,o=document.querySelectorAll(".videoTexture");if(o&&o.length){var n,i=document.querySelector('.videoTexture[data-scene="'+t.indexSceneActive+'"]');for(n=0;n<o.length;n++)!e&&t.activeScene.settings.keepVisible&&o[n]==i||o[n].pause()}}showSkyBox(e){var t,o,n=this.xr;for(t=0;t<n.scenes.length;t++)(o=n.scenes[t].skyBox)&&(o.visible=t==e)}setOrientation(e){_isVertical=e,_isVertical?($("#h").removeClass("active"),$("#v").addClass("active")):($("#h").addClass("active"),$("#v").removeClass("active"));var t=this.xr,o=t.activeScene,n=o.settings;o.markerOrientationIsVertical=_isVertical;var i=1;_isNFT&&!_config.isPreview&&(i=10);var a,s,r=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3(i,i,i),c=n.verticalOffset;if(null==c&&(c=0),c*=i,_isVertical){r=new THREE.Vector3(0,-.5*i+c/10,.5*i);var u=-90;if(1==n.invertVertical&&(u=90),l=new THREE.Vector3(THREE.Math.degToRad(u),0,0),o.isMediaScene){r.y+=.5,r.z=.5}}for(a=0;a<t.scenes.length;a++)if(s=t.scenes[a].rootOrientation)new TWEEN.Tween(s.position).to(r,200).start(),new TWEEN.Tween(s.rotation).to(l,200).start(),new TWEEN.Tween(s.scale).to(d,200).start()}switchTo3D(){var e=this.xr;addToLog("x x x x ANY back to 3D x x x x"),this.closeStartPanel(!1,!1),e.videoStream&&(console.log("WILL STOP stream"),e.videoStream.stop()),"image"==e.activeScene.trackingMode&&(console.log("WILL STOP stream"),e.stop()),e.needDeviceOrientationPermission&&(console.log("WILL STOP motion"),this.postMessage({request:"stopMotion"})),e.loopIsPaused=!0,_canvas.style.visibility="visible",_keepComposition=!0,_isInline=!0,startAR(0,_mainData)}showUpdateMarkerPreview(){this.xr.activeScene.markerHelper.updateHint()}loadNextScene(){var e=this.xr;e.indexSceneLoading+1<e.nbScenes?(e.indexSceneLoading++,e.setNewData(e.indexSceneLoading),e.loadingScene.load()):addToLog("ALL scenes loaded")}streamResized(){var e=this.xr;_video&&_streamW!=_video.videoWidth&&(addToLog(">> com str Resized "+_video.videoWidth+" x "+_video.videoHeight),_streamW=_video.videoWidth,_streamH=_video.videoHeight,_video.width=_streamW,_video.height=_streamH,e.resizeCanvas())}addWindowEvents(){var e=this.xr,t=this;window.addEventListener("blur",(function(o){e.scenes.forEach((function(e){e.stopAudios()})),t.pauseAllVideoTextures(!0)}),!1),window.addEventListener("focus",(function(t){var o=!1;if("image"==e.activeScene.trackingMode){var n,i=!1;if(e.multipleTracking){for(n=0;n<e.scenes.length;n++)if(e.scenes[n].markerRoot&&e.scenes[n].markerRoot.visible){i=!0;break}}else e.p_markerRoot&&e.p_markerRoot.visible&&(i=!0);o=!1;i||(o=!0),e.activeScene.settings.keepVisible&&!e.activeScene.markerNeverFound&&(o=!0)}else o=!0;o&&e.activeScene.playSceneVideos(),_browser.ios&&setTimeout((function(){_video&&_video.paused&&_video.play().catch(e=>{addToLog("auto play on focus prevented"),console.log(e)}).then(()=>{addToLog("auto play on focus ->then")})}),1e3)}),!1)}showVolumeButton(){_needVolumeButton=!0,console.log("show Volume Button (INLINE only)"),_config.isInline&&$(".b_volume").css("display:block;")}postMessage(e){var t=this.xr;e.scene=t.activeScene.url;try{window.parent.gotMessage({data:e})}catch(t){window.parent.postMessage(e,"*")}}gaEvent(e){_config.isDebug||"undefined"!=typeof gtag&&gtag&&(console.log("ga ev | "+e.event_label),gtag("event",e.event,{anonymize_ip:!0,event_category:e.event_category,event_label:e.event_label}))}}function printGraph(e=null,t=!1,o=!1,n=!1){var i=_xr;_xr&&console.log("graph _xr"),i||(i=_xrInline,console.log("graph _xrInline")),e||(e=i.scene3),"rootModel"==e&&(e=i.scene3.getObjectByName("rootModel"));var a="";a=" <"+e.type+"> "+e.name,t&&(a+=" P "+JSON.stringify(e.position)),o&&(a+=" R "+JSON.stringify(e.rotation)),n&&(a+=" S "+JSON.stringify(e.scale)),e.isMesh?(e.geometry&&e.geometry.groups&&e.geometry.groups.length&&(a+=" x "+e.geometry.groups.length),console.group("%c "+a,"color: green;")):console.group(a),"dotsGrid"!=e.name&&"transformControls"!=e.name&&e.children.forEach(e=>printGraph(e,t,o,n)),console.groupEnd()}var _pubnub=null;class xrpubnub{constructor(e){var t=this;t.theChannel=e.channel,t.pubnub=null,t.messageCallback=null,t.configuratorModule=e.configuratorModule,console.log("channel "+t.theChannel),t.loadScript()}loadScript(){var e=this,t=document.createElement("script");t.onload=function(){e.start()},t.src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.27.4.min.js",document.head.appendChild(t)}start(){var e=this;e.pubnub=new PubNub({publishKey:"pub-c-d6e88a4c-aa5b-4e4e-bcab-cfba600f8ac8",subscribeKey:"sub-c-90b7794a-eb6c-11ea-a3a0-967d27250efa",uuid:"theClientUUID"}),e.pubnub.addListener({message:function(t){e.displayMessage("[MESSAGE: received]",t.message)},presence:function(t){_config.isDebug&&e.displayMessage("[PRESENCE: "+t.action+"]",{tmp:"uuid: "+t.uuid+", channel: "+t.channel})},status:function(t){_config.isDebug&&e.displayMessage("[STATUS: "+t.category+"]",{tmp:"connected to channels: "+t.affectedChannels}),console.log("say hello");e.submitUpdate({hello:!0,config:!0})}}),e.pubnub.subscribe({channels:[e.theChannel],withPresence:!0})}submitUpdate(e){var t=this;if(t.pubnub){var o="mobile";_browser.desktop&&(o="desktop"),e.from=o,t.pubnub.publish({channel:t.theChannel,message:e},(function(e,t){e.error&&console.log(e)}))}else console.log("pubnub not ready")}displayMessage(e,t){var o=this;t.from;if(("desktop"!=t.from||!_browser.desktop)&&("mobile"!=t.from||_browser.desktop)){if(t.from||console.log("from UNDEF"),_config.isDebug&&(console.log("display message "+t.from+" "+_browser.desktop),console.log(e),console.log(t)),o.messageCallback&&t.config&&o.messageCallback(o.configuratorModule,t),t.hello&&(console.log("got HELLO from "+t.from),_browser.desktop)){_xrInline&&(_xrInline.hideQRCode(),_xrInline.common.postMessage({action:"hideQrCode"}));var n={fullConfig:!0,data:o.configuratorModule.configData};o.submitUpdate(n)}t.fullConfig&&(console.log("GOT FULL config from "+t.from),o.configuratorModule.setFullConfig(t.fullConfig))}}}function modules(e,t){this.xr=e,this.scene=t,this.canvas=document.getElementById("threejs"),this.body=document.body,this.modulesData=null,this.statesModuleDom=null,this.gesturesModule=null,this.statesModule=null,this.configuratorModule=null,this.skyboxModule=null,this.qrReaderModule=null,this.barcodeReaderModule=null,this.otherModule=null,this.photoData=null,this.shareURL=null,this.visitUrl=null,this.setupModules=function(){var e=this;if(e.visitUrl=document.location.href,_browser.insideIframe){var t=function(){for(var e={},t=window.location.search.substring(1).split("&"),o=0;o<t.length;o++){var n=t[o].split("=");if(void 0===e[n[0]])e[n[0]]=decodeURIComponent(n[1]);else if("string"==typeof e[n[0]]){var i=[e[n[0]],decodeURIComponent(n[1])];e[n[0]]=i}else e[n[0]].push(decodeURIComponent(n[1]))}return e}();e.visitUrl=t.parent}e.modulesData=e.scene.modules;var o=e.modulesData;if(e.scene.isInABundle&&_mainData.settings.modules){var n=_mainData.modules;addToLog(">> using bundle modules"),o.gestures=n.gestures,o.photo=n.photo,o.qrReader=n.qrReader,o.barcodeReader=n.barcodeReader,o.eShop=n.eShop}var i=document.createElement("div");i.id="loadingTools",i.innerHTML="<p>please wait...</p>",e.body.appendChild(i),o.states&&1==o.states.enabled&&(e.statesModule=new statesModule(e)),o.photo&&1==o.photo.enabled&&("ar"==e.scene.mode||_config.isPreview)&&(e.photoModule=new photoModule(e)),o.gestures&&1==o.gestures.enabled&&"ar"==e.scene.mode&&(_config.isPreview||(e.gesturesModule=new gesturesModule(e))),o.qrReader&&1==o.qrReader.enabled&&"ar"==e.scene.mode&&(e.qrReaderModule=new qrReaderModule(e)),o.barcodeReader&&1==o.barcodeReader.enabled&&"ar"==e.scene.mode&&(e.barcodeReaderModule=new barcodeReaderModule(e)),o.eShop&&1==o.eShop.enabled&&"ar"==e.scene.mode&&e.eShopModule(),o.configurator&&1==o.configurator.enabled&&(e.configuratorModule=new configuratorModule(e)),o.skybox&&1==o.skybox.enabled&&(e.skyboxModule=new skyboxModule(e)),o.other&&1==o.other.enabled&&"undefined"!=typeof otherModule&&(console.log("other module - - - - - INIT"),e.otherModule=new otherModule(e)),document.onkeyup=function(e){if(13==e.which)return document.activeElement.blur(),!1}},this.closeModules=function(){var e=this;if(e.statesModule&&e.statesModuleDom&&e.statesModule.statesModuleDom.querySelector(".modules .palette"))return void e.statesModule.closeColorPalette();$(".module.photoModule").removeClass("open")},this.setActiveModules=function(){$('.module[data-scene="'+this.scene.index+'"]').addClass("activeScene"),this.scene.isInABundle&&$(".photoModule").addClass("activeScene")},this.loop=function(e){this.gesturesModule&&this.gesturesModule.loop()},this.rayCastOnObject=function(e){this.statesModule.rayCastOnObject(e)},this.animationEndEvent=function(e){var t=this.modulesData;t.states&&t.states.enabled&&this.statesModule.animationEndEvent(e)},this.setupModules()}function getDistance2D(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}class gesturesModule{constructor(e){var t=this;t.gesturesHookPan=null,t.gesturesHook=null,t.distanceStart=null,t.newDistance=null,t.oldDistance=null,t.touches=[],t.fingers=[],t.scene=e.scene,t.canvas=e.canvas,t.moduleData=e.modulesData.gestures;var o=t.moduleData;function n(e){t.isMouseDown=!0,t.touchStart(e)}null==o.rotation.yAxis&&(o.rotation.yAxis=!0),null==o.pan&&(o.pan={enabled:!1}),o.rotationX=0,o.rotationY=0,o.rotationZ=0,o.lastTouch={x:0,y:0},o.lastTouchCenter={x:0,y:0},o.isMouseDown=!1,o.skipRotation=!1,o.currentScale=1,o.baseScale=1,o.lastTouchMoveTime=0,o.gesturesKookStartOffset={x:0,y:0},t.gesturesHookPan=new THREE.Group,t.gesturesHookPan.name="gesturesHookPan",t.gesturesHook=new THREE.Group,t.gesturesHook.name="gesturesHook",t.scene.rootXR.add(t.gesturesHookPan),t.gesturesHookPan.add(t.gesturesHook),t.scene.isCompScene?t.gesturesHook.add(t.scene.rootComposition):t.gesturesHook.add(t.scene.rootModel),_browser.isTouch?(console.log("ADD touch events"),document.addEventListener("touchstart",(function(e){e.clientX=e.touches[0].clientX,e.clientY=e.touches[0].clientY,n(e)}),!1),document.addEventListener("touchmove",(function(e){t.touchMove(e)}),!1),document.addEventListener("touchend",(function(e){t.isMouseDown=!1,t.touchStop(e)}),!1)):(document.addEventListener("mousedown",n,!1),document.addEventListener("mouseup",(function(e){t.isMouseDown=!1}),!1),document.addEventListener("mousemove",(function(e){t.isMouseDown&&(e.preventDefault(),t.touchMove(e))}),!1))}touchStart(e){var t=this,o=t.moduleData,n=1;isTouch&&(n=e.touches.length),n>1&&(t.skipRotation=!0);var i=t.canvas.getBoundingClientRect(),a=i.top+document.body.scrollTop,s=i.left+document.body.scrollLeft,r=window.innerWidth,l=window.innerHeight,d=new THREE.Vector2;d.x=(e.clientX-s)/r*2-1,d.y=-(e.clientY-a)/l*2+1,o.lastTouch={x:e.clientX,y:e.clientY};var c={x:e.clientX,y:e.clientY};if(t.touches.push(c),_browser.isTouch){if(t.fingers[0]={x:e.touches[0].screenX,y:e.touches[0].screenY},t.touches.length>1&&n>1&&(t.fingers[1]={x:e.touches[1].screenX,y:e.touches[1].screenY}),1==t.touches.length&&(o.lastTouchCenter.x=t.fingers[0].x,o.lastTouchCenter.y=t.fingers[0].y),2==e.touches){var u={x:t.fingers[1].screenX,y:t.fingers[1].screenY};t.touches.push(u)}if(2==t.touches.length){var m=getDistance2D(t.fingers[0],t.fingers[1]);t.distanceStart=m,t.oldDistance=null,t.newDistance=m,o.lastTouchCenter.x=(t.fingers[0].x+t.fingers[1].x)/2,o.lastTouchCenter.y=(t.fingers[0].y+t.fingers[1].y)/2}}t.touches.length>2&&t.touches.pop()}touchMove(e){var t=this,o=t.moduleData,n=!1;if(_xr&&_xr.isInARSession&&(n=!0),e.target==t.canvas||!_xr||n){var i,a,s=window.innerWidth;if(_browser.isTouch?(i=e.changedTouches[0].clientX,a=e.changedTouches[0].clientY):(i=e.clientX,a=e.clientY),o.rotation.enabled&&!t.skipRotation){var r=1*o.rotation.sensibility;if(o.rotation.xAxis){var l=(a-o.lastTouch.y)/s;n||(o.rotationX+=90*l*r),n&&_xr.inOnFloor&&(o.rotationX+=90*l*r),n&&!_xr.inOnFloor&&(o.rotationX+=90*l*r)}if(o.rotation.yAxis){var d=(i-o.lastTouch.x)/s;n||(o.rotationY+=90*d*r),n&&_xr.inOnFloor&&(_xr.useReticle,o.rotationY+=90*d*r),n&&!_xr.inOnFloor&&(o.rotationY+=90*d*r)}}if(o.lastTouch={x:i,y:a},o.pan.enabled&&!o.rotation.enabled&&o.pan.oneFinger&&e.touches&&1==e.touches.length){t.fingers[0]={x:e.touches[0].screenX,y:e.touches[0].screenY};var c={x:(f={x:t.fingers[0].x,y:t.fingers[0].y}).x-o.lastTouchCenter.x,y:f.y-o.lastTouchCenter.y};if(Math.abs(c.x)>3||Math.abs(c.y)>3){var u=420-40*o.pan.sensibility;_xr.isInARSession&&(u/=3);var m=!0,p=1;"image"==t.scene.trackingMode&&(t.scene.markerOrientationIsVertical||(m=!1,p=-1)),o.pan.xAxis&&t.gesturesHookPan.translateX(c.x/u),o.pan.yAxis&&(m?t.gesturesHookPan.translateY(c.y/u*-1*p):t.gesturesHookPan.translateZ(c.y/u*-1*p)),o.lastTouchCenter={x:f.x,y:f.y},console.log(o.lastTouchCenter)}}if(e.touches&&2==e.touches.length){if(t.fingers[0]={x:e.touches[0].screenX,y:e.touches[0].screenY},t.fingers[1]={x:e.touches[1].screenX,y:e.touches[1].screenY},o.zoom.enabled){var h=getDistance2D(t.fingers[0],t.fingers[1]);if(o.zoom.independent&&t.scene.index!=_xr.indexSceneActive)return;null!=t.oldDistance?(t.oldDistance=t.newDistance,t.newDistance=h):(t.oldDistance=h,t.newDistance=h);c=(t.newDistance-t.oldDistance)/10/(window.screen.width/8)*(r=o.rotation.sensibility/2);o.currentScale+=c;var g=o.baseScale*o.zoom.min/100,v=o.baseScale*o.zoom.max/100;o.currentScale<g&&(o.currentScale=g),o.currentScale>v&&(o.currentScale=v)}if(o.pan.enabled){if(!o.rotation.enabled&&o.pan.oneFinger)return;if(o.pan.independent&&t.scene.index!=_xr.indexSceneActive)return;var f;c={x:(f={x:(t.fingers[0].x+t.fingers[1].x)/2,y:(t.fingers[0].y+t.fingers[1].y)/2}).x-o.lastTouchCenter.x,y:f.y-o.lastTouchCenter.y};if(Math.abs(c.x)>3||Math.abs(c.y)>3){u=420-40*o.pan.sensibility;_xr.isInARSession&&(u/=3);m=!0,p=1;"image"==t.scene.trackingMode&&(t.scene.markerOrientationIsVertical||(m=!1,p=-1)),o.pan.xAxis&&t.gesturesHookPan.translateX(c.x/u),o.pan.yAxis&&(m?t.gesturesHookPan.translateY(c.y/u*-1*p):t.gesturesHookPan.translateZ(c.y/u*-1*p)),o.lastTouchCenter={x:f.x,y:f.y}}}}}}touchStop(e){var t=this,o=0;e.touches&&(o=e.touches.length),0==o&&(t.skipRotation=!1),t.touches=[],t.oldDistance=null}loop(){var e=this.moduleData,t=this.gesturesHook;if(!_isInline&&t){if(e.zoom.enabled){var o=e.currentScale;t.scale.x!=o&&t.scale.set(o,o,o)}if(e.rotation.enabled){var n=new THREE.Euler(THREE.Math.degToRad(e.rotationX),THREE.Math.degToRad(e.rotationY),THREE.Math.degToRad(e.rotationZ),"XYZ");t.setRotationFromEuler(n)}}}}class statesModule{constructor(e){var t=this;t.statesModuleDom=null,t.currentStateIndex=0,t.timerSwitchState=null,t.modulesClass=e,t.scene=e.scene,t.moduleData=e.modulesData.states;var o=t.moduleData,n=o.states[o.defaultStateIndex];n.button&&n.button.length;var i,a=0;o.states.forEach((function(e){e.button&&(a+=e.button.length)}));var s=!1;if(o.buttons)for(i=0;i<o.buttons.length;i++)"colorPicker"==o.buttons[i].type&&(s=!0);t.statesModuleDom=document.createElement("div"),t.statesModuleDom.setAttribute("class"," module statesModule brandingBg"),t.statesModuleDom.setAttribute("data-scene",t.scene.index),t.insertModuleDom(t.statesModuleDom);var r=!1;a>0?r=!0:t.statesModuleDom.classList.add("noButtons"),r&&t.statesModuleDom.classList.add("open");var l=document.createElement("div");if(l.className="buttons",t.statesModuleDom.appendChild(l),0==a&&(l.style.display="none"),"vr"==t.scene.mode&&t.applyDefaultState(),s&&null==window.jscolor){addToLog("need Jscolor");var d=document.createElement("script");d.onload=function(){addToLog("= = > jscolor LOADED"),window.jscolor.installByClassName("jscolor")},d.src=_rootDirectory+"js/modules/jscolor.min.js",document.head.appendChild(d)}s&&window.jscolor&&window.jscolor.installByClassName("jscolor")}insertModuleDom(e){document.querySelector("footer .modules").prepend(e)}findObjectByIndex(e,t=!0){var o=this.scene.object;if(!o)return null;var n=[];return o.traverse((function(e){!e.geometry&&t||n.push(e)})),n[e]}findObjectByCompUid(e){var t=null;return this.scene.rootMedias&&this.scene.rootMedias.traverse((function(o){o.compUid==e&&(t=o)})),t}debugObjectByIndex(e){var t,o=this.findObjectByIndex(e);console.log("debug: "+o.name),console.log(o);var n=o.parent;for(t=0;t<20;t++){if(!n){console.log("parent is null");break}console.log(t+" "+n.name+" : "+n.visible),n=n.parent}console.log("box");var i=(new THREE.Box3).setFromObject(o),a=new THREE.Vector3(0,0,0);i.getSize(a);console.log(i)}applyDefaultState(){var e=this.moduleData;if(e&&e.enabled){var t=e.defaultStateIndex;null!=t&&this.applyState(t)}}applyState(e){var t=this;if(!(""===e||e<0))if(null==e||isNaN(e))console.log("state index is not valid _"+e+"_");else{var o=t.moduleData;if(!(e>=o.states.length)){t.currentStateIndex=e;var n=o.states[e];t.scene.sendAPIMessage({scene:t.scene.url,sceneEvent:"new state",state:{name:n.name}});var i,a,s,r,l=t.statesModuleDom.querySelector(".buttons");n.buttonsAlign||(n.buttonsAlign="left"),l.style.textAlign=n.buttonsAlign,l.innerText="";var d,c,u=!1;if(n.button&&n.button.length&&(u=!0),u)for(l.setAttribute("data-buttons",n.button.length),i=0;i<n.button.length;i++){if(a=n.button[i],(s=document.createElement("span")).className="button",l.appendChild(s),c="",d="",o.buttons){var m,p=null;for(m=0;i<o.buttons.length;m++)if(o.buttons[m].id==a.id){p=o.buttons[m];break}if(c=p.type,r=p.label,s.innerText=r,""===r&&(s.innerHTML="&nbsp;"),c||(c="switchState"),d=p.stateIndex,s.setAttribute("data-index",d),s.setAttribute("data-pool",m),p.customColors&&(s.style.background=p.background,s.style.color=p.color),"colorPicker"==c)if(p.usePalette)p.openPalette&&t.openColorPalette(p.materialIndex,p.palette,l);else{var h=p.materialIndex,g=document.createElement("input");g.setAttribute("class","jscolor {width:220,padding:10,borderWidth:0}"),g.setAttribute("readonly","readonly"),g.setAttribute("data-indexMat",h),g.setAttribute("value","#000000"),s.style.position="relative",s.appendChild(g),g.addEventListener("click",(function(){var e=document.querySelector("footer .palette");e&&e.parentElement.removeChild(e),document.activeElement.blur()})),g.addEventListener("change",(function(){var e=1*this.getAttribute("data-indexMat"),o="#"+this.value;t.scene.materials[e]&&(t.scene.materials[e].color=o,this.parentElement.style.background=o,t.scene.setupMaterials())}))}}else s.innerText=a.name,c="switchState",d=a.stateIndex,s.setAttribute("data-index",d);"switchState"==c&&d==e&&s.classList.add("active"),s.addEventListener(_clickOrTouch,(function(){t.buttonAction(t,this,null)}))}else l.setAttribute("data-buttons",0);t.highLightStateButton(e),n.enter&&n.enter.forEach((function(e){t.doAction(e)})),window.jscolor&&window.jscolor.installByClassName("jscolor")}}}playCurrentStateAudios(){var e=this,t=e.moduleData;if(t.enabled){var o=e.currentStateIndex,n=t.states[o];n.enter&&n.enter.forEach((function(t){"playAudio"==t.type&&e.doAction(t)}))}}doAction(e){var t,o,n,i,a=this,s=this,r=e.type,l=a.scene;if("show"==r&&(Array.isArray(e.objectIndex)?e.objectIndex.forEach((function(t){var o=a.findObjectByIndex(t);o&&!e.delay&&(o.visible=!0),o&&e.delay&&setTimeout((function(){o.visible=!0}),1*e.delay)})):(t=a.findObjectByIndex(e.objectIndex))&&(t.visible=!0)),"hide"==r&&(Array.isArray(e.objectIndex)?e.objectIndex.forEach((function(t){var o=a.findObjectByIndex(t);o&&!e.delay&&(o.visible=!1),o&&e.delay&&setTimeout((function(){o.visible=!1}),1*e.delay)})):(t=a.findObjectByIndex(e.objectIndex))&&(t.visible=!1)),"showItem"==r&&void 0!==e.itemIndex&&e.itemIndex.forEach((function(e){if(e){var t=s.findObjectByCompUid(e);t&&(t.visible=!0)}})),"hideItem"==r&&void 0!==e.itemIndex&&e.itemIndex.forEach((function(e){if(e){var t=s.findObjectByCompUid(e);t&&(t.visible=!1)}})),"playAnimation"==r){var d=e.animationIndex;if(null!=d&&d>=0){var c=!1,u=!0;e.animationLoop&&(c=!0),void 0===e.stopOther||e.stopOther||(u=!1),l.playAnimation(d,c,u)}}if("playSimpleAnimation"==r&&a.playSimpleAnimation(e),"stopSimpleAnimation"==r&&a.stopSimpleAnimation(e),"playAudio"==r){var m=e.uidAudio;if(null!=m&&m>=0){c=!1;e.audioLoop&&(c=!0),l.playAudio(m,c)}else{var p=e.audioIndex;if(null!=p&&p>=0){c=!1;e.audioLoop&&(c=!0),l.playAudio(p,c)}}}("stopAudio"==r&&l.stopAudios(),"playVideo"==r)&&((n=e.uidVideo)&&l.playVideoByUid(n,!0),null!==(i=e.playvideoIndex)&&null!=i&&i>=0&&l.playVideo(i,!0));"pauseVideo"==r&&((n=e.uidVideo)&&l.pauseVideoByUid(n));"stopVideo"==r&&((n=e.uidVideo)&&l.stopVideoByUid(n),null!==(i=e.stopvideoIndex)&&null!=i&&i>=0&&l.stopVideo(i));if("footerText"==r){var h=e.text,g=a.statesModuleDom.querySelector(".footerText");g||((g=document.createElement("div")).className="brandingColor footerText",a.statesModuleDom.prepend(g)),g.innerHTML="",P=document.createElement("p"),g.appendChild(P),h?(P.innerText=h,g.style.display="block"):g.style.display="none",(v=a.statesModuleDom.querySelector("h3"))&&g&&v.parentNode.insertBefore(g,v.nextSibling),h&&""!=h&&(a.statesModuleDom.style.display="block")}if("title"==r){var v,f=e.title;null==f&&(f=""),(v=a.statesModuleDom.querySelector("h3"))||((v=document.createElement("h3")).className="brandingColor",a.statesModuleDom.prepend(v)),$('.statesModule[data-scene="'+l.index+'"] h3').text(f)}if("timer"==r){var b=a.currentStateIndex,y=e.timerEnd,x=e.timer;0==x&&(x=10),a.timerSwitchState&&clearTimeout(a.timerSwitchState),a.timerSwitchState=setTimeout((function(){a.currentStateIndex==b&&a.applyState(y)}),x)}if("setMaterial"==r){var w=e.indexMesh,T=e.indexLink,E=e.newMaterial,S=e.objectIndex;if(void 0===E||""===E)return;var _=l.data.materialsLinks;if(null!=S){for(w=S,w++,o=0;o<_.length;o++)if(_[o].idMesh==w)return _[o].mats[T].m=E,void l.updateMaterial(E);return}for(w++,o=0;o<_.length;o++)if(_[o].id==w)return _[o].mats[T].m=E,void l.updateMaterial(E)}if("property"==r){var M=e.indexMaterial;if(void 0===M)return;var C=e.propertyValue,L=e.duration,R=l.data.materials[M];if(!R)return void console.log("no mat for action");R.color=new THREE.Color(R.color);var k=new THREE.Color(C);if(L>10){!function(e,t){var o=t;new TWEEN.Tween(R.color).to(o,L).start().onUpdate((function(t){l.updateMaterial(e)}))}(M,k)}else R.color=new THREE.Color(k),l.updateMaterial(M)}if("moveTo"==r){if(console.log("moveto"),!(t=a.findObjectByIndex(e.objectIndex)))return;var A=l.data.model.plots;if(!A)return;var I=null;for(o=0;o<A.length;o++)if(A[o].id==e.plotID){I=A[o];break}if(!I)return;var D=_xr.scene3,B=new THREE.MeshBasicMaterial({color:16776960}),H=new THREE.BoxGeometry(.2,.2,.2),O=new THREE.Mesh(H,B);l.rootModel.add(O);var P=I.p;O.position.set(1*P.x,1*P.y,1*P.z),console.log(O.position);var N=O.parent,V=t.parent;N.updateMatrixWorld(),THREE.SceneUtils.detach(O,N,D),V.updateMatrixWorld(),THREE.SceneUtils.attach(O,D,V),O.updateMatrixWorld();P=O.position,L=e.duration;new TWEEN.Tween(t.position).to({x:P.x,y:P.y,z:P.z},L).start(),V.remove(O),O=null,console.log("moveto ok")}if("pageX"==r){var z=e.pageIndex;void 0!==z&&l.goToCompositionPage(z)}if("startModuleOther"==r&&a.modulesClass.modulesData.other&&a.modulesClass.modulesData.other.enabled&&(a.modulesClass.otherModule?a.modulesClass.otherModule.start(e.param):console.log("cannot start other")),"otherModuleAction"==r&&a.modulesClass.modulesData.other&&a.modulesClass.modulesData.other.enabled)if(a.modulesClass.otherModule){var F=e.params[0];a.modulesClass.otherModule.action(F)}else console.log("cannot other m action")}buttonAction(e,t,o){var n,i=e.moduleData,a=null,s=e.scene;if(t)if(i.buttons){var r=t.getAttribute("data-pool");(n=(a=i.buttons[r]).type)||(n="switchState")}else n="switchState",a={stateIndex:t.getAttribute("data-index")};if(o&&(n=(a=o).type),null!=a.sfx&&void 0===a.uidAudio){var l=1*a.sfx;l>=0&&s.playSFX(l,!0)}if(null!=a.uidAudio&&s.playAudio(a.uidAudio,!1),"switchState"==n){if("undefined"!=typeof gtag&&gtag&&a.stateIndex<i.states.length){var d=n+" "+i.states[a.stateIndex].name;e.scene.gaEvent({event:"button action",event_category:"scene",event_label:d})}if(t&&t.classList.contains("active"))return;e.applyState(a.stateIndex)}if("playAudio"==n&&s.doAction(a),"stopAllAudios"==n&&s.stopAudios(),"textBox"==n&&s.doAction(a),"www"==n&&s.doAction(a),"email"==n&&s.doAction(a),"call"==n&&s.doAction(a),"setMaterial"==n&&e.doAction(a),"colorPicker"==n&&a.usePalette){var c=a.materialIndex,u=a.palette,m=e.statesModuleDom.querySelector(".buttons");e.openColorPalette(c,u,m)}"embedVideo"==n&&s.doAction(a),"embedWebsite"==n&&s.doAction(a),"previousPage"!=n&&"nextPage"!=n&&"page_0"!=n&&"page_1"!=n&&"page_2"!=n&&"page_3"!=n&&"page_4"!=n||s.doAction(a),"vcf"==n&&s.doAction(a)}getNextState(e){var t,o=this,n=o.moduleData.states[o.currentStateIndex],i=null;for(t=0;t<o.scene.animations.length;t++)if(e.name==o.scene.animations[t].name){i=t;break}if(null!=i){var a=n.enter;if(a)for(t=0;t<a.length;t++)if("playAnimation"==a[t].type&&a[t].animationIndex===i){var s=a[t].animationEnd;return void(void 0!==s&&-1!=s&&o.applyState(s))}}}highLightStateButton(e){document.querySelectorAll('.statesModule[data-scene="'+this.scene.index+'"] .buttons .button').forEach((function(t){t.getAttribute("data-index")==e?t.classList.add("active"):t.classList.remove("active")}))}rayCastOnObject(e){var t,o,n,i=this,a=i.moduleData;if(a.virtualButtons)for(t=0;t<a.virtualButtons.length;t++)if(o=a.virtualButtons[t],(n=i.findObjectByIndex(o.objectIndex))==e){if(i.buttonAction(i,null,o),n.originalScale||(n.originalScale={x:e.scale.x,y:e.scale.y,z:e.scale.z}),void 0===o.visualFeedback||1==o.visualFeedback){var s={x:n.originalScale.x,y:n.originalScale.y,z:n.originalScale.z};e.scale.set(.9*s.x,.9*s.y,.9*s.z),new TWEEN.Tween(e.scale).to(s,300).start()}return}}playSimpleAnimation(e){var t=this.findObjectByIndex(e.objectIndex);if(t){var o,n,i,a,s=e.animationType,r=1*e.animationSpeed,l=1*e.animationScale,d=e.animationAxis,c=e.animationLoop;null==l&&console.log("WARNING: underf basic scale"),this.stopSimpleAnimation(e,s),r=11-r;var u=t.rotation.x,m=t.rotation.y,p=t.rotation.z;if(null==t.originalScale&&(t.originalScale={x:t.scale.x,y:t.scale.y,z:t.scale.z}),t.simpleAnimationTween||(t.simpleAnimationTween=[]),"scale_up_down"==s){t.scale.set(t.originalScale.x,t.originalScale.y,t.originalScale.z);var h=(y=t.scale.x)*l,g=(x=t.scale.y)*l,v=(w=t.scale.z)*l;o=250*r,n=parseInt(60*o/100),i=parseInt(40*o/100);var f=new TWEEN.Tween(t.scale).to({x:h,y:g,z:v},n),b=new TWEEN.Tween(t.scale).to({x:y,y:x,z:w},i);f.chain(b),c&&b.chain(f),f.start(),f.animationType=s,b.animationType=s,t.simpleAnimationTween.push(f),t.simpleAnimationTween.push(b)}if("pulse"==s){t.scale.set(t.originalScale.x,t.originalScale.y,t.originalScale.z);var y,x,w;h=(y=t.scale.x)*l,g=(x=t.scale.y)*l,v=(w=t.scale.z)*l;o=250*r,n=parseInt(30*o/100),i=parseInt(10*o/100),a=parseInt(60*o/100);f=new TWEEN.Tween(t.scale).to({x:h,y:g,z:v},n),b=new TWEEN.Tween(t.scale).to({x:y,y:x,z:w},i);var T=new TWEEN.Tween(null).to(null,a);f.chain(b),b.chain(T),c&&T.chain(f),f.start(),f.animationType=s,b.animationType=s,T.animationType=s,t.simpleAnimationTween.push(f),t.simpleAnimationTween.push(b),t.simpleAnimationTween.push(T)}if("rot_clockwise"==s){n=500*r*5;var E=new TWEEN.Tween(t.rotation),S={v:0},_={v:2*Math.PI};E=new TWEEN.Tween(S).to(_,n).onUpdate((function(){t.rotation.set(u,m,p),"x"==d&&t.rotateX(S.v),"y"==d&&t.rotateY(S.v),"z"==d&&t.rotateZ(S.v)})).onComplete((function(){t.rotation.set(u,m,p),t.rotateY(_.v*direction)})).start();c&&E.repeat(1/0),E.animationType=s,t.simpleAnimationTween.push(E)}if("rot_anticlockwise"==s){n=500*r*5;E=new TWEEN.Tween(t.rotation),S={v:0},_={v:-2*Math.PI},E=new TWEEN.Tween(S).to(_,n).onUpdate((function(){t.rotation.set(u,m,p),"x"==d&&t.rotateX(S.v),"y"==d&&t.rotateY(S.v),"z"==d&&t.rotateZ(S.v)})).onComplete((function(){t.rotation.set(u,m,p),t.rotateY(_.v*direction)})).start();c&&E.repeat(1/0),E.animationType=s,t.simpleAnimationTween.push(E)}}}stopSimpleAnimation(e,t){var o=this.findObjectByIndex(e.objectIndex);if(o&&o.simpleAnimationTween)if(t){for(n=0;n<o.simpleAnimationTween.length;n++){(i=o.simpleAnimationTween[n]).animationType==t&&i.stop()}}else{var n;for(n=0;n<o.simpleAnimationTween.length;n++){var i;(i=o.simpleAnimationTween[n]).stop();var a=i.animationType;"scale_up_down"!=a&&"pulse"!=a||console.log("must revert scale")}o.simpleAnimationTween=null}}openColorPalette(e,t,o){var n=this,i=n.scene.materials,a=document.querySelector("footer .palette");if(a){var s=a.getAttribute("data-index");if(a.parentElement.removeChild(a),s==e)return}var r,l,d=document.createElement("div");for(d.setAttribute("class","palette brandingBg"),d.setAttribute("data-index",e),r=0;r<t.length;r++)(l=document.createElement("span")).className="color",l.setAttribute("data-color",t[r].color),l.setAttribute("data-index",e),l.style.background=t[r].color,d.appendChild(l),l.addEventListener("click",(function(){var e=this.getAttribute("data-index"),t=this.getAttribute("data-color");if("undefined"!=e&&(i[e].color=t,n.scene.setupMaterials(),n.statesModuleDom)){var o=n.statesModuleDom.querySelector('.button[data-index="'+e+'"]');o&&(o.style.background=t)}}));if(o.appendChild(d),n.statesModuleDom){var c=document.createElement("span");c.className="b_close closePalette",n.statesModuleDom.appendChild(c),c.addEventListener("click",(function(){n.closeColorPalette()}))}}closeColorPalette(){var e=this.statesModuleDom.querySelector(".modules .b_close.closePalette");e&&e.parentElement.removeChild(e),(e=this.statesModuleDom.querySelector(".modules .palette"))&&e.parentElement.removeChild(e)}animationEndEvent(e){var t=e.getClip();this.getNextState(t)}}class photoModule{constructor(e){var t=this,o=this;o.body=document.body,o.footerDom=document.querySelector("footer"),o.scene=e.scene,o.moduleData=e.modulesData.photo,o.canvas=e.canvas,o.visitUrl=e.visitUrl,o.assetsFolder=_rootDirectory+"assets/",_config.externalHost&&(o.assetsFolder="assets/"),o.photobase64=null,o.mediaType=null,o.mediaFormat=null,t.mediaRecorder=null,t.mediaRecorderChunks=[],t.timeCounter=0,t.isMediaRecorderSupported=!1,t.tickInterval=null;var n=o.moduleData;if(!n.started&&(n.started=!0,!o.body.classList.contains("photoM"))){o.body.classList.add("photoM"),void 0===n.saveButton&&(n.saveButton=1),void 0===n.saveButtonText&&(n.saveButtonText="Save"),void 0===n.shareButton&&(n.shareButton=1),void 0===n.shareButtonText&&(n.shareButtonText="Share"),void 0===n.photoButton&&(n.photoButton={enabled:1},n.videoButton={enabled:0}),o.divPhotoTools=document.createElement("div"),o.divPhotoTools.id="photoTools",o.footerDom.insertBefore(o.divPhotoTools,o.footerDom.firstChild),o.photoModuleDom=document.createElement("div"),o.photoModuleDom.className="module photoModule brandingBg",o.photoModuleDom.setAttribute("data-scene",o.scene.index),o.body.appendChild(o.photoModuleDom),t.addButtons();var i=document.createElement("span");i.className="b_close",o.photoModuleDom.appendChild(i);var a=document.createElement("div");a.id="photoPreviewWrapper",a.className="mediapreview photo",o.photoModuleDom.appendChild(a);var s=document.createElement("img");s.id="photoPreview",s.className="preview",a.appendChild(s);var r=document.createElement("div");if(r.id="photoForm",o.photoModuleDom.appendChild(r),n.saveButton){var l=document.createElement("div");l.className="save";var d=!0;if(_browser.ios&&"safari"!=_browser.name&&(d=!1),d){var c=document.createElement("span");c.className="button save",c.innerText=n.saveButtonText,l.appendChild(c),c.addEventListener("click",(function(){o.saveMedia()}))}else{var u=document.createElement("span");u.className="messageNoSave",u.innerText="To save, hold a finger on the preview",l.appendChild(u)}r.appendChild(l)}if(n.shareButton&&_browser.share&&_browser.shareFile){var m=document.createElement("div");m.className="share";var p=document.createElement("span");p.className="button share",p.innerText=n.shareButtonText,m.appendChild(p),p.addEventListener("click",(function(){o.shareMediaFile()})),r.appendChild(m)}if(!_browser.desktop&&n.switchCamera&&"image"!=o.scene.trackingMode){var h=document.createElement("span");h.className="button",h.id="swapCamera",o.divPhotoTools.insertBefore(h,o.divPhotoTools.firstChild),h.addEventListener("click",(function(){_app.videoStream.swapCamera(),$("#swapCamera").css("visibility:hidden"),setTimeout((function(){$("#swapCamera").css("visibility:visible")}),1e3)}))}i.addEventListener("click",(function(){o.closeModule()}))}}closeModule(){var e=this;"video"==e.mediaType&&(e.mediaRecorderChunks=[],e.mainContainer.setAttribute("hidden",""),URL.revokeObjectURL(e._videoUrl),_app.common.resumeLoop(),e.photoModuleDom.classList.remove("open")),$(".module.photoModule").removeClass("open")}addButtons(){var e=this,t=e.moduleData;if(t.photoButton.enabled){var o=document.createElement("span");o.id="b_takePhoto",o.className="button",o.innerHTML='<img src="'+e.assetsFolder+'icons/icon-camera.svg" alt=""/>',e.divPhotoTools.classList.add("photo"),e.divPhotoTools.appendChild(o),o.addEventListener(_clickOrTouch,(function(){e.takePhoto()}))}if(t.videoButton.enabled){e.isMediaRecorderSupported=!0;try{MediaRecorder}catch{e.isMediaRecorderSupported=!1}if(e.isMediaRecorderSupported){var n=document.createElement("span");n.id="b_takeVideo",n.className="button",n.innerHTML='<img class="start" src="'+e.assetsFolder+'icons/icon-video-camera.svg" alt=""/>',n.innerHTML+='<img class="stop" src="'+e.assetsFolder+'icons/icon-stop.svg" alt=""/>',e.divPhotoTools.classList.add("video"),e.divPhotoTools.appendChild(n),n.addEventListener(_clickOrTouch,(function(){e.recordVideo()})),e.buildVideoPlayer()}e.uiRecordTime=document.createElement("p"),e.uiRecordTime.setAttribute("hidden",""),e.uiRecorder=document.createElement("div"),e.uiRecorder.id="videoRecorder",e.uiRecorder.appendChild(e.uiRecordTime),e.divPhotoTools.appendChild(e.uiRecorder)}}takePhoto(){var e=this;e.shareURL=null,e.mediaType="photo",e.scene.gaEvent({event:"take photo",event_category:"scene",event_label:"take photo"}),$("#b_takePhoto").css("display:none"),setTimeout((function(){var t=e.canvas,o=e.body.classList.contains("nft"),n=e.body.classList.contains("p"),i=e.scene.trackingMode;e.photoData=new FormData,function(){if(n&&!o&&"slam"!=i&&"fixed"!=i){(s=new Image).src=t.toDataURL(),(r=document.createElement("canvas")).width=t.height,r.height=t.width;var a=r.getContext("2d");s.onload=function(){a.translate(0,s.width),a.rotate(-90*Math.PI/180),a.drawImage(s,0,0);var t=r.toDataURL("image/jpeg",.8);r=null,document.getElementById("photoPreview").src=t,e.photobase64=t,e.photoData.append("imgBase64",t),e.photoData.append("url",_config.sceneURL),e.openMediaPreview()}}else if(o){var s;(s=new Image).src=t.toDataURL();a=(r=document.createElement("canvas")).getContext("2d");var r,l=0,d=0;n?(d=120,r.width=720,r.height=960):(l=120,r.width=960,r.height=720);var c=r.width,u=r.height;s.onload=function(){a.drawImage(s,l,d,c,u,0,0,c,u);var t=r.toDataURL("image/jpeg",.8);r=null,document.getElementById("photoPreview").src=t,e.photoData.append("imgBase64",t),e.photoData.append("url",_config.sceneURL),e.openMediaPreview()}}else{var m=t.toDataURL("image/jpeg",.8);document.getElementById("photoPreview").src=m,e.photobase64=m,e.photoData.append("imgBase64",m),e.photoData.append("url",_config.sceneURL),e.openMediaPreview()}}(),setTimeout((function(){$("#b_takePhoto").css("display:inline-block")}),600),document.activeElement.blur()}),50)}saveMedia(){var e,t=this,o=cleanString(_config.sceneURL),n=new Date,i=n.getHours(),a=n.getMinutes(),s=n.getSeconds(),r=document.createElement("a");if("video"==t.mediaType&&(t.scene.gaEvent({event:"save video",event_category:"scene",event_label:"save video"}),e="video-"+o+"-"+i+"-"+a+"-"+s+"."+t.mediaFormat,r.href=t._videoUrl),"photo"==t.mediaType){t.scene.gaEvent({event:"save photo",event_category:"scene",event_label:"save photo"}),e="photo-"+o+"-"+i+"-"+a+"-"+s+".jpg";var l=document.getElementById("photoPreview").src;l=l.replace(/^data:image\/[^;]/,"data:application/octet-stream"),r.href=l}r.download=e,r.click()}shareMediaFile(){var e=this,t=_config.shareTitle;if("video"==e.mediaType){if(addToLog("share video file"),!this.blobData)return console.error("Can't share video: Blob data was null or undefined!"),void alert("could not share video");const o=this.GetSupportedMediaType(),n=new File(this.mediaRecorderChunks,"video."+o.format,{type:o.type});return addToLog(o.format+" | "+o.type),void navigator.share({title:t,text:t,files:[n]}).then((function(t){console.log(t),e.shareCompleted(t)})).catch((function(e){addToLog("catch share error"),console.log(e)}))}addToLog("share photo file");const o=e.photobase64;fetch(o).then((function(e){return e.blob()})).then((function(o){addToLog("blob type "+o.type);const n=new File([o],"picture.jpg",{type:o.type});navigator.share({files:[n],title:t,text:t}).then((function(t){console.log(t),e.shareCompleted(t)})).catch((function(e){addToLog("catch share error"),console.log(e)}))}))}shareAPIPhoto(){var e=this,t=e.scene;if(e.moduleData.onlyUpload)return addToLog("only upload"),void e.closeModule();var o=_rootDirectory+"photos/?p="+e.shareURL;_browser.insideIframe&&(o=e.visitUrl+"?p="+e.shareURL),_config.isDebug&&(addToLog("visit url "+e.visitUrl),addToLog(o));var n=_config.shareText,i=_config.shareTitle,a=t.data.branding;if(t.isInABundle&&_mainData.branding&&_mainData.branding.main&&(a=_mainData.branding),a.main&&a.main.social&&null!=a.main.social.title){var s=a.main.social;n=s.title,i=s.text}navigator.share({title:n,text:i,url:o}).then((function(){e.shareCompleted()})).catch((function(t){console.log("share api error catch"),console.log(t),console.log(""+t),e.stopLoading(),(""+t).toLowerCase().includes("share canceled")||(""+t).toLowerCase().includes("aborterror")||openModal({p:"Could not share, try again later \n"+t})}))}shareCompleted(){console.log("shared completed"),this.scene.gaEvent({event:"share photo/video",event_category:"scene",event_label:"share photo/video"})}openMediaPreview(){"video"==this.mediaType?($("#photoPreviewWrapper").css("display:none"),$(".photoModule .mainContainer").css("display:block"),$(".photoModule .messageNoSave").css("display:none"),setTimeout((function(){addToLog("AUTOPLAY 500ms"),document.querySelector(".photoModule .video-container video").play().catch(e=>{addToLog("auto play record prevented"),console.log(e)}).then(()=>{addToLog("auto play record ->then")})}),500)):($("#photoPreviewWrapper").css("display:block"),$(".photoModule .mainContainer").css("display:none"),$(".photoModule .messageNoSave").css("display:inline-block")),this.photoModuleDom.classList.add("open"),$(".photoModule .button").css("visibility:hidden"),setTimeout((function(){$(".photoModule .button").css("visibility:visible")}),500)}recordVideo(){console.log("record video");var e=this;if(e.mediaRecorder&&"recording"===e.mediaRecorder.state)return _$body.removeClass("recording"),e.mediaRecorder.stop(),clearInterval(e.tickInterval),e.timeCounter=0,void e.openMediaPreview();var t=_canvas.captureStream(25);e.moduleData.recordAudio?navigator.mediaDevices.getUserMedia({audio:!0}).then((function(o){var n=_canvas.captureStream(25);t=new MediaStream,o.getAudioTracks().forEach((function(e){t.addTrack(e)})),n.getVideoTracks().forEach((function(e){t.addTrack(e)})),e.startMediaRecorder(t)})).catch((function(e){alert("error microphone"),console.log(e)})):e.startMediaRecorder(t)}startMediaRecorder(e){var t=this;t.tickInterval=setInterval(()=>t.tickVideoRecording(),1e3),t.tickVideoRecording(),t.uiRecordTime.removeAttribute("hidden"),t.mediaRecorder=new MediaRecorder(e),t.mediaRecorder.ondataavailable=e=>t.OnMediaRecorderDataAvailable(e),t.mediaRecorder.onstop=e=>t.OnMediaRecorderStop(e),t.mediaRecorder.start(),_$body.addClass("recording"),t.mediaType="video",t.scene.gaEvent({event:"record video",event_category:"scene",event_label:"record video"})}ParseHTML(e){return(new DOMParser).parseFromString(e,"text/html")}tickVideoRecording(){var e=this;const t=e.timeCounter%60,o=Math.floor(e.timeCounter/60),n=`${e.FormatTime(o)}:${e.FormatTime(t)}`;e.uiRecordTime.textContent=n,e.timeCounter++;var i=300;"iiw"==_app.activeScene.url&&(i=15),e.timeCounter>i&&e.recordVideo()}Seek(e){this.video_element_timeline.style.width=e.toString()+"%",this.video_element.currentTime=this.video_element.duration*(e/100)}UpdateProgress(){if(this.is_seeker_maintained)return;const e=this.video_element.duration,t=this.video_element.currentTime/e*100;this.video_element_timeline.style.width=t.toString()+"%",this.video_time_indicator.textContent=`${this.FormatTimeMS(this.video_element.currentTime)} / ${this.FormatTimeMS(this.video_element.duration)}`}OnVideoPlayPause(e){const t=this.video_element.paused||this.video_element.ended;console.log(t?"Paused":"Played"),t?this.video_element_indicator.hasAttribute("hidden")&&this.video_element_indicator.removeAttribute("hidden"):this.video_element_indicator.setAttribute("hidden","")}FormatTime(e){return e<10?"0"+e:""+e}FormatTimeMS(e){const t=Math.floor(e%60),o=Math.floor(e/60);return`${this.FormatTime(o)}:${this.FormatTime(t)}`}buildVideoPlayer(){var e=this;e.mainContainer=document.createElement("div");const t=document.createElement("div"),o=document.createElement("div");e.mainContainer.setAttribute("hidden",""),o.setAttribute("class","btnContainer"),e.mainContainer.setAttribute("class","mediapreview video mainContainer"),t.setAttribute("class","previewContainer"),this.video_html=this.ParseHTML('\n\t\t\t<div class="video-container">\n\t\t\t\t<video class="video" id="video" preload="metadata" playsinline muted autoplay>\n\t\t\t\t\t<source type="video/mp4"></source>\n\t\t\t\t</video>\n\n\t\t\t\t<div class="controlls-container">\n\t\t\t\t\t<span>00:00 | 00:00</span>\n\t\t\t\t\t<div class="timeline-container">\n\t\t\t\t\t\t<div class="timeline">\n\t\t\t\t\t\t\t<div></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="indicator">\n\t\t\t\t\t<svg class="playback-icons">\n\t\t\t\t\t\t<use href="#play-icon"></use>\n\t\t\t\t\t</svg>\n\t\t\t\t</div>\n\n\t\t\t\t<svg style="display: none">\n\t\t\t\t<defs>\n\t\t\t\t\t<symbol id="pause" viewBox="0 0 24 24">\n\t\t\t\t\t\t<path d="M14.016 5.016h3.984v13.969h-3.984v-13.969zM6 18.984v-13.969h3.984v13.969h-3.984z"></path>\n\t\t\t\t\t</symbol>\n\n\t\t\t\t\t<symbol id="play-icon" viewBox="0 0 24 24">\n\t\t\t\t\t\t<path d="M8.016 5.016l10.969 6.984-10.969 6.984v-13.969z"></path>\n\t\t\t\t\t</symbol>\n\t\t\t\t</svg>\n\t\t\t</div>\n\t\t'),this.video_html.querySelector("video").setAttribute("id","monid"),this.video_element=this.video_html.querySelector("video"),this.video_element_src=this.video_html.querySelector("video source"),this.controlls_container=this.video_html.querySelector(".controlls-container"),this.video_element_indicator=this.video_html.querySelector(".indicator"),this.video_element_timeline=this.video_html.querySelector(".timeline"),this.video_element_timeline_container=this.video_html.querySelector(".timeline-container"),this.video_time_indicator=this.video_html.querySelector(".controlls-container span"),this.seeker=this.video_html.querySelector(".timeline div"),this.video_element.addEventListener("click",e=>this.OnVideoClick(e)),this.video_element.addEventListener("play",e=>this.OnVideoPlayPause(e)),this.video_element.addEventListener("pause",e=>this.OnVideoPlayPause(e)),t.appendChild(this.video_html.body.firstChild),t.appendChild(o),this.mainContainer.appendChild(t),this.video_element.addEventListener("timeupdate",()=>this.UpdateProgress()),this.seeker.addEventListener("mousedown",e=>this.OnSeekerMouseDown(e)),this.seeker.addEventListener("touchstart",e=>this.OnSeekerMouseDown(e)),e.photoModuleDom.appendChild(e.mainContainer),e.addStyles()}addStyles(){var e=document.createElement("style");e.innerText="\n\t\t\t.video-container .indicator {\n\t\t\t\tuser-select: none;\n\t\t\t\tpointer-events: none;\n\t\t\t\tposition: absolute;\n\t\t\t\ttop: 50%;\n\t\t\t\tleft: 50%;\n\t\t\t\ttransform: translate(-50%, -50%);\n\t\t\t\tfill: white;\n\t\t\t}\n\n\t\t\t.video-container .indicator svg {\n\t\t\t\twidth: 80px;\n\t\t\t\theight: 80px;\n\t\t\t}\n\n\t\t\t.controlls-container {\n\t\t\t\tdisplay: none; /* but can be flex */\n\t\t\t\tjustify-content: space-around;\n\t\t\t\talign-items: center;\n\t\t\t\tposition: absolute;\n\t\t\t\tbottom: 0;\n\t\t\t\tleft: 0;\n\t\t\t\twidth: 100%;\n\t\t\t\theight: 25px;\n\t\t\t\tbackground: black;\n\t\t\t}\n\n\t\t\t.controlls-container span {\n\t\t\t\tdisplay: block;\n\t\t\t\tcolor: white;\n\t\t\t\twhite-space: nowrap;\n\t\t\t\tfont-size: 0.8rem;\n\t\t\t\tmargin: 0 10px;\n\t\t\t}\n\n\t\t\t.controlls-container .timeline-container {\n\t\t\t\theight: 5px;\n\t\t\t\twidth: 100%;\n\t\t\t\tbackground: white;\n\t\t\t\tmargin: 0 10px;\n\t\t\t\tborder-radius: 10px;\n\t\t\t}\n\n\t\t\t.timeline {\n\t\t\t\tposition: relative;\n\t\t\t\theight: 100%;\n\t\t\t\twidth: 50%;\n\t\t\t\tbackground: gray;\n\t\t\t\tborder-radius: 10px;\n\t\t\t}\n\n\t\t\t.timeline div {\n\t\t\t\tposition: absolute;\n\t\t\t\tright: 0;\n\t\t\t\ttop: 50%;\n\t\t\t\ttransform: translate(50%, -50%);\n\t\t\t\twidth: 15px;\n\t\t\t\theight: 15px;\n\t\t\t\tbackground: white;\n\t\t\t\tbox-shadow: 0 0 5px rgba(0, 0, 0, 0.25);\n\t\t\t\tborder-radius: 15px;\n\t\t\t\ttransition-property: width, height;\n\t\t\t\ttransition-duration: 0.2s;\n\t\t\t}\n\n\t\t\t.timeline div:hover {\n\t\t\t\twidth: 20px;\n\t\t\t\theight: 20px;\n\t\t\t\tcursor: pointer;\n\t\t\t}\n\n\t\t\tvideo::-webkit-media-controls-fullscreen-button {\n\t\t\t\tdisplay: none;\n\t\t\t}\n\n\t\t\tvideo::-webkit-media-controls-volume-slider {\n\t\t\t\tdisplay:none;\n\t\t\t}\n\n\t\t\tvideo::-webkit-media-controls-mute-button {\n\t\t\t\tdisplay:none;\n\t\t\t}\n\t\t\n\t\t\t.recordTime {\n\t\t\t\tcolor: white;\n\t\t\t\tbackground: black;\n\t\t\t\tpadding: 15px;\n\t\t\t\tborder-bottom-left-radius: 10px;\n\t\t\t\tborder-bottom-right-radius: 10px;\n\t\t\t\tbox-shadow: 0 0 10px rgba(0, 0, 0, 0.25);\n\t\t\t\tz-index: 1001;\n\t\t\t}\n\n\t\t\t[hidden] {\n\t\t\t\tdisplay: none;\n\t\t\t}\n\t\t",document.getElementsByTagName("head")[0].appendChild(e)}OnMediaRecorderDataAvailable(e){this.mediaRecorderChunks.push(e.data)}GetSupportedMediaType(){let e=null;return e=MediaRecorder.isTypeSupported?{type:"video/webm",format:"webm"}:{type:"video/mp4",format:"mp4"},_browser.ios&&(e={type:"video/mp4",format:"mp4"}),addToLog("mediaType "+e.type),e}OnMediaRecorderStop(e){console.log("stop video recording");let t=this.GetSupportedMediaType();this.mediaFormat=t.format,this.video_element_src.setAttribute("type",t.type);const o=new Blob(this.mediaRecorderChunks,{type:t.type});this.blobData=o,this._videoUrl=URL.createObjectURL(o),this.video_element_src.setAttribute("src",this._videoUrl),this.video_element.load(),this.video_element.addEventListener("loadeddata",e=>{this.Seek(0)}),_app.common.pauseLoop(),this.mainContainer.removeAttribute("hidden"),this.uiRecordTime.setAttribute("hidden","")}OnVideoClick(e){this.video_element.paused||this.video_element.ended?this.video_element.play():this.video_element.pause()}OnPreviewNeedClose(){this.mediaRecorderChunks=[],this.mainContainer.setAttribute("hidden",""),URL.revokeObjectURL(this._videoUrl),_app.common.resumeLoop(),this.photoModuleDom.classList.remove("open")}startLoading(){$("#loadingTools").css("display:block")}stopLoading(){$("#loadingTools").css("display:none")}}class qrReaderModule{constructor(e){var t=this;t.scene=e.scene,t.moduleData=e.modulesData.qrReader;var o=t.moduleData;if(!o.started&&(o.started=!0,o.isPaused=!1,this.gCtx=null,this.gCanvas=null,this.stype=0,this.gUM=!1,this.QRwindowSize=550,this.QRcanvasSize=350,this.intervalDecoder=1e3,!_config.isPreview)){_video&&(t.QRwindowSize>_video.videoWidth||t.QRwindowSize>_video.videoHeight)&&(t.QRwindowSize=450);var n=document.createElement("script");n.onload=function(){addToLog("= = > qr reader LOADED"),i(),a()},n.src=_rootDirectory+"js/modules/process-qr-reader-dist.js",document.head.appendChild(n);var i=function(){var e=t.QRcanvasSize,o=t.QRcanvasSize;t.gCanvas||(t.gCanvas=document.createElement("canvas"),t.gCanvas.id="qr-canvas",document.body.appendChild(t.gCanvas),t.gCanvas.style.display="none",t.gCanvas.width=e,t.gCanvas.height=o,t.gCtx=t.gCanvas.getContext("2d"),t.gCtx.clearRect(0,0,e,o),qrcode.callback=function(e){t.readQR(e)})},a=function(){t.stype=1,t.gUM=!0,setTimeout(s,t.intervalDecoder)},s=function(){if(_xr&&!_xr.loopIsPaused){var e=_video;if(e){if(1==t.stype&&t.gUM)try{var o=t.QRcanvasSize,n=t.QRwindowSize,i=(e.videoWidth-n)/2,a=(e.videoHeight-n)/2;t.gCtx.drawImage(e,i,a,n,n,0,0,o,o);try{qrcode.decode(),setTimeout(s,t.intervalDecoder)}catch(e){setTimeout(s,t.intervalDecoder)}}catch(e){console.log(e),setTimeout(s,t.intervalDecoder)}}else console.log("no video for qr")}else setTimeout(s,t.intervalDecoder)}}}readQR(e){addToLog("qr: "+e);var t=this,o=t.moduleData;if(!o.isPaused&&!document.getElementById("bgModal")&&!e.includes("xr.plus/"+t.scene.url)){var n=document.location.href;try{n=window.location!=window.parent.location?document.referrer:document.location.href}catch(e){console.error("catch currentURL")}if(e.split("#")[0]!=n)if(!e.includes("http")&&e.includes("www.")&&(e="http://"+e),!t.findInQRReaderArray(e)){var i=!1;if(is.url(e)&&(i=!0),i){t.scene.gaEvent({event:"scan QR code",event_category:"scene",event_label:"scan QR code"});var a=cleanString(e);if(o.embedContent){var s={type:"embedWebsite",embedWebsiteURL:a};t.scene.doAction(s)}else{s={wwwModal:!0,wwwSameTab:!0,wwwText:null};t.scene.openLink(s,a,!0)}}}}}findInQRReaderArray(e){var t=this,o=t.moduleData;if(!o.codes)return!1;var n,i,a=""+e;a=a.replace(/\s/g,"");for(n=0;n<o.codes.length;n++)if(a==((i=o.codes[n]).value+"").replace(/\s/g,"")){if(!0,o.isPaused=!0,"eShop"==i.action){var s=i.barCode;return t.scene.modulesEngine.openEShopModule(s),!0}var r={buttons:!0,yesButton:"ok",noButton:"cancel",closeButton:!1,callbackYes:function(){o.startCoolDown();var e={type:"embedWebsite",embedWebsiteURL:i.url};t.scene.doAction(e)},callbackNo:function(){o.startCoolDown()}};return openModal({h2:"Item scanned",p:""+i.name},r),!0}return!1}}class barcodeReaderModule{constructor(e){var t=this;if(t.modulesClass=e,t.scene=e.scene,t.moduleData=e.modulesData.barcodeReader,!t.started){t.started=!0,t.canvas=document.createElement("canvas"),t.barcodeDetector=null,t.resume();var o=0;if(!_config.isPreview){var n=function(){if(addToLog("= = > barcode reader LOADED"),_video)s();else{console.log("no video for barcode reader");var e=setInterval(()=>{_video&&(console.log("barcode got video ready"),clearInterval(e),s())},2e3)}},i=document.createElement("script");i.onload=function(){n()},i.src=_rootDirectory+"js/modules/quagga.min.js",document.head.appendChild(i);var a=function(e,n){setInterval(()=>{t.isPaused||function(){if(!_app.loopIsPaused){var i=e.videoWidth,a=e.videoHeight,s=0,r=0;i>=a&&(s=(i-a)/-2),i<a&&(r=(a-i)/-2),s-=o,r-=o,n.drawImage(e,s,r);var l=t.canvas.toDataURL("image/jpeg",.9),d=l.substr(l.indexOf(",")+1);Quagga.decodeSingle({decoder:{readers:["ean_reader"]},locate:!1,inputStream:{size:640},src:"data:image/jpg;base64,"+d},(function(e){e?e.codeResult&&console.log("result",e.codeResult.code):console.log("results null")}))}}()},400)},s=function(){if(_browser.android&&"chrome"==_browser.name){if("BarcodeDetector"in window)return void t.initBarcodeAPI();addToLog("no barcode API")}var e=_video.videoWidth;_video.videoHeight<e&&(e=_video.videoHeight),e<=480&&(o=15),e>480&&(o=100),addToLog("ean margin "+o),t.canvas.setAttribute("width",e-2*o),t.canvas.setAttribute("height",e-2*o),a(_video,t.canvas.getContext("2d")),Quagga.onDetected((function(e){document.getElementById("bgModal")||t.isPaused||t.readBarcode(e.codeResult.code)}))}}}}readBarcode(e){console.log("detected "+e);var t=this,o=t.moduleData;t.findInBarCodeReaderArray(e)||o.ignoreOthers||(13==e.length&&(e=e.charAt(0)+" "+e.charAt(1)+e.charAt(2)+e.charAt(3)+e.charAt(4)+e.charAt(5)+e.charAt(6)+" "+e.charAt(7)+e.charAt(8)+e.charAt(9)+e.charAt(10)+e.charAt(11)+e.charAt(12)),t.isPaused=!0,openModal({h2:"EAN detected ",p:""+e},{callbackYes:t.startCoolDown}))}findInBarCodeReaderArray(e){var t=this,o=t.moduleData;if(!o.codes)return!1;var n,i,a,s=""+e;s=s.replace(/\s/g,"");for(n=0;n<o.codes.length;n++)if(s==(i=(i=(a=o.codes[n]).value+"").replace(/\s/g,""))){!0,t.isPaused=!0;var r=a.action;if("eShop"==r)return t.scene.modulesEngine.openEShopModule(i),!0;if("otherModuleAction"==r){var l=t;if(l.modulesClass.modulesData.other&&l.modulesClass.modulesData.other.enabled)if(l.modulesClass.otherModule){var d=a.params[0];l.modulesClass.otherModule.action(d,i)}else console.log("cannot other m action");return!0}var c={buttons:!0,yesButton:"ok",noButton:"cancel",closeButton:!1,callbackYes:function(){t.startCoolDown();var e={type:"embedWebsite",embedWebsiteURL:a.url};t.scene.doAction(e)},callbackNo:function(){t.startCoolDown()}};return openModal({h2:"Item scanned",p:""+a.name},c),!0}return!1}startCoolDown(){var e=this;addToLog("cool down"),setTimeout((function(){e.resume()}),1e3)}resume(){addToLog("scanning barcode resumed"),this.isPaused=!1}initBarcodeAPI(){var e=this;addToLog("init barcode API"),e.barcodeDetector=new BarcodeDetector({formats:["ean_13","ean_8"]});var t=_video,o=e.canvas.getContext("2d"),n=0,i=_video.videoWidth;_video.videoHeight<i&&(i=_video.videoHeight),i<=480&&(n=15),i>480&&(n=50),addToLog("ean API margin "+n),e.canvas.setAttribute("width",i-2*n),e.canvas.setAttribute("height",i-2*n);var a=i-2*n;setInterval(()=>{e.isPaused||function(){if(!_app.loopIsPaused){var i=t.videoWidth,s=t.videoHeight,r=0,l=0;i>=s&&(r=(i-s)/-2),i<s&&(l=(s-i)/-2),r-=n,l-=n,o.drawImage(t,r,l);var d=o.getImageData(0,0,a,a);e.barcodeDetector.detect(d).then(t=>{t.length&&t.forEach(t=>{addToLog("FOUND "+t.rawValue),document.getElementById("bgModal")||e.isPaused||e.readBarcode(t.rawValue)})}).catch(e=>{addToLog("error api barcode"),console.error("BarcodeDetection failed: "+e)})}}()},400)}}var modulesClass=modules.prototype;modulesClass.eShopModule=function(){var e=this,t=e.modulesData.eShop;if(!t.started){t.started=!0,t.isOpen=!1,t.item=null,t.wishList=[],t.cart=[],document.getElementsByTagName("head")[0].insertAdjacentHTML("beforeend",'<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">'),t.divDimmer=document.createElement("div"),t.divDimmer.id="eShop",e.body.appendChild(t.divDimmer),t.divFlash=document.createElement("div"),t.divFlash.id="eShopFlash",t.divDimmer.appendChild(t.divFlash),t.header=document.createElement("header"),console.log(e.scene),"pk3"==_mainData.url&&(t.header.innerHTML='<img src="/pvrdev/js/modules/logo-fnac.png" alt="logo"/>'),"c1b"==_mainData.url&&(t.header.innerHTML='<img src="/pvrdev/js/modules/logo-sephora.png" alt="logo"/>'),t.divDimmer.appendChild(t.header),t.headerButtonMenu=document.createElement("i"),t.headerButtonMenu.classList.add("fa"),t.headerButtonMenu.classList.add("fa-bars"),t.header.appendChild(t.headerButtonMenu),t.q_cart=document.createElement("span"),t.q_cart.classList.add("q"),t.q_cart.style.float="right",t.q_cart.style.marginLeft="-8px",t.q_cart.style.color="#1D1718",t.q_cart.style.fontSize="18px",t.q_cart.style.lineHeight="50px",t.q_cart.style.display="inline-block",t.q_cart.style.minWidth="15px",t.header.appendChild(t.q_cart),t.headerButtonCart=document.createElement("i"),t.headerButtonCart.classList.add("cart"),t.headerButtonCart.classList.add("fa"),t.headerButtonCart.classList.add("fa-shopping-cart"),t.header.appendChild(t.headerButtonCart),t.q_wishList=document.createElement("span"),t.q_wishList.classList.add("q"),t.q_wishList.style.float="right",t.q_wishList.style.marginLeft="-8px",t.q_wishList.style.color="#1D1718",t.q_wishList.style.fontSize="18px",t.q_wishList.style.lineHeight="50px",t.q_wishList.style.display="inline-block",t.q_wishList.style.minWidth="15px",t.header.appendChild(t.q_wishList),t.headerButtonWishList=document.createElement("i"),t.headerButtonWishList.classList.add("wishList"),t.headerButtonWishList.classList.add("fa"),t.headerButtonWishList.classList.add("fa-star"),t.header.appendChild(t.headerButtonWishList),t.divContent=document.createElement("div"),t.divContent.id="eShopContent",t.divDimmer.appendChild(t.divContent),t.divPrice=document.createElement("div"),t.divPrice.id="eShopPrice",t.divContent.appendChild(t.divPrice),t.divImage=document.createElement("div"),t.divImage.id="eShopImageDiv",t.divContent.appendChild(t.divImage),t.image=document.createElement("img"),t.image.id="eShopImage",t.image.src="",t.divImage.appendChild(t.image),t.divTitle=document.createElement("div"),t.divTitle.id="eShopTitle",t.divContent.appendChild(t.divTitle),t.divButtons=document.createElement("div"),t.divButtons.classList.add("buttons"),t.divContent.appendChild(t.divButtons),t.button=[];var o=-1;o++,t.button[o]=document.createElement("span"),t.button[o].classList.add("eShopButton"),t.button[o].innerHTML='<i class="fa fa-info"></i>',t.divButtons.appendChild(t.button[o]),o++,t.button[o]=document.createElement("span"),t.button[o].classList.add("eShopButton"),t.button[o].innerHTML='<i class="fa fa-star"></i>',t.divButtons.appendChild(t.button[o]),o++,t.button[o]=document.createElement("span"),t.button[o].classList.add("eShopButton"),t.button[o].innerHTML='<i class="fa fa-cart-plus"></i>',t.divButtons.appendChild(t.button[o]);var n=document.createElement("span");n.className="b_close white",t.divDimmer.appendChild(n),n.addEventListener("click",(function(){e.closeEShopModule()})),t.headerButtonWishList.addEventListener("click",(function(){e.openWishList()})),t.headerButtonCart.addEventListener("click",(function(){e.openCart()})),t.button[0].addEventListener("click",(function(){e.openCheckOut()})),t.button[1].addEventListener("click",(function(){e.addToWishList(t.item)&&openModal({h2:"Product added to wish list"})})),t.button[2].addEventListener("click",(function(){t.item.name;openModal({h2:"Product added to cart"}),e.addToCart(t.item)}))}},modulesClass.openCheckOut=function(){var e={type:"embedWebsite",embedWebsiteURL:this.modulesData.eShop.item.productURL};$("#embedContent").css("z-index:110"),this.scene.doAction(e)},modulesClass.openEShopModule=function(e){if((l=this.modulesData.eShop).articles){l.isOpen=!0,e=e.replace(/\s/g,"");var t,o,n=null,i=l.articles;for(t=0;t<i.length;t++)if((o=(o=i[t].value+"").replace(/\s/g,""))&&""!=o&&o==e){n=t;break}if(null!==n){var a=l.articles[n];l.item=a;var s=!1,r=!1;for(t=0;t<l.wishList.length;t++)if(l.wishList[t].value==a.value){s=!0;break}for(t=0;t<l.cart.length;t++)if(l.cart[t].value==a.value){r=!0;break}var l,d="";"eur"==a.currency.toLowerCase()&&(d="€"),l.divTitle.innerText=a.name,l.divPrice.innerText=a.price+" "+d,l.image.src=a.imageURL,l.headerButtonCart.classList.remove("active"),l.headerButtonWishList.classList.remove("active"),l.button[1].classList.remove("active"),s&&(l.button[1].classList.add("active"),l.headerButtonWishList.classList.add("active")),l.button[2].classList.remove("active"),r&&(l.button[2].classList.add("active"),l.headerButtonCart.classList.add("active")),l.divDimmer.style.display="block",window.getComputedStyle(l.divFlash).opacity,l.divFlash.style.opacity=0,(l=this.modulesData.qrReader)&&(l.isPaused=!0)}else addToLog("item not found")}},modulesClass.closeEShopModule=function(){var e,t=this;(e=t.modulesData.eShop).divDimmer.style.display="none",e.divFlash.style.opacity=1,e.isOpen=!1,(e=t.modulesData.qrReader)&&(e.isPaused=!1),(e=t.modulesData.barcodeReader)&&e.isPaused&&e.startCoolDown()},modulesClass.openWishList=function(){var e=this.modulesData.eShop;if(0!=e.wishList.length){var t,o="";for(t=0;t<e.wishList.length;t++)o+=t+1+". "+e.wishList[t].name+"\n",1*e.wishList[t].price;openModal({h2:"Your wish List",p:o},{buttons:!1,closeButton:!0})}else openModal({h2:"Your wish List",p:"your wish List is empty"})},modulesClass.openCart=function(){var e=this,t=e.modulesData.eShop;if(0!=t.cart.length){var o,n="",i=0;for(o=0;o<t.cart.length;o++)i+=1*t.cart[o].price;for(o=0;o<t.cart.length;o++)n+=o+1+". "+t.cart[o].name+"  "+t.cart[o].price+"€\n";openModal({h2:"total "+i+"€",p:n+="\n\nCheck out now?"},{callbackYes:function(){e.openCheckOut()},callbackNo:function(){},textalign:"left",yesButton:"yes",noButton:"later"})}else openModal({h2:"Your cart",p:"your cart is empty"})},modulesClass.addToWishList=function(e){var t=this.modulesData.eShop;for(i=0;i<t.wishList.length;i++)if(t.wishList[i].value==e.value)return openModal({h2:"This product is already in your wish list"}),!1;return t.wishList.push(e),t.button[1].classList.add("active"),t.headerButtonWishList.classList.add("active"),t.q_wishList.innerText=t.wishList.length,!0},modulesClass.addToCart=function(e){var t=this.modulesData.eShop;t.cart.push(e),t.button[2].classList.add("active"),t.headerButtonCart.classList.add("active"),t.q_cart.innerText=t.cart.length};class configuratorModule{constructor(e){var t=this;t.scene=e.scene,t.moduleData=e.modulesData.configurator;var o=t.moduleData;if(t.configData=[],t.configuratorModuleDom=document.createElement("div"),t.configuratorModuleDom.setAttribute("class"," module configuratorModule brandingBg"),t.configuratorModuleDom.setAttribute("data-scene",t.scene.index),t.insertModuleDom(t.configuratorModuleDom),t.configuratorModuleDom.style.display="block",o.name){var n=document.createElement("p");n.className="brandingColor",n.innerText=o.name,t.configuratorModuleDom.appendChild(n)}if(_sessionID||setSessionID(),void 0!==_pubnub){if(null==_pubnub&&o.useSync){var i="scene_"+t.scene.url+"_"+_sessionID;console.log("pubnub CHANNEL "+i),(_pubnub=new xrpubnub({channel:i,configuratorModule:t})).messageCallback=t.messageCallback}}else console.log("NO pubnub a");t.addConfigs()}insertModuleDom(e){document.querySelector("footer .modules").prepend(e)}addConfigs(){var e=this;console.log("add configs");var t=e.moduleData;if(console.log(t.configs),t.configs){e.configData=JSON.parse(JSON.stringify(t.configs));var o=0;t.configs.forEach((function(t){"color"==t.type&&e.addConfigColor(t,o),"texture"==t.type&&e.addConfigTexture(t,o),"material"==t.type&&e.addConfigMaterial(t,o),o++}))}else console.log("no configs");console.log("full config"),console.log(e.configData)}addConfigColor(e,t){var o=this,n=e.palette;if(n&&n.length){var i=document.createElement("div");if(i.setAttribute("class","config color"),i.setAttribute("data-config-index",t),e.name){i.classList.add("name");var a=document.createElement("p");a.className="brandingColor",a.innerText=e.name,i.appendChild(a)}var s=e.materialIndex;if(null!=s){var r,l,d=document.createElement("div");for(i.appendChild(d),r=0;r<n.length;r++)(l=document.createElement("span")).className="color",l.setAttribute("data-index",r),l.setAttribute("data-color",n[r].color),l.setAttribute("data-indexMat",s),l.style.background=n[r].color,d.appendChild(l),l.addEventListener("click",(function(){var e=this.getAttribute("data-index");o.setConfigColor(i,e)}));o.setConfigColor(i,0),o.configuratorModuleDom.appendChild(i)}}}addConfigTexture(e,t){var o=this,n=e.medias;if(n&&n.length){var i=document.createElement("div");if(i.setAttribute("class","config texture"),i.setAttribute("data-config-index",t),e.name){i.classList.add("name");var a=document.createElement("p");a.className="brandingColor",a.innerText=e.name,i.appendChild(a)}var s=document.createElement("div");i.appendChild(s);var r=e.materialIndex;if(null!=r){var l,d,c,u=o.scene.library.data,m=0;n.forEach((function(e){for(c=null,l=0;l<u.length;l++)if((d=u[l]).uid==e.uid){c={url:o.scene.sceneFolder+d.url},_browser.webp&&d.webp&&(c.url=o.scene.sceneFolder+d.webp);break}if(c){var t=document.createElement("div");t.setAttribute("data-index",m),t.setAttribute("data-uid",e.uid),t.setAttribute("data-indexMat",r),t.className="media",s.appendChild(t),t.style.background="url("+c.url+")",t.style.backgroundSize="cover",t.addEventListener("click",(function(){var e=this.getAttribute("data-index");o.setConfigTexture(i,e)})),m++}})),o.setConfigTexture(i,0),o.configuratorModuleDom.appendChild(i)}}}addConfigMaterial(e,t){var o=this,n=e.materials;if(n&&n.length){var i=document.createElement("div");if(i.setAttribute("class","config material"),i.setAttribute("data-config-index",t),e.name){i.classList.add("name");var a=document.createElement("p");a.className="brandingColor",a.innerText=e.name,i.appendChild(a)}var s=document.createElement("div");i.appendChild(s);var r=e.materialIndex;if(null!=r){o.scene.library.data;var l=0;n.forEach((function(e){null,!0;var t=document.createElement("div");t.setAttribute("data-index",l),t.setAttribute("data-uid",e.uid),t.setAttribute("data-indexMat",r),t.className="media",t.innerText="!!"+e.indexMat,s.appendChild(t),t.style.backgroundSize="cover",t.addEventListener("click",(function(){var e=this.getAttribute("data-index");o.setConfigMaterial(i,e)})),l++})),o.setConfigMaterial(i,0),o.configuratorModuleDom.appendChild(i)}}}setFullConfig(e){var t,o;for(console.log("set FULL config"),console.log(e),t=0;t<e.length;t++){o=e[t];var n=document.querySelector('.config[data-config-index="'+t+'"]');"color"==o.type&&this.setConfigColor(n,o.valueIndex,!1),"texture"==o.type&&this.setConfigTexture(n,o.valueIndex,!1)}}setConfigColor(e,t,o=!0){var n=this,i=e.getAttribute("data-config-index"),a=e.querySelector('.color[data-index="'+t+'"]'),s=a.getAttribute("data-indexMat"),r=a.getAttribute("data-color");if(n.scene.materials[s].color=r,n.scene.setupMaterials(),e.querySelectorAll(".color").forEach(e=>{e.classList.remove("active")}),a.classList.add("active"),n.configData[i].valueIndex=t,o){var l={configIndex:i,type:"color",value:t};n.sendConfigMessage(l)}}setConfigTexture(e,t,o=!0){var n=this,i=e.getAttribute("data-config-index"),a=e.querySelector('.media[data-index="'+t+'"]'),s=a.getAttribute("data-uid"),r=a.getAttribute("data-indexMat"),l=n.scene.getLibraryItemByUid(s);if(n.scene.library.loadImageTexture(l,null,(function(){var e=n.scene.materials[r];void 0===e.colorMap&&(console.log("NO color map for configurator mat"),e.colorMap={}),e.colorMap.uid=s,n.scene.setupMaterials()})),e.querySelectorAll(".media").forEach(e=>{e.classList.remove("active")}),a.classList.add("active"),n.configData[i].valueIndex=t,o){var d={type:"texture",configIndex:i,value:t};n.sendConfigMessage(d)}}setConfigMaterial(e,t,o=!0){e.getAttribute("data-config-index"),e.querySelector('.media[data-index="'+t+'"]');console.log("set amt")}sendConfigMessage(e){this.moduleData.useSync&&(void 0!==_pubnub?(e.config=!0,_pubnub.submitUpdate(e)):console.log("NO pubnub b"))}messageCallback(e,t){if(t.hello&&_browser.desktop)return console.log("SEND FULL config"),(t={config:!0}).fullConfig=e.configData,void _pubnub.submitUpdate(t);e.applyMessageConfig(t)}applyMessageConfig(e){console.log("applyMessageConfig");var t=e.configIndex,o=document.querySelector('.config[data-config-index="'+t+'"]');"color"==e.type&&this.setConfigColor(o,e.value,!1),"texture"==e.type&&this.setConfigTexture(o,e.value,!1)}}class skyboxModule{constructor(e){var t=this;t.scene=e.scene,t.moduleData=e.modulesData.skybox;var o=t.scene,n=_app.scene3,i=t.moduleData;if("image"==o.trackingMode&&"ar"==_config.mode)return void console.log("--\x3e no skybox on imagetracking");addToLog("--\x3e mod skybox for "+o.index+" "+_app.xr);var a={topColor:{type:"c",value:new THREE.Color(i.top)},bottomColor:{type:"c",value:new THREE.Color(i.bottom)},offset:{type:"f",value:40},exponent:{type:"f",value:.6},alpha:{type:"f",value:i.opacity}},s=new THREE.ShaderMaterial({uniforms:a,vertexShader:"\n\t\tvarying vec3 vWorldPosition;\n\t\tvoid main() {\n\t\t\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n\t\t\tvWorldPosition = worldPosition.xyz;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t}",fragmentShader:"\n\t\tuniform vec3 topColor;\n\t\tuniform vec3 bottomColor;\n\t\tuniform float offset;\n\t\tuniform float exponent;\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float alpha;\n\t\tvoid main() {\n\t\t\tfloat h = normalize( vWorldPosition + offset ).y;\n\t\t\tgl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h, 0.0 ), exponent ), 0.0 ) ), alpha );\n\t\t}",side:THREE.BackSide,transparent:!0}),r=1400;"ar"==_app.currentMode&&_app.xr&&(r=100);var l=new THREE.SphereGeometry(r,32,15);o.skyBox=new THREE.Mesh(l,s),o.skyBox.name="skyBox",n.add(o.skyBox),o.index==_app.activeScene.index?o.skyBox.visible=!0:o.skyBox.visible=!1}}function inlineScene(e){this.common=new common(this),this.scenesJson=e.scenesData,this.nbScenes=e.scenesData.length,this.currentMode=_config.mode,this.renderer=null,this.controls=null,this.clock=null,this.skyBox=null,this.scenes=[],this.indexSceneActive=0,this.indexSceneLoading=0,this.loadingScene=null,this.activeScene=null,this.loopIsPaused=!1,this.needResize=!1,this.camera=null,this.scene3=null,this.isBundle=!1,this.tracking=null,this.bundle=null,this.gridHelper=null,this.floor=null,this.isTurntableOn=!1,this.isTurntableClockwise=!1,this.playerInline=null,this.domControls=null,this.playerSkyBox=null,this.tweenGroupSwing=null,"bundle"==e.type&&(this.isBundle=1),this.isBundle&&(this.bundle=e.settings.bundle),this.isInline=!0,this.addOrbitControls=function(){var e=this;e.controls||(addToLog("ADD orbit controls for inline + + + + "),e.controls=new THREE.OrbitControls(e.camera,e.renderer.domElement),e.controls.maxDistance=15,e.controls.screenSpacePanning=!0,e.controls.maxPolarAngle=65*Math.PI/100)},this.setNewData=function(e){var t=this;_$body.addClass("ddd"),t.renderer||t.createRenderer();var o=t.scenesJson[e];t.indexSceneLoading=e,t.scenes[e]=new scene(o,e,t.currentMode,this),t.scenes[e].isInline=!0,0==e&&(t.activeScene=t.scenes[0]),t.loadingScene=t.scenes[e],t.addMessageListener(),document.onkeydown=function(e){"Escape"!==(e=e||window.event).key&&"Esc"!==e.key||(console.log("escape full screen"),t.common.postMessage({action:"toggleFullPage",value:!1}))}},this.createRenderer=function(){var e=this,t=1;_config.isDebug&&!_config.ios&&(t=2);var o={antialias:!0,canvas:_canvas};1==t&&THREE.REVISION>=123?e.renderer=new THREE.WebGL1Renderer(o):e.renderer=new THREE.WebGLRenderer(o),e.renderer.capabilities.isWebGL2?console.log("WebGL 2"):console.log("WebGL 1"),e.renderer.toneMapping=THREE.NoToneMapping,e.renderer.toneMappingExposure=1;var n=2;_browser.desktop&&(n=1),e.renderer.setPixelRatio(n),e.renderer.setClearColor(4210752,1),e.renderer.setSize(window.innerWidth,window.innerHeight)},this.keepInlineScene=function(e){var t=this;console.log("///////////////////// INLINE"),console.log("NO NEW SCENE INSTANCE"),t.renderer||(t.createRenderer(),console.log("create scene3 + camera"),t.scene3=new THREE.Scene,t.camera=new THREE.PerspectiveCamera,t.scene3.add(t.camera));var o=document.getElementById("fail");o&&o.parentElement.removeChild(o),$("#startPanel").css("display:none;");_$body.addClass("ddd"),$("#threejs").css("transform:none;"),$("#overThreejs").css("width:auto;height:auto;"),t.indexSceneLoading=0,t.scenes[0]=e[0],t.scenes[0].p_xr=_xrInline,t.activeScene=t.scenes[0],t.loadingScene=t.scenes[0];var n=t.loadingScene;console.log("rootOrientation"),console.log(n.rootOrientation),console.log("rootComposition"),console.log(n.rootComposition),n.rootOrientation.parent!=t.scene3&&console.log("NOT SCENE 3 from nilne"),n.rootOrientation.parent&&n.rootOrientation.parent==t.scene3||(console.log("move root Ori to scene3"),t.scene3.add(n.rootOrientation),n.rootOrientation.visible=!0),n.removeLights(),t.floor&&(t.floor.visible=!0),n.rootOrientation.position.set(0,0,0),n.rootOrientation.rotation.set(0,0,0),n.rootXR.rotation.set(0,0,0),n.rootComposition.rotation.set(0,0,0);n.rootXR.scale.set(1,1,1),console.log("set active after coming back to ddd");n.setActive(!0)},this.initScene3=function(){var e=this;console.log("%c INIT SCENE3 INLINE --------- ","color: #ff33cc"),_$body.addClass("inlineScene"),_$body.removeClass(e.activeScene.settings.trackingMode);var t="Please udpate the AR player in XR+ studio\n"+e.activeScene.url;_mainData.player.inline||alert(t),_mainData.player.inline.controls||alert(t),e.playerInline=_mainData.player.inline,$("body.inlineScene>#logo").css("display:none;"),e.playerInline.logo.enabled&&$("body.inlineScene>#logo").css("display:block;");var o=e.loadingScene;if(o.isCompScene||alert("not a comp scene!"),e.scene3=null,e.camera=null,e.scene3=new THREE.Scene,e.camera=new THREE.PerspectiveCamera,e.scene3.add(e.camera),_keepComposition?e.allSceneDataLoaded():(o.load(),e.common.gaEvent({event:"start 3D",event_category:"player",event_label:"start 3D"})),_config.isDebug){e.gridHelper=new THREE.GridHelper(10,20,16777215,10526880),e.gridHelper.name="gridHelper",e.gridHelper.position.set(0,-2.02,0),e.gridHelper.rotation.set(0,THREE.Math.degToRad(-90),0),e.scene3.add(e.gridHelper)}var n,i,a=new THREE.SphereGeometry(150,64,64);n=e.playerInline.skybox.top,i=e.playerInline.skybox.bottom,a.computeBoundingBox();var s=new THREE.ShaderMaterial({uniforms:{color1:{value:new THREE.Color(i)},color2:{value:new THREE.Color(n)},bboxMin:{value:a.boundingBox.min},bboxMax:{value:a.boundingBox.max}},vertexShader:"\n\t\t    uniform vec3 bboxMin;\n\t\t    uniform vec3 bboxMax;\n\t\t    varying vec2 vUv;\n\t\t    void main() {\n\t\t      vUv.y = (position.y - bboxMin.y) / (bboxMax.y - bboxMin.y);\n\t\t\t  vUv.y = vUv.y * 1.6;\n\t\t\t  if (vUv.y > 1.0)vUv.y = 1.0;\n\t\t      gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);\n\t\t    }",fragmentShader:"\n\t\t    uniform vec3 color1;\n\t\t    uniform vec3 color2;\n\t\t    varying vec2 vUv;\n\t\t    void main() {\n\t\t      gl_FragColor = vec4(mix(color1, color2, vUv.y), 1.0);\n\t\t    }",side:THREE.BackSide});e.playerSkyBox=new THREE.Mesh(a,s),e.playerSkyBox.name="360",e.scene3.add(e.playerSkyBox),e.addOrbitControls(),e.common.addWindowEvents()},this.addButtons=function(){var e=this;if(addToLog("inline: add buttons"),!$("#b_viewInAR").value.length){var t=document.createElement("span");t.id="b_viewInAR",t.innerText=e.playerInline.texts.viewInAR,t.className="button";var o=t.style;o.background=e.playerInline.controls.buttons.viewInAR.bgColor,o.color=e.playerInline.controls.buttons.viewInAR.color,e.domControls.appendChild(t),$("#b_viewInAR").on("click",(function(){e.setMode("ar")}))}},this.addControlsBar=function(){var e=this;if(!e.domControls){var t=e.playerInline.controls;e.domControls=document.createElement("div"),e.domControls.id="controls";var o=t.bgColor+""+parseInt(255*t.bgAlpha).toString(16);if(e.domControls.style.background=o,document.querySelector("footer").appendChild(e.domControls),_browser.share&&t.buttons.share.enabled){var n;(n=document.createElement("span")).className="b_share";var i=document.createElement("img");i.src="/assets/icons/icon-share.svg",n.appendChild(i),e.domControls.appendChild(n)}_needVolumeButton&&e.addVolumeButton(),(n=document.createElement("span")).className="b_fullScreen";var a=document.createElement("img");a.src="/assets/icons/icon-fullscreen.svg",n.appendChild(a),e.domControls.appendChild(n),$("#controls .b_fullScreen").on("click",(function(){e.common.postMessage({action:"toggleFullPage"})})),$("#controls .b_share").on("click",(function(){shareScene()}))}},this.addVolumeButton=function(){var e=document.createElement("span");e.className="b_volume";var t=document.createElement("img");t.className="on",t.src="/assets/icons/icon-audio-on.svg";var o=document.createElement("img");o.src="/assets/icons/icon-audio-off.svg",o.className="off",e.appendChild(t),e.appendChild(o),this.domControls.appendChild(e);var n=$(".b_volume");_isVolumeOn?n.removeClass("off").addClass("on"):n.removeClass("on").addClass("off"),n.on("click",(function(){toggleVolume()}))},this.addAttractor=function(){},this.removeAttractor=function(){var e=document.getElementById("attractor");e&&e.parentElement.removeChild(e)},this.allSceneDataLoaded=function(){var e=this;e.addControlsBar(),e.addButtons(),e.addAttractor(),"image"!=e.loadingScene.trackingMode&&e.addSlamSkybox(),0==e.indexSceneLoading&&_screens.loading.hideScreen(),0==e.indexSceneLoading&&(_screens.start.isRequired?_screens.start.showScreen():e.start()),$("#sceneSelector li").length&&$("#sceneSelector li").eq(e.indexSceneLoading).css("visibility:visible;"),e.common.loadNextScene()},this.start=function(){var e=this;_screens.intro.visible||(e.startLoop(),e.indexSceneLoading!=e.indexSceneActive&&1!=e.multipleTracking||e.selectScene(e.indexSceneLoading))},this.addSlamSkybox=function(){var e=this,t=e.loadingScene,o=t.settings.slam.skybox;if(o&&o.enabled){var n=document.getElementById("vertexShader").textContent,i=document.getElementById("fragmentShader").textContent,a={topColor:{type:"c",value:new THREE.Color(o.top)},bottomColor:{type:"c",value:new THREE.Color(o.bottom)},offset:{type:"f",value:40},exponent:{type:"f",value:.6},alpha:{type:"f",value:o.opacity}},s=new THREE.ShaderMaterial({uniforms:a,vertexShader:n,fragmentShader:i,side:THREE.BackSide,transparent:!0}),r=new THREE.SphereGeometry(140,32,15);t.skyBox=new THREE.Mesh(r,s),t.skyBox.name="skyBox",e.scene3.add(t.skyBox),t.index==e.activeScene.index?t.skyBox.visible=!0:t.skyBox.visible=!1}},this.selectScene=function(e){var t=this;if(addToLog("- - - selectScene "+e+" - - -"),t.scenes[e]){t.indexSceneActive=e,t.activeScene=t.scenes[t.indexSceneActive];var o=t.activeScene;if(t.common.showSkyBox(t.indexSceneActive),t.common.pauseAllVideoTextures(!0),t.scenes.forEach((function(e){t.scene3.remove(e.rootXR)})),t.scenes.forEach((function(e){e.rootOrientation&&t.scene3.remove(e.rootOrientation)})),o.rootOrientation.add(o.rootXR),t.scene3.add(o.rootOrientation),"fixed"==o.trackingMode){var n=o.settings.fixed.scale/100;o.rootComposition.scale.set(n,n,n)}o.setupMainScreen();o.setActive(!0),t.setupCameraPosition()}else console.log("scene not ready")},this.getScreenPosition=function(e){var t=this;t.camera;t.controls.update(),t.renderer.render(t.scene3,t.camera);var o=new THREE.Vector3;return(o=o.setFromMatrixPosition(e.matrixWorld)).project(t.camera),o.x=o.x.toFixed(2),o.y=o.y.toFixed(2),o.z=0,o},this.setupCameraPosition=function(){var e=this;console.log("INLINE set camera position");var t=e.activeScene.rootXR,o=e.camera,n=-2.5;e.controls||(console.log("adding orbit in setupCameraPosition"),e.addOrbitControls()),e.controls||console.log("WARNING inline setupCameraPosition --- no orbit controls"),e.controls&&e.controls.update(),e.renderer.render(e.scene3,o);var i=new THREE.BoxHelper(t,16755200);_config.isDebug&&t.add(i),i.geometry.computeBoundingBox();const a=new THREE.Box3;a.copy(i.geometry.boundingBox).applyMatrix4(i.matrixWorld);var s=new THREE.BoxGeometry(.05,.05,.05),r=new THREE.MeshNormalMaterial,l=new THREE.Mesh(s,r);l.position.set(a.min.x,a.max.y,a.max.z),t.add(l);var d=new THREE.Mesh(s,r);d.position.set(a.max.x,a.max.y,a.max.z),t.add(d);var c=new THREE.Mesh(s,r);c.position.set(a.min.x,a.min.y,a.max.z),t.add(c);var u=new THREE.Mesh(s,r);u.position.set(a.max.x,a.min.y,a.max.z),t.add(u);var m=new THREE.Mesh(s,r);m.position.set((a.min.x+a.max.x)/2,(a.min.y+a.max.y)/2,a.max.z),t.add(m),_config.isDebug||(l.visible=!1,d.visible=!1,c.visible=!1,u.visible=!1,m.visible=!1),t.position.set(0,n,0),o.position.set(0,2,7),e.controls.update(),e.renderer.render(e.scene3,o);var p=!1,h=e.getScreenPosition(l),g=e.getScreenPosition(c),v=h.y-g.y;var f=e.getScreenPosition(d).x-h.x;var b,y=e.getScreenPosition(m);var x=0;for(v>.01&&f>3*v&&(x=-.4),b=0;b<12;b++){if(v<1.6&&f<1.6){o.translateZ(-.5),b<3&&o.translateZ(-.5);h=e.getScreenPosition(l),g=e.getScreenPosition(c),f=e.getScreenPosition(d).x-h.x;v=(v=h.y-g.y).toFixed(2),f=f.toFixed(2)}if(v>1.7||f>1.7){o.translateZ(.5),b<3&&o.translateZ(.5);h=e.getScreenPosition(l),g=e.getScreenPosition(c),f=e.getScreenPosition(d).x-h.x;v=(v=h.y-g.y).toFixed(2),f=f.toFixed(2)}y.y<x-.1&&(n+=.2,b<3&&(n+=.2),t.position.set(0,n,0),y=e.getScreenPosition(m)),y.y>x+.1&&(n-=.2,b<3&&(n-=.2),t.position.set(0,n,0),y=e.getScreenPosition(m))}if(e.playerSkyBox.position.y=n,"swing"==e.playerInline.animation.type){t.rotation.set(0,0,0);var w=1*e.playerInline.animation.angle,T=500*(5-1*e.playerInline.animation.speed),E={x:0,y:THREE.Math.degToRad(-1*w),z:0},S={x:0,y:THREE.Math.degToRad(w),z:0};e.tweenGroupSwing=new TWEEN.Group;var _=new TWEEN.Tween(t.rotation,e.tweenGroupSwing).to(E,T).easing(TWEEN.Easing.Quadratic.InOut),M=new TWEEN.Tween(t.rotation,e.tweenGroupSwing).to(S,T).easing(TWEEN.Easing.Quadratic.InOut);_.chain(M),M.chain(_),_.start(),e.activeScene.threejsCanvas.addEventListener(_clickOrTouch,(function(e){}),!1)}if(e.gridHelper&&e.gridHelper.position.set(0,n-.02,0),e.playerInline.floor.enabled){var C=1*e.playerInline.floor.size,L=new THREE.PlaneGeometry(C,C),R=e.playerInline.floor.color;(r=new THREE.MeshBasicMaterial({color:R,side:THREE.DoubleSide,transparent:!0})).map=(new THREE.TextureLoader).load("/assets/textures/white-shadow.png"),e.floor=new THREE.Mesh(L,r),e.floor.position.set(0,n-.02,0),e.floor.rotation.set(THREE.Math.degToRad(-90),0,0),e.floor.renderOrder=-1,e.scene3.add(e.floor)}},this.startLoop=function(){var e=this;if(addToLog("INLINE start loop"),e.common.postMessage({status:"ready"}),null==e.clock){window.addEventListener("resize",(function(){e.onWindowResize(e)}),!1),e.onWindowResize(e),"turntableClockwise"==e.playerInline.animation.type&&e.toggleTurnTable(!0,!0),"turntableAnticlockwise"==e.playerInline.animation.type&&e.toggleTurnTable(!0,!1),e.clock=new THREE.Clock;e.renderer.setAnimationLoop((function(){var t=e.clock.getDelta();if(!e.loopIsPaused){if(e.activeScene.loop(t),e.controls.update(t),TWEEN.update(),e.tweenGroupSwing&&e.tweenGroupSwing.update(),e.isTurntableOn){var o=e.playerInline.animation.speed;e.isTurntableClockwise&&(o*=-1),e.activeScene.rootModels.rotateY(t/3*o),e.activeScene.rootMedias.rotateY(t/3*o)}e.renderer.render(e.scene3,e.camera),e.needResize&&(e.onWindowResize(e),e.needResize=!1)}}))}},this.resumeLoop=function(){var e=this;addToLog("INLINE resume loop"),e.common.closeStartPanel(!1,!1),e.indexSceneLoading!=e.indexSceneActive&&1!=e.multipleTracking||e.selectScene(e.indexSceneLoading),e.clock||e.startLoop(),console.log("REDO ORBIT CONTROLS"),e.addOrbitControls(),e.common.postMessage({action:"backToDDD"}),e.loopIsPaused=!1,e.needResize=!0},this.onWindowResize=function(e){if(!e.loopIsPaused){var t=window.innerWidth,o=window.innerHeight;e.camera.aspect=t/o,e.camera.updateProjectionMatrix(),e.renderer.setSize(t,o)}},this.addMessageListener=function(e){e=this;window.addEventListener("message",(function(t){var o=t.data;if(!o)return;o.setMode&&e.setMode(o.setMode)}),!1)},this.setMode=function(e){var t=this;if("ar"==e)if(_browser.desktop){var o=document.createElement("div");o.id="qrCodeInline",_body.appendChild(o);var n=document.createElement("p");n.innerText=t.playerInline.texts.scan,o.appendChild(n);var i=document.createElement("span");i.id="b_closeQR",i.className="b_close",o.appendChild(i),$("#b_closeQR").on("click",(function(){t.setMode("ddd")})),_$body.addClass("inlineQR");var a=_visitUrl;if(a+="#xrp"+t.activeScene.url,_sessionID&&(a+="xrid"+_sessionID),displayQRCode(a,o,!1,190),"image"==t.activeScene.trackingMode){var s=document.createElement("img"),r=_rootDirectory+"assets/xrplus-marker-512.png",l=t.activeScene.data.pattern;l&&l.id&&(r=_rootDirectory+"p/"+l.folder+"/"+l.id+"/"+l.url),s.src=r,s.className="marker",s.title="",o.appendChild(s),$("#qrCodeInline .marker").on("click",(function(){$("#qrCodeInline").toggleClass("bigMarker")}))}$("#threejs").css("filter:blur(3px)"),t.common.postMessage({action:"showQRCode"})}else t.common.postMessage({action:"startAR"}),t.switchToAR();"ddd"==e&&(t.hideQRCode(),console.log("INLINE : asked to set mode ddd"),_body.classList.contains("ddd")||(console.log("TO DO+ -- > back to 3d mode"),t.switchToInline()))},this.hideQRCode=function(){var e=document.getElementById("qrCodeInline");e&&e.parentElement.removeChild(e),_$body.removeClass("inlineQR"),$("#threejs").css("filter:none")},this.switchToAR=function(){var e=this;console.log("SWITCH TO AR "+_config.sceneURL),e.common.gaEvent({event:"switch to AR",event_category:"player",event_label:"switch to AR"}),_$body.removeClass("ddd"),_$body.addClass(e.activeScene.settings.trackingMode),e.controls&&(console.log("DISPOSE ORBIT CONTROLS"),e.controls.dispose(),e.controls=null),e.floor&&(e.floor.visible=!1),e.loopIsPaused=!0,_keepComposition=!0,_isInline=!1,startAR(0,_mainData);var t=_rootDirectory+"d/get-scene-front.php?url="+_config.sceneURL+"&ar";_config.isDebug&&(t+="&d"),_config.isPreview&&(t+="&s"),_config.noViews&&(t+="&s"),_config.isMap&&(t+="&s");var o=new XMLHttpRequest;o.open("GET",t,!0),o.onload=function(){o.status>=200&&o.status<400?console.log("+1"):console.log("error a addv")},o.onerror=function(){console.log("error b addv")},o.send()},this.switchToInline=function(){var e=this;console.log("SWITCH TO INLINE+"),e.common.gaEvent({event:"switch to 3D",event_category:"player",event_label:"switch to 3D"}),$("#startPanel").css("display:none;"),_$body.removeClass(e.activeScene.settings.trackingMode),_xr.loopIsPaused=!0,e.loopIsPaused=!0,_keepComposition=!0,_isInline=!0,startAR(0,_mainData)},this.toggleTurnTable=function(e,t){console.log("toggleTurnTable "+e),this.isTurntableOn=e,this.isTurntableClockwise=t},this.stopSwing=function(){var e=this,t=e.activeScene.rootXR;addToLog("stop SWING"),$("#bgModal").length>0||e.tweenGroupSwing&&(t.rotation.set(0,0,0),e.tweenGroupSwing.removeAll(),e.tweenGroupSwing=null)}}class introScreen{constructor(e){var t=this;t.playerData=e,t.screenData=t.playerData.introScreen,t.playerAssetsFolder=t.playerData.assetsFolder,t.visible=!1,t.screenData&&t.screenData.enabled&&(t.buildScreen(),t.showScreen())}buildScreen(){var e=this,t=e.screenData,o=document.createElement("span");if(t.introButton.useImage&&t.introButton.png){o.className="introButton image";var n=document.createElement("img");n.src=e.playerAssetsFolder,_browser.webp?n.src+=t.introButton.webp:n.src+=t.introButton.png,n.alt="",n.title="",o.appendChild(n)}else{o.className="introButton";var i=t.introButton.text;o.innerText=i}document.getElementById("introScreen").appendChild(o),$("#introScreen .introButton").on(_clickOrTouch,(function(){setTimeout((function(){e.buttonAction()}),100)}))}buttonAction(){this.hideScreen(),_app.activeScene.isReady&&(_screens.start.isRequired||_app.start())}showScreen(){this.visible=!0,$("#introScreen").css("display:block;")}hideScreen(){this.visible=!1,$("#introScreen").css("display:none;")}}class loadingScreen{constructor(e){}updateLoader(e){e>100&&(e=100),$("#fill").css("width:"+1*e+"%")}setTexts(e){var t=e.player;if(t.loadingScreen){var o=t.loadingScreen.texts;(o.loading||""===o.loading)&&$("[data-text='loadingTheMagic']").text(o.loading)}}showScreen(){$("#sceneLoader").css("display:block;")}hideScreen(){$("#sceneLoader").css("display:none;")}}class startScreen{constructor(e){this.isRequired=!1,this.visible=!1}setTexts(e){var t=e.player;if(t&&t.loadingScreen){var o=t.loadingScreen.texts;o.start&&$("[data-text='start']").text(o.start)}}openStartPanel(e=!1,t=!1){var o=this,n=_app,i=n.activeScene;addToLog("STARTSCREEN open start panel"),n.needDeviceOrientationPermission&&addToLog("need Ori Permission"),i.isStartPanelOpen=!0,i.needCookieContent&&$("#startPanel .cookieInfo").css("display:block;"),$("#startPanel").css("display:block;"),_$body.addClass("playPanel");var a=document.getElementById("startPanel");(r=a.querySelector(".startButton"))&&r.parentElement.removeChild(r);var s=_mainData.player,r=document.createElement("span");if(s.loadingScreen&&s.loadingScreen.startButton&&s.loadingScreen.startButton.useImage&&s.loadingScreen.startButton.png){r.className="startButton image";var l=document.createElement("img");_browser.webp?l.src=s.startButtonWebp:l.src=s.startButtonPng,l.alt="",l.title="",r.appendChild(l)}else{r.className="startButton flash";var d="START AR EXPERIENCE",c=getText("start");c&&(d=c),_pTexts&&_pTexts.loadingScreen&&(d=_pTexts.loadingScreen.start),r.innerText=d}a.insertBefore(r,a.firstChild),(r=a.querySelector(".backButton"))&&r.parentElement.removeChild(r);var u=i.settings;u.embed&&u.embed.backButton&&u.embed.backButton.enabled&&((r=document.createElement("a")).href=u.embed.backButton.url,r.setAttribute("target","_top"),r.className="backButton",r.innerText="",a.insertBefore(r,a.firstChild));$("#startPanel .startButton").on("click",(function(){"undefined"==typeof startGA||_gaStarted||startGA(),t?_app.openUSDZ():n.needDeviceOrientationPermission?(addToLog("/// fake start 300"),i.fakeStartAllSceneVideos(),setTimeout((function(){_app.askDeviceOrientationPermission()}),300)):o.closeStartPanel(e,!0)}));var m=i.modules;m.other&&1==m.other.enabled&&m.other.customStartScreen&&i.modulesEngine.otherModule.openStartScreen()}closeStartPanel(e=!1,t=!0){var o=_app;this.hideScreen(),t&&o.activeScene.closeStartPanel(),e&&o.immersiveAR()}showScreen(e=!1,t=!1){this.visible=!0,$("#startPanel").css("display:block;"),this.openStartPanel(e,t)}hideScreen(){this.visible=!1,$("#startPanel").css("display:none;"),_$body.removeClass("playPanel"),this.isRequired=!1}}class errorScreen{constructor(){this.visible=!1,this.options={},this.checkPermission("camera",!0)}checkPermission(e,t=!1){var o=this,n=!1;_browser.ios||("chrome"==_browser.name&&_browser.version>=64&&(n=!0),"samsungbrowser"==_browser.name&&(n=!0),"edge"==_browser.name&&(n=!0)),n&&navigator.permissions&&navigator.permissions.query({name:e}).then(e=>{if(addToLog("perm "+e.state),t&&"denied"==e.state){var n="";"samsungbrowser"==_browser.name?(n="To continue, allow the camera in the settings:",n+="\n\n1. tap the &#9776; icon",n+="\n2. Open Settings",n+="\n3. Select Privacy and security",n+="\n4. Select Delete browsing data",n+="\n5. Make sure Location access data is selected and tap on Delete",n+="\n\nYay!"):(n="To continue, allow the camera in the website settings.",n+="\n\nTap the &#128274; icon to edit those settings."),o.showScreen({h:"Camera permission error",text:n})}e.onchange=e=>{if("change"===e.type){var t=window.location.href;document.location=t}}}).catch((function(e){console.log("->perm api error"),console.log(e)}))}showScreen(e){_config.isDebug&&console.log(e);var t=this;if(!t.visible){if(t.visible=!0,t.options=e,_config.isDebug)var o=document.getElementById("mainLog").textContent;if(document.body.innerHTML="",_config.isDebug){var n=document.createElement("div");n.id="mainLog",n.innerHTML=o,document.body.appendChild(n),addToLog("fb: "+_browser.isFacebook)}var i=document.createElement("div");i.id="errorScreen",document.body.appendChild(i);var a=(e=t.options).errorName;void 0===a&&(a=""),"NotFoundError"==a&&(a="No camera detected"),"NotAllowedError"==a&&(a="Access to camera has been denied"),"AbortError"==a&&(a="\nCould not access camera.\n Already used by another app?"),"NotReadableError"==a&&(a="\nCould not access camera.\n Already used by another app?"),e.text&&(a=e.text+"\n"+a),"camera"==e.what&&"samsungbrowser"==_browser.name&&(a+="\n\nMake sure 'video autoplay' is enabled\n\n(settings -> useful features)");var s=document.createElement("div");s.id="message";var r="";if(r+="<h2>"+e.h+"</h2>",r+="<p>"+a+"</p>",s.innerHTML=r,i.appendChild(s),e.showHelp){var l=document.createElement("span");_browser.android&&(l.id="helpOpenBrowser",l.innerHTML="To continue,\n tap here and choose \n 'Open in ...'"),_browser.ios&&(l.id="helpOpenSafari",l.innerHTML="Tap here and choose\nOpen in ..."),i.appendChild(l)}if(e.showTryAgain){var d=document.createElement("span");d.classList.add("button"),d.textContent="Try again",s.appendChild(d),d.onclick=function(e){e.preventDefault();var t=window.location.href;document.location=t}}var c=document.createElement("p");c.id="systemDetails",_browser.android&&(c.innerText="Android | "+_browser.name+" "+_browser.version),_browser.ios&&_browser.iOSVersion&&(c.innerText="iOS "+_browser.iOSVersion+" | "+_browser.name+" "+_browser.version),_browser.inApp&&(c.innerText+=" (inside app)"),c.style.fontSize="12px",c.style.color="#a0a0a0",c.style.position="fixed",c.style.textAlign="center",c.style.left="0",c.style.right="0",c.style.bottom="20px",i.appendChild(c)}}}class checksAR{constructor(e,t){this.ok=1,this.missing=null,this.urlAR=window.location.href,-1!==navigator.userAgent.indexOf("MicroMessenger")&&alert("This is weChat - iOS "+_browser.iOSVersion),this.start()}start(){if("#"===this.urlAR.substr(-1)&&(this.urlAR=this.urlAR.substr(0,this.urlAR.length-1)),"http:"==location.protocol&&alert("https:// protocol is required"),_browser.insideIframe)try{this.urlAR=window.location!=window.parent.location?document.referrer:document.location.href}catch(e){console.error("catch urlAR")}if(_browser.ios){var e=!1;if(_browser.userMedia||(e=!0),e){var t="<br/>Please open this page in Safari<br/>&nbsp;";"es"==_language.substring(0,2)&&(t="<br/>Por su versión de iOS, <br/>necesitará usar Safari para continuar<br/>&nbsp;"),this.ok=0,this.missing=" saf or viewer";var o=!1;return _browser.inApp&&(o=!0),void this.showFail(t,{showHelp:o})}var n=0;null!=(a=this.iOSversion())&&(n=a[0]);var i=!1;if("MacIntel"===navigator.platform&&navigator.maxTouchPoints>1&&(i=!0),n<11&&!i){t="Unfortunately, <br/>augmented reality on the web requires iOS 11 or newer.<br/>&nbsp;";return this.missing=" ios11",this.ok=0,void this.showFail(t)}}if(document.body.classList.contains("slam")&&"webxrviewer"==_browser.name||_browser.userMedia||(this.ok=0,this.missing=" userMedia"),this.ok||addToLog("check failed "+this.missing),_browser.desktop&&!this.ok){t="Unfortunately, <br/>This browser cannot display<br/>Augmented Reality content.<br/>";console.log("show fail c"),this.showFail(t)}if(_browser.ios&&!this.ok){t="<br/>"+this.urlAR+"<br/><br/>";t+="Unfortunately, <br/>This browser cannot display<br/>Augmented Reality content.<br/><br/>",t+="Please open this page in Safari<br/><br/>",console.log("show fail d"),this.showFail(t)}if(_browser.android){var a;if(_browser.isFacebook&&(this.ok=0),_browser.isInstagram&&(this.ok=0),"chrome"==_browser.name)if(null!=(a=_browser.version)&&a<57){t="This version of Chrome ("+a+") is too old, <br/><br/>update it and try again.";return void this.showFail(t)}if(!this.ok){var s=!0;if(_browser.isFacebook&&(s=!1),_browser.isInstagram&&(s=!1),s&&(t='Unfortunately, <br/>This browser cannot display<br/>Augmented Reality content.<br/><br/><a href="#" id="chromeButton">Tap here</a> <br/>to visit this page in Chrome.<br/><br/>'),s||(t="Unfortunately, <br/>This browser cannot display<br/>Augmented Reality content<br/>"),"function"==typeof catchBrowserfail)return void catchBrowserfail();o=s;this.showFail(t,{showHelp:o});!1}}}showFail(e,t={}){addToLog("show fail + hide start "+_browser.name),_browser.android&&_browser.inApp&&(t.showHelp=!0,t.showTryAgain=!1),_screens.error.showScreen({h:"Error",text:e,errorName:t.errorName,what:"camera",showTryAgain:t.showTryAgain,showHelp:t.showHelp})}iOSversion(){if(/iP(hone|od|ad)/.test(navigator.platform)){var e=navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/);return[parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3]||0,10)]}}}function WasmSupported(){var e=!1;try{var t=new Uint8Array([0,97,115,109,1,0,0,0,1,7,1,96,2,127,127,1,127,3,2,1,0,7,7,1,3,88,79,82,0,0,10,9,1,7,0,32,0,32,1,115,11]),o=new WebAssembly.Instance(new WebAssembly.Module(t)).exports.XOR;if(57005!==o(65280,8621)||48879!==o(43605,5306))throw!1;e=!0}catch(t){e=!1}return e}function removePreloader(){var e=document.getElementById("preloader");e&&e.parentElement.removeChild(e)}function removeAccessPanel(){var e=document.getElementById("access");e&&e.parentElement.removeChild(e)}if(console.log("XR+ 2021 03 11"),!_config.isDebug)var getArguments=function(){return arguments},_arguments=getArguments(),_isDesktop=_browser.desktop;_isDesktop&&(_clickOrTouch="click");var _sessionID,_canvas=document.getElementById("threejs"),_video=null,_mainData=null,_isBundle=!1,_app=null,_xrInline=null,_xr=null,_isInline=_config.isInline,_checks=null,_body=document.body,_$body=$("body"),_nft=null,_flow=null,_keepComposition=!1,_needVolumeButton=!1,_isVolumeOn=!0,_screens={};function gestureChange(e){1!==(e=e.originalEvent||e).scale&&(e.preventDefault(),_body.style.transform="scale(1)")}_browser.webp||_body.classList.add("noWebp"),_isInline&&toggleVolume(!1),_body.addEventListener("gesturechange",gestureChange,!1),_body.addEventListener("touchmove",gestureChange,!1);var _visitUrl=document.location.href;try{_visitUrl=window.location!=window.parent.location?document.referrer:document.location.href}catch(e){console.error("catch visiturl err")}_config.parent&&(_visitUrl=_config.parent);var fbp=_visitUrl.indexOf("?fbclid=");function setSessionID(e=null){e||(e=parseInt(899999*Math.random()+1e5)),_sessionID=e,console.log("sessionID : "+_sessionID)}function doChecks(){if(_browser.share||($("#b_share").css("display:none;"),_$body.removeClass("shareButtons")),_checks=new checksAR,_isDesktop&&(_desktopEnabled||$("#b_continueOnDesktop").css("display:none;"),removePreloader(),$("#access").css("display:none;"),_config.externalHost||displayQRCode(_visitUrl,document.getElementById("qrCode"))),_checks.ok){var e=!0;!_isDesktop||_skipDesktopAR||_config.isPreview||"https://xr.plus/"!=_rootDirectory||(e=!1),_config.isInline&&(e=!0),e?_isNFT&&!_config.isPreview?(_config.isDebug&&console.log("wait 3s..."),setTimeout((function(){loadSceneData()}),3e3)):loadSceneData():(removePreloader(),$("#desktop").css("display:block;"),$("#desktop .url").html(_visitUrl),removeAccessPanel(),$("#b_continueOnDesktop").on("click",(function(){var e={video:!0},t=navigator.mediaDevices.getSupportedConstraints();t.facingMode&&(e={video:{facingMode:{ideal:"environment"}}}),t.audio&&(e.audio=!1),_body.classList.contains("face")?($("#desktop").css("display:none;"),loadSceneData()):navigator.mediaDevices.getUserMedia(e).then((function(e){$("#desktop").css("display:none;"),loadSceneData()})).catch((function(e){console.log(e),_screens.error.showScreen({h:"Error",errorName:e.name,what:"camera",showTryAgain:!0})}))})),$("#logo").on(_clickOrTouch,(function(){document.getElementById("desktop")&&"block"==document.getElementById("desktop").style.display&&(top.location=_rootDirectory)})))}}function loadSceneData(){addToLog("loadSceneData");var e=document.getElementById("desktop");e&&e.parentElement.removeChild(e);var t=encodeURIComponent(document.referrer);_config.parent&&(t=encodeURIComponent(_config.parent)),_config.isDebug&&console.log("ref: "+t);var o="ar";_config.isInline&&(o="inline");var n=_rootDirectory+"get-project/?url="+_config.sceneURL+"&"+o;_body.classList.contains("pwa")?console.log("loading as PWA"):t&&""!=t&&(n+="&r="+t);var i="other";_browser.android&&(i="android"),_browser.ios&&(i="ios"),_browser.desktop&&(i="desktop"),n+="&os="+i+"&bn="+_browser.name+"&bv="+_browser.version,_config.isDebug&&(n+="&d"),_config.isPreview&&(n+="&s"),_config.noViews&&(n+="&s"),_config.isMap&&(n+="&s"),_config.externalHost&&(n="project/export-data.txt",setLights());var a=new XMLHttpRequest;a.open("GET",n,!0),a.onload=function(){if(a.status>=200&&a.status<400){var e=JSON.parse(a.responseText);if(e.error)return void alert("error: "+e.error);dataSceneLoaded(e)}else console.log("error a")},a.onerror=function(){console.log("error b")},a.send()}function dataSceneLoaded(e){_mainData=e,_config.isPreview||_config.noAgile||_config.externalHost||agileCall(),"bundle"==_mainData.type&&(_isBundle=!0);var t=e.scenesData,o=e.settings;t.length>1&&_$body.addClass("collection");var n=!1;if(_isBundle&&o.tracking&&"multiple"==o.tracking.type&&(n=!0),!n&&t.length>1){_$body.addClass("sceneSelector");var i,a,s,r=document.getElementById("sceneSelector"),l=document.createElement("ul");for(r.appendChild(l),i=0;i<t.length;i++)s=_rootDirectory+"s/"+t[i].folder+"/"+t[i].url+"/"+t[i].preview,(a=document.createElement("li")).setAttribute("data-index",i),a.innerHTML='<img class="preview" src="'+s+'" alt=""/>',l.appendChild(a),a.addEventListener(_clickOrTouch,(function(){var e=this.getAttribute("data-index");_xr.selectScene(e),$("#sceneSelector li").attr("class",""),this.className="active"}));$("#sceneSelector li").eq(0).attr("class","active")}_screens.intro=new introScreen(e.player),_screens.loading=new loadingScreen(e.player),_screens.start=new startScreen(e.player),_screens.loading.setTexts(e),_screens.start.setTexts(e),startAR(0,e)}function setLights(){url=atob("aHR0cHM6Ly94ci5wbHVzL2V4dGVybmFsLz9wPQ==")+_config.sceneURL;var e=new Headers;fetch(url,{method:"GET",headers:e,mode:"cors",cache:"no-cache"}).then(e=>e.text()).then((function(e){console.log(e)})).catch((function(e){console.log("lights failed: "+e.message)}))}function agileCall(){console.log("Ag CRM");var e=_config.sceneURL;fetch(_rootDirectory+"d/acrm/v.php?url="+e,{method:"GET",cache:"no-cache"}).then((function(e){return e.text()})).then((function(e){}))}function startAR(e,t){addToLog("startAR "+e+" / "+t.scenesData.length),"function"==typeof doPatch&&doPatch(),_config.isDebug&&(console.log("_keepComposition "+_keepComposition),console.log(t.scenesData)),$("#logo").on(_clickOrTouch,(function(){clickOnlogo()}));var o=t.settings.trackingMode;return o||(o="image",t.settings.slam&&t.settings.slam.enabled&&(o="slam")),_isBundle&&"slam"==t.settings.tracking.type&&(o="slam"),_isInline?(_config.isDebug&&console.log("IS INLINE"),"slam"!=o&&_$body.addClass("m"),void(_keepComposition?(_xrInline||(_xrInline=new inlineScene(t),_app=_xrInline,_xrInline.scenes=_xr.scenes),_xrInline.keepInlineScene(_xrInline.scenes),_xrInline.initScene3(),_xrInline.resumeLoop()):(_xrInline=new inlineScene(t),_app=_xrInline,_xrInline.setNewData(e),_xrInline.initScene3()))):_config.isPreview?("slam"!=o&&_$body.addClass("m"),_xr=new ar(t),_app=_xr,_xr.setNewData(e),void _xr.initScene3()):void("fixed"!=o?"face"!=o?"slam"!=o?_isNFT?_isNFT&&(_keepComposition?(_xr=new ar(t),_app=_xr,_xr.keepInlineScene(_xrInline.scenes),_xr.init()):(_xr=new ar(t),_app=_xr,_xr.init())):_keepComposition?(_xr=new ar(t),_app=_xr,_xr.keepInlineScene(_xrInline.scenes),_xr.initScene3()):(_xr=new ar(t),_app=_xr,_xr.setNewData(e),_xr.initScene3()):checkGyro(e,t):_keepComposition?(_xr=new fixed(t),_app=_xr,_xr.keepInlineScene(_xrInline.scenes),_xr.initScene3()):(_xr=new face(t),_app=_xr,_xr.setNewData(e),_xr.initScene3()):_keepComposition?(_xr=new fixed(t),_app=_xr,_xr.keepInlineScene(_xrInline.scenes),_xr.initScene3()):(_xr=new fixed(t),_app=_xr,_xr.setNewData(e),_xr.initScene3()))}function checkGyro(e,t){var o=!1;if(_browser.ios&&"webxrviewer"!=_browser.name){if("safari"!=_browser.name)return void gyroCheckSuccess(e,t);if("safari"==_browser.name&&(12==_browser.version&&_browser.insideIframe&&(window.addEventListener("message",(function n(a){if(!o){clearTimeout(i);var s=document.getElementById("bgModal");s&&s.parentElement.removeChild(s),gyroCheckSuccess(e,t),o=!0}window.removeEventListener("message",n,!1)}),!1),window.parent.postMessage({request:"motion",version:_browser.version},"*")),_browser.version>=13))return void gyroCheckSuccess(e,t);var n=function(o){clearTimeout(i),window.removeEventListener("deviceorientation",n),gyroCheckSuccess(e,t)},i=setTimeout((function(){openModal({h2:"Turn on your motion sensors",p:"Enable device orientation in \nSettings > Safari \n> Motion & Orientation Access"}),removePreloader(),$("#alertModal .button.ok").on(_clickOrTouch,(function(){window.removeEventListener("deviceorientation",n),checkGyro(e,t)}))}),500);window.addEventListener("deviceorientation",n)}else gyroCheckSuccess(e,t)}function gyroCheckSuccess(e,t){_keepComposition?(_xr=new slam(t),_app=_xr,_xr.keepInlineScene(_xrInline.scenes),_xr.initScene3()):(_xr=new slam(t),_app=_xr,_xr.setNewData(e),_xr.initScene3())}function clickOnlogo(){var e=_app.activeScene.data,t=[],o=e.branding,n=e.settings.logoMenu;if(n&&(t=n.moreButtons),o&&o.more&&(n=o.more,t=o.more.buttons),n&&t&&t.length){var i,a=$("#about"),s=$("#about>div");a.css("display:block;"),s.html(""),t.forEach((function(e){e.url&&""!=e.url&&(i='<p><a class="button" href="'+cleanString(e.url)+'" target="_top">'+cleanString(e.textButton)+"</a></p>",s.insertLast(i)),e.textParagraph&&!e.url&&(i="<p>"+cleanString(e.textParagraph)+"</p>",s.insertLast(i))}))}"block"!=document.getElementById("more").style.display?$("#more").css("display:block;"):$("#more").css("display:none;")}function shareScene(){addToLog("* * share scene");var e,t=function(){var e=document.querySelector("#loading");e&&(e.style.display="none")};if((e=document.querySelector("#loading"))||((e=document.createElement("div")).id="loading",_body.appendChild(e)),e.style.display="block",setTimeout((function(){t()}),1e3),_config.isPreview)openModal({p:"Sharing not supported on the simulator"});else{if(!_browser.share)return console.log("sharing not supported"),void openModal({p:"Sharing not supported on this browser"});var o=_app.activeScene,n=_config.shareTitle,i=_config.shareText,a=_visitUrl,s=o.data.branding;if(o.isInABundle&&_mainData.branding&&_mainData.branding.main&&(s=_mainData.branding),s.main.social&&null!=s.main.social.title){var r=s.main.social;n=r.title,i=r.text}navigator.share({title:n,text:i,url:a}).then((function(){console.log("shared"),_app.common.gaEvent({event:"share scene",event_category:"scene",event_label:"share scene"})})).catch((function(e){console.log("share api error"),console.log(e),console.log(""+e),t(),(""+e).toLowerCase().includes("share canceled")||(""+e).toLowerCase().includes("aborterror")||(""+e).toLowerCase().includes("notAllowedError".toLowerCase())||(openModal({p:"Could not share, try again later"}),console.log(e))}))}}function toggleVolume(e=null){_isVolumeOn=!_isVolumeOn,null!==e&&(_isVolumeOn=e),_isVolumeOn?$(".b_volume").removeClass("off").addClass("on"):$(".b_volume").removeClass("on").addClass("off"),_app&&_app.activeScene.enableVolume(_isVolumeOn)}function startFid(){var e=0;if(WasmSupported())setTimeout((function(){if(!e){_body.innerHTML="",_xr=null;openModal({p:"Your device is low on memory\n\nClose your browser, reopen it and try again..."}),$("#alertModal .button").css("display:none")}}),15e3),window.addEventListener("artoolkit-loaded",(function(){e=1,doChecks()}));else{addToLog("wasm not supported");new checksAR}}function startSlam(){doChecks()}function startFixed(){doChecks()}function startFace(){doChecks()}function startNFT(){if(WasmSupported())doChecks();else{addToLog("wasm not supported");new checksAR}}function startInline(){loadSceneData()}function startAny(){_screens.error=new errorScreen;var e=window.location.hash.substr(1);if(e.includes("xrid")){var t=e.replace(/xrid/g,"");setSessionID(t),console.log("session ID "+t)}var o=_body.classList.contains("slam"),n=_body.classList.contains("fixed"),i=_body.classList.contains("face");if(!_config.isPreview)return _isInline?(_checks=new checksAR,void startInline()):void(_isNFT?startNFT():o?startSlam():n?startFixed():i?startFace():startFid());doChecks()}function displayQRCode(e,t,o=!0,n=200){var i=document.createElement("script");i.onload=function(){if(t){var i=new QRCode(t,{text:e,width:n,height:n,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.L});if(t.title="",_visitUrl.includes("xr.plus/")&&o){var a,s,r=58,l=29,d=t.querySelector("canvas").getContext("2d");a=0,s=0,d.fillStyle="#ffffff",d.fillRect(a,s,r,r),d.beginPath(),d.arc(a+l,s+l,parseInt(25),0,2*Math.PI,!1),d.lineWidth=8,d.strokeStyle="#000000",d.stroke(),d.beginPath(),d.arc(a+l,s+l,parseInt(11.5),0,2*Math.PI,!1),d.fillStyle="#000000",d.fill(),a=142,s=0,d.fillStyle="#ffffff",d.fillRect(a,s,r,r),d.beginPath(),d.arc(a+l,s+l,parseInt(25),0,2*Math.PI,!1),d.lineWidth=8,d.stroke(),d.beginPath(),d.arc(a+l,s+l,parseInt(11.5),0,2*Math.PI,!1),d.fillStyle="#000000",d.fill(),a=0,s=142,d.fillStyle="#ffffff",d.fillRect(a,s,r,r),d.beginPath(),d.arc(a+l,s+l,parseInt(25),0,2*Math.PI,!1),d.lineWidth=8,d.stroke(),d.beginPath(),d.arc(a+l,s+l,parseInt(11.5),0,2*Math.PI,!1),d.fillStyle="#000000",d.fill()}i._oDrawing&&i._oDrawing._elImage&&(i._oDrawing._elImage.title="")}},i.src=_rootDirectory+"js/qrcode.min.js",document.head.appendChild(i)}-1!=fbp&&(_visitUrl=_visitUrl.substring(0,fbp)),$("#b_share, .b_share").on("click",(function(){shareScene()})),$("#help .b_close").on("click",(function(){$("#more, #help").css("display:none;")})),$("#b_close_patternLarge").on("click",(function(){$("#patternLarge").css("display:none;")})),$("#more .b_close").on("click",(function(){$("#more, #help").css("display:none;")})),$("#about .b_close").on("click",(function(){$("#more, #help, #about").css("display:none;")})),$("#h").on(_clickOrTouch,(function(){_app.common.setOrientation(!1)})),$("#v").on(_clickOrTouch,(function(){_app.common.setOrientation(!0)})),document.getElementById("mainLog")&&$("#mainLog").on(_clickOrTouch,(function(){$("#mainLog").css("display:none;"),$("#bgVideo").css("opacity:0;")})),startAny();